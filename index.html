<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống dữ liệu trung chuyển</title>
    <link rel="icon" type="image/svg+xml" href="https://quangminhpro.com/wp-content/uploads/2025/08/logo-3.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./public/style.css">
    <script src="./public/script.js" defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 5px;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            background-color: white;
            border-radius: 10px;
            box-shadow: none;
            overflow: hidden;
            height: 100vh;
            display: flex;
            min-height: 46px;
            flex-direction: column;
        }

        .header-modern {
            background: linear-gradient(90deg, #1e3d6f, #2c5aa0);
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px;
            flex-shrink: 0;
        }

        /* Brand */
        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .brand-logo {
            height: 46px;
            width: auto;
            background: white;
            padding: 6px;
            border-radius: 10px;
        }

        .brand-text h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: white;
        }

        .brand-text p {
            font-size: 13px;
            margin: 0;
            opacity: 0.85;
            color: #dce7ff;
        }

        /* Status pills */
        .header-status {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            backdrop-filter: blur(6px);
        }

        .status-pill.light {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Dot indicator */
        .status-pill .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ffcc00;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background-color: #f1f5f9;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }

        .tab-button {
            padding: 14px 24px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background-color: #e9ecef;
            color: #2c5aa0;
        }

        .tab-button.active {
            color: #2c5aa0;
            border-bottom: 3px solid #2c5aa0;
            background-color: white;
        }

        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-modern {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            .header-status {
                flex-direction: column;
                width: 100%;
            }

            .status-pill {
                justify-content: center;
                width: 100%;
            }

            .tab-navigation {
                flex-direction: column;
            }

            .tab-button {
                width: 100%;
                text-align: center;
            }
        }

        .filter-section {
            padding: 5px;
            border-bottom: 1px solid #eaeaea;
            flex-shrink: 0;
        }

        .filter-title {
            font-size: 20px;
            font-weight: 600;
            margin-top: 10px;
            margin-bottom: 20px;
            color: #2c5aa0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-title i {
            font-size: 22px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .filter-group {
            margin-bottom: 10px;
        }

        .filter-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 15px;
        }

        .filter-label span {
            font-weight: 600;
            color: #0c9c07;
            margin-left: 8px;
            font-size: 14px;
        }

        .filter-input,
        .filter-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s;
        }

        .filter-input:focus,
        .filter-select:focus {
            border-color: #2c5aa0;
            outline: none;
        }

        /* Multi-select styles */
        .multi-select-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            max-height: 46px;
            /* Chiều cao thu gọn */
            overflow-y: hidden;
            /* Ẩn thanh cuộn khi thu gọn */
            background-color: white;
            transition: max-height 0.3s ease, border-color 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .multi-select-container:hover {
            max-height: 300px;
            /* Tăng từ 200px lên 300px */
            overflow-y: auto;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }

        /* Thêm indicator mũi tên */
        .multi-select-container::after {
            content: '\f0d7';
            /* FontAwesome caret-down */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            transition: transform 0.3s ease;
            pointer-events: none;
        }

        .multi-select-option {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .multi-select-container:hover .multi-select-option {
            opacity: 1;
        }

        .multi-select-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .multi-select-option:last-child {
            margin-bottom: 0;
        }

        .multi-select-option input[type="checkbox"] {
            margin: 0;
            width: 16px;
            height: 16px;
        }

        .multi-select-option label {
            cursor: pointer;
            margin: 0;
            font-weight: normal;
            font-size: 14px;
            user-select: none;
        }

        /* Thanh tìm kiếm trong multi-select */
        .multi-select-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
            box-sizing: border-box;
            display: none;
            /* Ẩn mặc định, chỉ hiện khi mở rộng */
        }

        .multi-select-search:focus {
            border-color: #2c5aa0;
            outline: none;
        }

        /* Hiển thị thanh tìm kiếm khi container mở rộng */
        .multi-select-container:hover .multi-select-search {
            display: block;
        }

        /* Tăng chiều cao khi mở rộng để chứa thanh tìm kiếm */
        .multi-select-container:hover {
            max-height: 300px;
        }

        /* Class để container luôn mở rộng (khi focus vào ô tìm kiếm) */
        .multi-select-container.expanded {
            max-height: 300px !important;
            overflow-y: auto !important;
            border-color: #2c5aa0 !important;
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1) !important;
        }

        .multi-select-container.expanded .multi-select-search {
            display: block;
        }

        /* Ẩn option khi lọc */
        .multi-select-option.filtered-out {
            display: none !important;
        }

        .select-all-option {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .radio-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input {
            margin: 0px;
        }

        .date-group {
            display: flex;
            gap: 15px;
        }

        .date-input {
            flex: 1;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            padding-top: 10px;
            padding-bottom: 5px;
            border-top: 1px solid #eaeaea;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #2c5aa0;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1e3d6f;
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #ddd;
        }

        .results-section {
            padding: 10px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0px;
            flex-shrink: 0;
        }

        .results-count {
            font-size: 18px;
            font-weight: 600;
            color: #2c5aa0;
        }

        .export-btn {
            background-color: #0c9c07;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            background-color: #087a04;
        }

        .selected-count {
            color: #0c9c07;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            font-size: 13px;
        }

        .results-table th {
            background-color: #f1f5f9;
            color: #2c5aa0;
            font-weight: 600;
            text-align: left;
            padding: 10px;
            border-bottom: 2px solid #ddd;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 100;
            background: #f1f5f9;
        }

        .results-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        .results-table tr:hover {
            background-color: #f9fafc;
        }

        .table-container-wrapper {
            flex: 1;
            overflow: auto;
            border: 1px solid #eaeaea;
            border-radius: 6px;
            margin-top: 10px;
            position: relative;
        }

        .table-container {
            overflow: visible;
            height: 100%;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            z-index: 100;
            width: 100%;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2c5aa0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background-color: #ffeaea;
            color: #c00;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border-left: 4px solid #c00;
        }

        .success {
            background-color: #e8f7e8;
            color: #0c9c07;
            padding: 10px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #0c9c07;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-standard {
            background-color: #e8f4ff;
            color: #2c5aa0;
        }

        .status-other {
            background-color: #fff4e6;
            color: #e67e22;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #777;
            font-size: 16px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
        }

        .no-results i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ccc;
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }

            .date-group {
                flex-direction: column;
            }

            .results-table {
                font-size: 12px;
            }

            .results-table th,
            .results-table td {
                padding: 6px 8px;
            }

            .header-modern {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<script>
    // Cấu hình API Google Sheets (chung cho cả ba tab)
    const SPREADSHEET_ID = '14R9efcJ2hGE3mCgmJqi6TNbqkm4GFe91LEAuCyCa4O0';
    const SPREADSHEET_ID_DANH_SACH_NGUOI_DUNG = '1GSakZ33O0JLrD2Mewl-EAHPBviokl8cLtI5pF1VIT6g';
    const SPREADSHEET_ID_DANH_SACH_KHACH_HANG = '1sG87qCUvIZtuJbAv1vS2VRDmHG0ADwFBZQcNR-AzV9Q';
    const SPREADSHEET_ID_GIAO_HANG = '1upjqkhTozefUFiugBeHh0sX9MgNhOtt-QJIh7By2rmY';
    const SPREADSHEET_ID_XUAT_CHUYEN_KHO = '1kb0cieDcUElLmMaEcsNPptIXJs0ZNAu_aaCcmU0aDAU';
    const API_KEY = 'AIzaSyA9g2qFUolpsu3_HVHOebdZb0NXnQgXlFM';

    // Phạm vi dữ liệu
    const RANGE_DON_HANG = 'don_hang!A:CS';
    const RANGE_DON_HANG_CHI_TIET = 'don_hang_chi_tiet!A:GF';
    const RANGE_DANH_SACH_NGUOI_DUNG = 'danh_sach_nguoi_dung!A:AH';
    const RANGE_DANH_SACH_KHACH_HANG = 'danh_sach_khach_hang!A:AC';
    const RANGE_GIAO_HANG = 'giao_hang!A:AF';
    const RANGE_XUAT_CHUYEN_KHO = 'xuat_chuyen_kho!A:S';
    const RANGE_XUAT_CHUYEN_KHO_CHI_TIET = 'xuat_chuyen_kho_chi_tiet!A:Q';

    // Biến lưu trữ dữ liệu (chung cho cả ba tab)
    let donHangData = [];
    let donHangChiTietData = [];
    let danhSachNguoiDungData = [];
    let danhSachKhachHangData = [];
    let giaoHangData = [];
    let xuatChuyenKhoData = [];
    let xuatChuyenKhoChiTietData = [];
    let filteredResultsXuatYeuCau = [];

    // Lookup tables (chung)
    let lookupNguoiDungByMaNV = {};
    let lookupNguoiDungByTenNV = {};
    let lookupKhachHangById = {};
    let lookupGiaoHangByMaBoHang = {};
    let lookupPhieuByMaPhieu = {}; // Map từ mã phiếu sang thông tin phiếu

    // Biến kiểm tra đã tải dữ liệu chưa
    let isDataLoaded = false;

    // Khởi tạo ứng dụng
    document.addEventListener('DOMContentLoaded', function () {
        initTabNavigation();
        loadGapiAndInitialize();
    });

    // Khởi tạo tab navigation
    function initTabNavigation() {
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.addEventListener('click', function () {
                const tabId = this.getAttribute('data-tab');

                // Cập nhật active class cho buttons
                tabButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                // Hiển thị tab tương ứng
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
    }

    // ==================== HÀM CHUNG ====================

    // Tải Google API Client
    function loadGapiAndInitialize() {
        updateConnectionStatus('Đang kết nối...', '#fff4e6', '#e67e22');

        gapi.load('client', async () => {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                });

                updateConnectionStatus('Đã kết nối', '#e8f7e8', '#0c9c07');
                console.log('Google Sheets API đã sẵn sàng');

                // Tự động tải dữ liệu ban đầu
                await initialLoadData();

            } catch (error) {
                updateConnectionStatus('Lỗi kết nối', '#ffeaea', '#c00');
                console.error('Lỗi khởi tạo Google API:', error);
            }
        });
    }

    // Tải dữ liệu ban đầu
    async function initialLoadData() {
        try {
            updateConnectionStatus('Đang tải dữ liệu ban đầu...', '#fff4e6', '#e67e22');
            await fetchDataFromSheets();
            updateConnectionStatus('Đã tải dữ liệu', '#e8f7e8', '#0c9c07');
            isDataLoaded = true;

            // Khởi tạo event listeners cho cả 6 tab
            initKhachHangEventListeners();
            initNhapKhoEventListeners();
            initXuatKhoEventListeners();
            initLenSanXuatEventListeners();
            initXuatBaoHanhEventListeners();
            initXuatYeuCauEventListeners();

        } catch (error) {
            console.error('Lỗi khi tải dữ liệu ban đầu:', error);
            updateConnectionStatus('Lỗi tải dữ liệu', '#ffeaea', '#c00');
        }
    }

    // Lấy dữ liệu từ Google Sheets
    async function fetchDataFromSheets() {
        updateConnectionStatus('Đang tải dữ liệu...', '#fff4e6', '#e67e22');

        try {
            const promises = [
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGE_DON_HANG,
                }),
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGE_DON_HANG_CHI_TIET,
                }),
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID_DANH_SACH_NGUOI_DUNG,
                    range: RANGE_DANH_SACH_NGUOI_DUNG,
                }),
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID_DANH_SACH_KHACH_HANG,
                    range: RANGE_DANH_SACH_KHACH_HANG,
                }),
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID_GIAO_HANG,
                    range: RANGE_GIAO_HANG,
                }),
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID_XUAT_CHUYEN_KHO,
                    range: RANGE_XUAT_CHUYEN_KHO,
                }),
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID_XUAT_CHUYEN_KHO,
                    range: RANGE_XUAT_CHUYEN_KHO_CHI_TIET,
                })
            ];

            const results = await Promise.all(promises);

            // Lưu trữ dữ liệu
            donHangData = results[0].result.values || [];
            donHangChiTietData = results[1].result.values || [];
            danhSachNguoiDungData = results[2].result.values || [];
            danhSachKhachHangData = results[3].result.values || [];
            giaoHangData = results[4].result.values || [];
            xuatChuyenKhoData = results[5].result.values || [];
            xuatChuyenKhoChiTietData = results[6].result.values || [];

            // Xây dựng lookup tables
            buildLookupTables();

            // Cập nhật options cho select đơn vị phụ trách
            updateDonViPhuTrachOptions('nhap');
            updateDonViPhuTrachOptions('xuat');
            updateDonViPhuTrachOptions('lsx');
            updateDonViPhuTrachOptions('xbh');
            updateDonViPhuTrachOptions('kh');

            // Cập nhật options cho select mã hợp đồng
            updateMaHopDongOptions('nhap');
            updateMaHopDongOptions('xuat');
            updateMaHopDongOptions('lsx');
            updateMaHopDongOptions('xbh');


            // Cập nhật options cho select xưởng sản xuất
            updateXuongSanXuatOptions();

            // Cập nhật options cho tab xuất yêu cầu
            updateMaPhieuOptions();
            updateXuongSanXuatOptionsForXuatYeuCau();
            updateLoaiPhieuOptionsForXuatYeuCau();

            updateConnectionStatus('Đã tải dữ liệu', '#e8f7e8', '#0c9c07');
            isDataLoaded = true;

        } catch (error) {
            console.error('Lỗi khi tải dữ liệu từ Google Sheets:', error);
            updateConnectionStatus('Lỗi tải dữ liệu', '#ffeaea', '#c00');
            throw error;
        }
    }

    // Xây dựng lookup tables
    function buildLookupTables() {
        // Xây dựng lookup từ danh_sach_nguoi_dung
        if (danhSachNguoiDungData.length > 0) {
            const headers = danhSachNguoiDungData[0];
            const maNVIndex = headers.indexOf('ma_nhan_vien');
            const tenNVIndex = headers.indexOf('ten_nhan_vien');
            const donViIndex = headers.indexOf('don_vi');
            const mnvCongTyIndex = headers.indexOf('mnv_cong_ty');

            for (let i = 1; i < danhSachNguoiDungData.length; i++) {
                const row = danhSachNguoiDungData[i];
                const maNV = maNVIndex >= 0 ? row[maNVIndex] : '';
                const tenNV = tenNVIndex >= 0 ? row[tenNVIndex] : '';
                const donVi = donViIndex >= 0 ? row[donViIndex] : '';
                const mnvCongTy = mnvCongTyIndex >= 0 ? row[mnvCongTyIndex] : '';

                if (maNV) {
                    lookupNguoiDungByMaNV[maNV] = { donVi, mnvCongTy, tenNV };
                }
                if (tenNV) {
                    lookupNguoiDungByTenNV[tenNV] = { mnvCongTy };
                }
            }
        }

        // Xây dựng lookup từ danh_sach_khach_hang
        if (danhSachKhachHangData.length > 0) {
            const headers = danhSachKhachHangData[0];
            const idIndex = headers.indexOf('id');
            const maKhachHangIndex = headers.indexOf('ma_khach_hang');

            for (let i = 1; i < danhSachKhachHangData.length; i++) {
                const row = danhSachKhachHangData[i];
                const id = idIndex >= 0 ? row[idIndex] : '';
                const maKhachHang = maKhachHangIndex >= 0 ? row[maKhachHangIndex] : '';

                if (id) {
                    lookupKhachHangById[id] = maKhachHang;
                }
            }
        }

        // Xây dựng lookup từ giao_hang
        if (giaoHangData.length > 0) {
            const headers = giaoHangData[0];
            const maBoHangIndex = headers.indexOf('ma_bo_hang');
            const loaiViecIndex = headers.indexOf('loai_viec');
            const nguoiGiaoHangIndex = headers.indexOf('nguoi_giao_hang');

            for (let i = 1; i < giaoHangData.length; i++) {
                const row = giaoHangData[i];
                const maBoHang = maBoHangIndex >= 0 ? row[maBoHangIndex] : '';
                const loaiViec = loaiViecIndex >= 0 ? row[loaiViecIndex] : '';
                const nguoiGiaoHang = nguoiGiaoHangIndex >= 0 ? row[nguoiGiaoHangIndex] : '';

                if (maBoHang) {
                    lookupGiaoHangByMaBoHang[maBoHang] = { loaiViec, nguoiGiaoHang };
                }
            }
        }

        // Xây dựng lookup từ xuat_chuyen_kho
        if (xuatChuyenKhoData.length > 0) {
            const headers = xuatChuyenKhoData[0];
            const maPhieuXuatIndex = headers.indexOf('ma_phieu_xuat');
            const loaiPhieuIndex = headers.indexOf('loai_phieu');
            const xuongSxIndex = headers.indexOf('xuong_sx');
            const ngayXuatIndex = headers.indexOf('ngay_xuat');

            for (let i = 1; i < xuatChuyenKhoData.length; i++) {
                const row = xuatChuyenKhoData[i];
                const maPhieuXuat = maPhieuXuatIndex >= 0 ? row[maPhieuXuatIndex] : '';
                const loaiPhieu = loaiPhieuIndex >= 0 ? row[loaiPhieuIndex] : '';
                const xuongSx = xuongSxIndex >= 0 ? row[xuongSxIndex] : '';
                const ngayXuat = ngayXuatIndex >= 0 ? row[ngayXuatIndex] : '';

                if (maPhieuXuat) {
                    lookupPhieuByMaPhieu[maPhieuXuat] = { loaiPhieu, xuongSx, ngayXuat };
                }
            }
        }
    }

    // Cập nhật options cho select đơn vị phụ trách (dạng multi-select)
    function updateDonViPhuTrachOptions(type) {
        if (donHangData.length === 0) return;

        const donHangHeaders = donHangData[0];
        const donViPhuTrachIndex = donHangHeaders.indexOf('don_vi_phu_trach');
        if (donViPhuTrachIndex === -1) return;

        // Lấy danh sách đơn vị phụ trách duy nhất
        const donViValues = new Set();
        for (let i = 1; i < donHangData.length; i++) {
            const value = donHangData[i][donViPhuTrachIndex];
            if (value && value.trim() !== '') {
                donViValues.add(value.trim());
            }
        }

        const sortedValues = Array.from(donViValues).sort();

        // Map đúng suffix theo từng tab
        let suffix = "";
        if (type === "nhap") suffix = "-nhap";
        else if (type === "xuat") suffix = "-xuat";
        else if (type === "lsx") suffix = "-lsx";
        else if (type === "kh") suffix = "-kh";
        else if (type === "xbh") suffix = "-xbh";
        else return;

        // Container element tương ứng tab
        const containerElement = document.getElementById(`don-vi-phu-trach${suffix}-container`);
        if (!containerElement) return;

        // Xóa nội dung cũ
        containerElement.innerHTML = '';

        // Tạo input tìm kiếm
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'multi-select-search';
        searchInput.placeholder = 'Tìm kiếm đơn vị...';
        searchInput.id = `don-vi-search${suffix}`;

        containerElement.appendChild(searchInput);

        // Tạo checkbox "Tất cả đơn vị" (mặc định được chọn)
        const allOptionDiv = document.createElement('div');
        allOptionDiv.className = 'multi-select-option select-all-option';

        const allCheckbox = document.createElement('input');
        allCheckbox.type = 'checkbox';
        allCheckbox.id = `don-vi-phu-trach${suffix}-all`;
        allCheckbox.checked = true;

        const allLabel = document.createElement('label');
        allLabel.htmlFor = `don-vi-phu-trach${suffix}-all`;
        allLabel.textContent = 'Tất cả đơn vị';

        allOptionDiv.appendChild(allCheckbox);
        allOptionDiv.appendChild(allLabel);
        containerElement.appendChild(allOptionDiv);

        // Thêm sự kiện cho checkbox "Tất cả đơn vị"
        allCheckbox.addEventListener('change', function () {
            const checkboxes = containerElement.querySelectorAll('input[type="checkbox"]:not(#don-vi-phu-trach' + suffix + '-all)');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;

                // ✅ Update label
                updateDonViPhuTrachLabel(suffix);
            });

            // Kích hoạt sự kiện change cho filter nếu cần
            if (suffix === '-kh') requireRefilterKhachHang();
            else if (suffix === '-nhap') requireRefilterNhap();
            else if (suffix === '-xuat') requireRefilterXuat();
            else if (suffix === '-lsx') requireRefilterLenSanXuat();
            else if (suffix === '-xbh') requireRefilterXuatBaoHanh();
        });

        // Add options mới
        sortedValues.forEach(value => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'multi-select-option';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `don-vi-phu-trach${suffix}-${value.replace(/\s+/g, '-')}`;
            checkbox.value = value;

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = value;

            optionDiv.appendChild(checkbox);
            optionDiv.appendChild(label);
            containerElement.appendChild(optionDiv);

            // Thêm sự kiện cho từng checkbox
            checkbox.addEventListener('change', function () {
                const allCheckbox = document.getElementById(`don-vi-phu-trach${suffix}-all`);
                const checkboxes = containerElement.querySelectorAll('input[type="checkbox"]:not(#don-vi-phu-trach' + suffix + '-all)');
                const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

                // Nếu tất cả các checkbox đều được chọn, chọn "Tất cả đơn vị"
                if (checkedCount === checkboxes.length) {
                    allCheckbox.checked = true;
                }
                // Nếu không có checkbox nào được chọn, chọn "Tất cả đơn vị"
                else if (checkedCount === 0) {
                    allCheckbox.checked = true;
                }
                // Nếu có một số checkbox được chọn, bỏ chọn "Tất cả đơn vị"
                else {
                    allCheckbox.checked = false;
                }

                // ✅ Cập nhật label số lượng đã chọn
                updateDonViPhuTrachLabel(suffix);

                // Kích hoạt sự kiện change cho filter nếu cần
                if (suffix === '-kh') requireRefilterKhachHang();
                else if (suffix === '-nhap') requireRefilterNhap();
                else if (suffix === '-xuat') requireRefilterXuat();
                else if (suffix === '-lsx') requireRefilterLenSanXuat();
                else if (suffix === '-xbh') requireRefilterXuatBaoHanh();
            });
        });

        // Thêm sự kiện tìm kiếm
        searchInput.addEventListener("input", function () {
            const keyword = searchInput.value.trim().toLowerCase();

            // Lấy tất cả option
            const options = Array.from(
                containerElement.querySelectorAll(".multi-select-option")
            );

            // Nếu không có text → đưa các lựa chọn đã chọn lên đầu
            if (keyword === "") {

                // Reset ẩn option
                options.forEach(opt => opt.classList.remove("filtered-out"));

                // Sort: selected lên trước
                options.sort((a, b) => {
                    const aChecked = a.querySelector("input").checked;
                    const bChecked = b.querySelector("input").checked;

                    return bChecked - aChecked;
                });

                // Render lại đúng thứ tự
                options.forEach(opt => containerElement.appendChild(opt));

                return;
            }

            // Nếu có text → chia làm 2 nhóm:
            // (1) match keyword
            // (2) selected nhưng không match keyword

            let matched = [];
            let selectedNotMatched = [];
            let others = [];

            options.forEach(opt => {
                const labelText = opt.textContent.toLowerCase();
                const checked = opt.querySelector("input").checked;

                if (labelText.includes(keyword)) {
                    matched.push(opt);
                }
                else if (checked) {
                    selectedNotMatched.push(opt);
                }
                else {
                    others.push(opt);
                }
            });

            // Ẩn tất cả trước
            options.forEach(opt => opt.classList.add("filtered-out"));

            // Hiện nhóm match
            matched.forEach(opt => {
                opt.classList.remove("filtered-out");
                containerElement.appendChild(opt);
            });

            // Hiện nhóm selected nhưng không match (ngay dưới match)
            selectedNotMatched.forEach(opt => {
                opt.classList.remove("filtered-out");
                containerElement.appendChild(opt);
            });

            // Nhóm còn lại vẫn ẩn
        });


        // Giữ container mở rộng khi focus vào ô tìm kiếm
        searchInput.addEventListener('focus', function () {
            containerElement.classList.add('expanded');
        });

        let hideTimeout;

        containerElement.addEventListener("mouseleave", function () {
            hideTimeout = setTimeout(() => {
                containerElement.classList.remove("expanded");
            }, 100);
        });

        containerElement.addEventListener("mouseenter", function () {
            clearTimeout(hideTimeout);
        });


        document.addEventListener("click", function (e) {
            if (!containerElement.contains(e.target)) {
                containerElement.classList.remove("expanded");
            }
        });


        searchInput.addEventListener('blur', function () {
            setTimeout(() => {
                if (!containerElement.matches(':hover')) {
                    containerElement.classList.remove('expanded');
                }
            }, 200);
        });

        updateDonViPhuTrachLabel(suffix);
    }

    // Hàm lấy danh sách đơn vị phụ trách được chọn từ multi-select
    function getSelectedDonViPhuTrach(suffix) {
        const container = document.getElementById(`don-vi-phu-trach${suffix}-container`);
        if (!container) return [];

        const allCheckbox = document.getElementById(`don-vi-phu-trach${suffix}-all`);
        if (allCheckbox && allCheckbox.checked) {
            return []; // Trả về mảng rỗng nếu chọn "Tất cả đơn vị"
        }

        const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked:not(#don-vi-phu-trach' + suffix + '-all)');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    function updateDonViPhuTrachLabel(suffix) {

        // span hiển thị số lượng đã chọn
        const selectedSpan = document.getElementById(
            `don-vi-selected${suffix}`
        );

        if (!selectedSpan) return;

        const allCheckbox = document.getElementById(
            `don-vi-phu-trach${suffix}-all`
        );

        // Nếu đang chọn "Tất cả đơn vị"
        if (allCheckbox && allCheckbox.checked) {
            selectedSpan.textContent = "Đã chọn: Tất cả";
            return;
        }

        // Nếu chọn từng đơn vị cụ thể
        const selected = getSelectedDonViPhuTrach(suffix);

        selectedSpan.textContent = `Đã chọn: ${selected.length}`;
    }

    // Cập nhật options cho select mã hợp đồng (dạng multi-select)

    function updateMaHopDongOptions(type) {
        if (donHangData.length === 0) return;

        const donHangHeaders = donHangData[0];
        const maHopDongIndex = donHangHeaders.indexOf('ma_hop_dong');
        if (maHopDongIndex === -1) return;

        // Lấy danh sách mã hợp đồng duy nhất (loại bỏ giá trị rỗng)
        const maHopDongValues = new Set();
        for (let i = 1; i < donHangData.length; i++) {
            const value = donHangData[i][maHopDongIndex];
            if (value && value.trim() !== '') {
                maHopDongValues.add(value.trim());
            }
        }

        const sortedValues = Array.from(maHopDongValues).sort();

        // Map đúng suffix theo từng tab
        let suffix = "";
        if (type === "nhap") suffix = "-nhap";
        else if (type === "xuat") suffix = "-xuat";
        else if (type === "lsx") suffix = "-lsx";
        else if (type === "xbh") suffix = "-xbh";
        else return;

        // Container element tương ứng tab
        const containerElement = document.getElementById(`ma-hop-dong${suffix}-container`);
        if (!containerElement) return;

        // Xóa nội dung cũ
        containerElement.innerHTML = '';

        // Tạo input tìm kiếm
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'multi-select-search';
        searchInput.placeholder = 'Tìm kiếm mã hợp đồng...';
        searchInput.id = `ma-hop-dong-search${suffix}`;

        containerElement.appendChild(searchInput);

        // Tạo checkbox "Tất cả đơn hàng" (mặc định được chọn)
        const allOptionDiv = document.createElement('div');
        allOptionDiv.className = 'multi-select-option select-all-option';

        const allCheckbox = document.createElement('input');
        allCheckbox.type = 'checkbox';
        allCheckbox.id = `ma-hop-dong${suffix}-all`;
        allCheckbox.checked = true;

        const allLabel = document.createElement('label');
        allLabel.htmlFor = `ma-hop-dong${suffix}-all`;
        allLabel.textContent = 'Tất cả đơn hàng';

        allOptionDiv.appendChild(allCheckbox);
        allOptionDiv.appendChild(allLabel);
        containerElement.appendChild(allOptionDiv);

        // Thêm sự kiện cho checkbox "Tất cả đơn hàng"
        allCheckbox.addEventListener('change', function () {
            const checkboxes = containerElement.querySelectorAll('input[type="checkbox"]:not(#ma-hop-dong' + suffix + '-all)');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                updateMaHopDongLabel(suffix);
            });

            // Kích hoạt sự kiện change cho filter nếu cần
            if (suffix === '-nhap') requireRefilterNhap();
            else if (suffix === '-xuat') requireRefilterXuat();
            else if (suffix === '-lsx') requireRefilterLenSanXuat();
            else if (suffix === '-xbh') requireRefilterXuatBaoHanh();
        });

        // Add options mới
        sortedValues.forEach(value => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'multi-select-option';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `ma-hop-dong${suffix}-${value.replace(/\s+/g, '-')}`;
            checkbox.value = value;

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = value;

            optionDiv.appendChild(checkbox);
            optionDiv.appendChild(label);
            containerElement.appendChild(optionDiv);

            // Thêm sự kiện cho từng checkbox
            checkbox.addEventListener('change', function () {
                const allCheckbox = document.getElementById(`ma-hop-dong${suffix}-all`);
                const checkboxes = containerElement.querySelectorAll('input[type="checkbox"]:not(#ma-hop-dong' + suffix + '-all)');
                const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

                // Nếu tất cả các checkbox đều được chọn, chọn "Tất cả đơn hàng"
                if (checkedCount === checkboxes.length) {
                    allCheckbox.checked = true;
                }
                // Nếu không có checkbox nào được chọn, chọn "Tất cả đơn hàng"
                else if (checkedCount === 0) {
                    allCheckbox.checked = true;
                }
                // Nếu có một số checkbox được chọn, bỏ chọn "Tất cả đơn hàng"
                else {
                    allCheckbox.checked = false;
                }

                // Cập nhật label số lượng đã chọn
                updateMaHopDongLabel(suffix);

                // Kích hoạt sự kiện change cho filter nếu cần
                if (suffix === '-nhap') requireRefilterNhap();
                else if (suffix === '-xuat') requireRefilterXuat();
                else if (suffix === '-lsx') requireRefilterLenSanXuat();
                else if (suffix === '-xbh') requireRefilterXuatBaoHanh();
            });
        });

        // Thêm sự kiện tìm kiếm
        searchInput.addEventListener("input", function () {
            const keyword = searchInput.value.trim().toLowerCase();

            // Lấy tất cả option
            const options = Array.from(
                containerElement.querySelectorAll(".multi-select-option")
            );

            // Nếu không có text → đưa các lựa chọn đã chọn lên đầu
            if (keyword === "") {

                // Reset ẩn option
                options.forEach(opt => opt.classList.remove("filtered-out"));

                // Sort: selected lên trước
                options.sort((a, b) => {
                    const aChecked = a.querySelector("input").checked;
                    const bChecked = b.querySelector("input").checked;

                    return bChecked - aChecked;
                });

                // Render lại đúng thứ tự
                options.forEach(opt => containerElement.appendChild(opt));

                return;
            }

            // Nếu có text → chia làm 2 nhóm:
            // (1) match keyword
            // (2) selected nhưng không match keyword

            let matched = [];
            let selectedNotMatched = [];
            let others = [];

            options.forEach(opt => {
                const labelText = opt.textContent.toLowerCase();
                const checked = opt.querySelector("input").checked;

                if (labelText.includes(keyword)) {
                    matched.push(opt);
                }
                else if (checked) {
                    selectedNotMatched.push(opt);
                }
                else {
                    others.push(opt);
                }
            });

            // Ẩn tất cả trước
            options.forEach(opt => opt.classList.add("filtered-out"));

            // Hiện nhóm match
            matched.forEach(opt => {
                opt.classList.remove("filtered-out");
                containerElement.appendChild(opt);
            });

            // Hiện nhóm selected nhưng không match (ngay dưới match)
            selectedNotMatched.forEach(opt => {
                opt.classList.remove("filtered-out");
                containerElement.appendChild(opt);
            });

            // Nhóm còn lại vẫn ẩn
        });


        // Giữ container mở rộng khi focus vào ô tìm kiếm
        searchInput.addEventListener('focus', function () {
            containerElement.classList.add('expanded');
        });

        // ✅ Khi di chuột ra ngoài container → thu gọn luôn
        let hideTimeout;

        containerElement.addEventListener("mouseleave", function () {
            hideTimeout = setTimeout(() => {
                containerElement.classList.remove("expanded");
            }, 100);
        });

        containerElement.addEventListener("mouseenter", function () {
            clearTimeout(hideTimeout);
        });


        document.addEventListener("click", function (e) {
            if (!containerElement.contains(e.target)) {
                containerElement.classList.remove("expanded");
            }
        });

        searchInput.addEventListener('blur', function () {
            setTimeout(() => {
                if (!containerElement.matches(':hover')) {
                    containerElement.classList.remove('expanded');
                }
            }, 200);
        });

        updateMaHopDongLabel(suffix);
    }

    // Hàm lấy danh sách mã hợp đồng được chọn từ multi-select
    function getSelectedMaHopDong(suffix) {
        const container = document.getElementById(`ma-hop-dong${suffix}-container`);
        if (!container) return [];

        const allCheckbox = document.getElementById(`ma-hop-dong${suffix}-all`);
        if (allCheckbox && allCheckbox.checked) {
            return []; // Trả về mảng rỗng nếu chọn "Tất cả đơn hàng"
        }

        const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked:not(#ma-hop-dong' + suffix + '-all)');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    function updateMaHopDongLabel(suffix) {
        // span hiển thị số lượng đã chọn
        const selectedSpan = document.getElementById(
            `ma-hop-dong-selected${suffix}`
        );

        if (!selectedSpan) return;

        const allCheckbox = document.getElementById(
            `ma-hop-dong${suffix}-all`
        );

        // Nếu đang chọn "Tất cả đơn hàng"
        if (allCheckbox && allCheckbox.checked) {
            selectedSpan.textContent = "Đã chọn: Tất cả";
            return;
        }

        // Nếu chọn từng mã hợp đồng cụ thể
        const selected = getSelectedMaHopDong(suffix);

        selectedSpan.textContent = `Đã chọn: ${selected.length}`;
    }

    // Cập nhật options cho select xưởng sản xuất
    function updateXuongSanXuatOptions() {
        if (donHangData.length === 0) return;

        const donHangHeaders = donHangData[0];
        const xuongSanXuatIndex = donHangHeaders.indexOf('xuong_san_xuat');
        if (xuongSanXuatIndex === -1) return;

        // Lấy danh sách xưởng duy nhất
        const xuongValues = new Set();

        for (let i = 1; i < donHangData.length; i++) {
            const value = donHangData[i][xuongSanXuatIndex];
            if (value && value.trim() !== '') {
                xuongValues.add(value.trim());
            }
        }

        const sortedValues = Array.from(xuongValues).sort();

        // ✅ Update cho cả 2 tab
        const selectElements = [
            document.getElementById("xuong-san-xuat-lsx"),
            document.getElementById("xuong-san-xuat-xbh")
        ];

        selectElements.forEach(selectElement => {
            if (!selectElement) return;

            // Xóa option cũ (giữ option đầu)
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            // Thêm option mới
            sortedValues.forEach(value => {
                const option = document.createElement("option");
                option.value = value;
                option.textContent = value;
                selectElement.appendChild(option);
            });
        });
    }

    // Cập nhật options cho select mã phiếu (dạng multi-select)
    function updateMaPhieuOptions() {
        if (xuatChuyenKhoChiTietData.length === 0) return;

        const chiTietHeaders = xuatChuyenKhoChiTietData[0];
        const maPhieuXuatIdIndex = chiTietHeaders.indexOf('ma_phieu_xuat_id');
        if (maPhieuXuatIdIndex === -1) return;

        // Lấy danh sách mã phiếu duy nhất
        const maPhieuValues = new Set();
        for (let i = 1; i < xuatChuyenKhoChiTietData.length; i++) {
            const value = xuatChuyenKhoChiTietData[i][maPhieuXuatIdIndex];
            if (value && value.trim() !== '') {
                maPhieuValues.add(value.trim());
            }
        }

        const sortedValues = Array.from(maPhieuValues).sort();

        // Container element
        const containerElement = document.getElementById('ma-phieu-xuat-yeu-cau-container');
        if (!containerElement) return;

        // Xóa nội dung cũ
        containerElement.innerHTML = '';

        // Tạo input tìm kiếm
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'multi-select-search';
        searchInput.placeholder = 'Tìm kiếm mã phiếu...';
        searchInput.id = 'ma-phieu-search-xuat-yeu-cau';

        containerElement.appendChild(searchInput);

        // Tạo checkbox "Tất cả mã phiếu" (mặc định được chọn)
        const allOptionDiv = document.createElement('div');
        allOptionDiv.className = 'multi-select-option select-all-option';

        const allCheckbox = document.createElement('input');
        allCheckbox.type = 'checkbox';
        allCheckbox.id = 'ma-phieu-xuat-yeu-cau-all';
        allCheckbox.checked = true;

        const allLabel = document.createElement('label');
        allLabel.htmlFor = 'ma-phieu-xuat-yeu-cau-all';
        allLabel.textContent = 'Tất cả mã phiếu';

        allOptionDiv.appendChild(allCheckbox);
        allOptionDiv.appendChild(allLabel);
        containerElement.appendChild(allOptionDiv);

        // Thêm sự kiện cho checkbox "Tất cả mã phiếu"
        allCheckbox.addEventListener('change', function () {
            const checkboxes = containerElement.querySelectorAll('input[type="checkbox"]:not(#ma-phieu-xuat-yeu-cau-all)');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                updateMaPhieuLabel(); // Cập nhật label
            });
            requireRefilterXuatYeuCau();
        });

        // Add options mới
        sortedValues.forEach(value => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'multi-select-option';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `ma-phieu-xuat-yeu-cau-${value.replace(/\s+/g, '-')}`;
            checkbox.value = value;

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = value;

            optionDiv.appendChild(checkbox);
            optionDiv.appendChild(label);
            containerElement.appendChild(optionDiv);

            // Thêm sự kiện cho từng checkbox
            checkbox.addEventListener('change', function () {
                const allCheckbox = document.getElementById('ma-phieu-xuat-yeu-cau-all');
                const checkboxes = containerElement.querySelectorAll('input[type="checkbox"]:not(#ma-phieu-xuat-yeu-cau-all)');
                const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

                if (checkedCount === checkboxes.length) {
                    allCheckbox.checked = true;
                } else if (checkedCount === 0) {
                    allCheckbox.checked = true;
                } else {
                    allCheckbox.checked = false;
                }

                updateMaPhieuLabel(); // Cập nhật label
                requireRefilterXuatYeuCau();
            });
        });

        // Thêm sự kiện tìm kiếm (giống các multi-select khác)
        searchInput.addEventListener("input", function () {
            const keyword = searchInput.value.trim().toLowerCase();

            // Lấy tất cả option
            const options = Array.from(
                containerElement.querySelectorAll(".multi-select-option")
            );

            // Nếu không có text → đưa các lựa chọn đã chọn lên đầu
            if (keyword === "") {
                // Reset ẩn option
                options.forEach(opt => opt.classList.remove("filtered-out"));

                // Sort: selected lên trước
                options.sort((a, b) => {
                    const aChecked = a.querySelector("input").checked;
                    const bChecked = b.querySelector("input").checked;

                    return bChecked - aChecked;
                });

                // Render lại đúng thứ tự
                options.forEach(opt => containerElement.appendChild(opt));

                return;
            }

            // Nếu có text → chia làm 2 nhóm:
            // (1) match keyword
            // (2) selected nhưng không match keyword

            let matched = [];
            let selectedNotMatched = [];
            let others = [];

            options.forEach(opt => {
                const labelText = opt.textContent.toLowerCase();
                const checked = opt.querySelector("input").checked;

                if (labelText.includes(keyword)) {
                    matched.push(opt);
                }
                else if (checked) {
                    selectedNotMatched.push(opt);
                }
                else {
                    others.push(opt);
                }
            });

            // Ẩn tất cả trước
            options.forEach(opt => opt.classList.add("filtered-out"));

            // Hiện nhóm match
            matched.forEach(opt => {
                opt.classList.remove("filtered-out");
                containerElement.appendChild(opt);
            });

            // Hiện nhóm selected nhưng không match (ngay dưới match)
            selectedNotMatched.forEach(opt => {
                opt.classList.remove("filtered-out");
                containerElement.appendChild(opt);
            });

            // Nhóm còn lại vẫn ẩn
        });

        // Giữ container mở rộng khi focus vào ô tìm kiếm
        searchInput.addEventListener('focus', function () {
            containerElement.classList.add('expanded');
        });

        let hideTimeout;

        containerElement.addEventListener("mouseleave", function () {
            hideTimeout = setTimeout(() => {
                containerElement.classList.remove("expanded");
            }, 100);
        });

        containerElement.addEventListener("mouseenter", function () {
            clearTimeout(hideTimeout);
        });

        document.addEventListener("click", function (e) {
            if (!containerElement.contains(e.target)) {
                containerElement.classList.remove("expanded");
            }
        });

        searchInput.addEventListener('blur', function () {
            setTimeout(() => {
                if (!containerElement.matches(':hover')) {
                    containerElement.classList.remove('expanded');
                }
            }, 200);
        });

        updateMaPhieuLabel(); // Cập nhật label lần đầu
    }
    function getSelectedMaPhieu() {
        const container = document.getElementById('ma-phieu-xuat-yeu-cau-container');
        if (!container) return [];

        const allCheckbox = document.getElementById('ma-phieu-xuat-yeu-cau-all');
        if (allCheckbox && allCheckbox.checked) {
            return []; // Trả về mảng rỗng nếu chọn "Tất cả mã phiếu"
        }

        const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked:not(#ma-phieu-xuat-yeu-cau-all)');
        return Array.from(checkboxes).map(cb => cb.value);
    }
    function updateMaPhieuLabel() {
        const selectedSpan = document.getElementById('ma-phieu-selected-xuat-yeu-cau');
        if (!selectedSpan) return;

        const allCheckbox = document.getElementById('ma-phieu-xuat-yeu-cau-all');
        if (allCheckbox && allCheckbox.checked) {
            selectedSpan.textContent = "Đã chọn: Tất cả";
            return;
        }

        const selected = getSelectedMaPhieu();
        selectedSpan.textContent = `Đã chọn: ${selected.length}`;
    }

    function updateLoaiPhieuOptionsForXuatYeuCau() {
        if (xuatChuyenKhoData.length === 0) return;

        const headers = xuatChuyenKhoData[0];
        const loaiPhieuIndex = headers.indexOf('loai_phieu');
        if (loaiPhieuIndex === -1) return;

        // Lấy danh sách xưởng duy nhất
        const loaiphieuValues = new Set();
        for (let i = 1; i < xuatChuyenKhoData.length; i++) {
            const value = xuatChuyenKhoData[i][loaiPhieuIndex];
            if (value && value.trim() !== '') {
                loaiphieuValues.add(value.trim());
            }
        }

        const sortedValues = Array.from(loaiphieuValues).sort();

        const selectElement = document.getElementById('loai-phieu-xuat-yeu-cau');
        if (!selectElement) return;

        // Xóa option cũ (giữ option đầu)
        while (selectElement.options.length > 1) {
            selectElement.remove(1);
        }

        // Thêm option mới
        sortedValues.forEach(value => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = value;
            selectElement.appendChild(option);
        });
    }

    function updateXuongSanXuatOptionsForXuatYeuCau() {
        if (xuatChuyenKhoData.length === 0) return;

        const headers = xuatChuyenKhoData[0];
        const xuongSxIndex = headers.indexOf('xuong_sx');
        if (xuongSxIndex === -1) return;

        // Lấy danh sách xưởng duy nhất
        const xuongValues = new Set();
        for (let i = 1; i < xuatChuyenKhoData.length; i++) {
            const value = xuatChuyenKhoData[i][xuongSxIndex];
            if (value && value.trim() !== '') {
                xuongValues.add(value.trim());
            }
        }

        const sortedValues = Array.from(xuongValues).sort();

        const selectElement = document.getElementById('xuong-san-xuat-xuat-yeu-cau');
        if (!selectElement) return;

        // Xóa option cũ (giữ option đầu)
        while (selectElement.options.length > 1) {
            selectElement.remove(1);
        }

        // Thêm option mới
        sortedValues.forEach(value => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = value;
            selectElement.appendChild(option);
        });
    }

    // Cập nhật trạng thái kết nối
    function updateConnectionStatus(text, bgColor, color) {
        const statusElement = document.getElementById('connection-status');
        const textElement = document.getElementById('status-text');
        const lastUpdateBox = document.getElementById("last-update");
        const lastUpdateText = document.getElementById("last-update-text");

        statusElement.style.backgroundColor = bgColor;
        textElement.textContent = text;
        textElement.style.color = color;

        if (lastUpdateBox) {
            lastUpdateBox.style.backgroundColor = bgColor;
            lastUpdateBox.style.color = color;
        }

        if (lastUpdateText) {
            lastUpdateText.style.color = color;
        }

        updateLastUpdateTime();
        const dot = statusElement.querySelector(".dot");
        if (dot) dot.style.backgroundColor = color;
    }

    // Hàm chuyển đổi chuỗi ngày dd/mm/yyyy sang đối tượng Date
    function parseDDMMYYYY(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('/');
        if (parts.length !== 3) return null;
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        const date = new Date(year, month, day);
        return isNaN(date.getTime()) ? null : date;
    }

    // Hàm format số cho hiển thị
    function formatNumberForDisplay(value) {
        if (!value && value !== 0) return '';
        const num = parseFloat(value.toString().replace(/\./g, '').replace(',', '.'));
        if (isNaN(num)) return value;
        return num.toLocaleString('vi-VN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        });
    }

    // Hàm format số cho CSV
    function formatNumberForCSV(value) {
        if (!value && value !== 0) return '';
        const num = parseFloat(value.toString().replace(/\./g, '').replace(',', '.'));
        if (isNaN(num)) return value;
        return num;
    }

    function convertDateToExcelSerial(dateStr) {
        if (!dateStr) return '';

        // dateStr dạng dd/mm/yyyy
        const parts = dateStr.split('/');
        if (parts.length !== 3) return dateStr;

        const dd = parseInt(parts[0], 10);
        const mm = parseInt(parts[1], 10);
        const yyyy = parseInt(parts[2], 10);

        if (!dd || !mm || !yyyy) return dateStr;

        // Tạo Date theo UTC để tránh lệch ngày do timezone
        const dateObj = new Date(Date.UTC(yyyy, mm - 1, dd));

        // Excel serial: tính từ 1899-12-30
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const diffDays = Math.floor((dateObj - excelEpoch) / (1000 * 60 * 60 * 24));

        return diffDays;
    }
    // Format ngày từ input date (yyyy-mm-dd) → dd.mm.yyyy
    function formatDateForFilename(dateStr) {
        if (!dateStr) return "";
        const parts = dateStr.split("-");
        if (parts.length !== 3) return dateStr;
        return `${parts[2]}.${parts[1]}.${parts[0]}`;
    }

    // Cập nhật thời gian
    function updateLastUpdateTime() {
        const lastUpdateElement = document.getElementById("last-update-text");
        if (!lastUpdateElement) return;
        const now = new Date();
        const formatted = now.toLocaleTimeString("vi-VN");
        lastUpdateElement.textContent = formatted;
    }

    // ==================== TAB DỮ LIỆU KHÁCH HÀNG ====================

    let filteredResultsKhachHang = [];

    function initKhachHangEventListeners() {
        document.getElementById('btn-loc-kh').addEventListener('click', applyFilterKhachHang);
        document.getElementById('btn-reset-kh').addEventListener('click', resetFilterKhachHang);
        document.getElementById('btn-export-kh').addEventListener('click', exportToExcelKhachHang);

        document.getElementById("tu-ngay-kh").addEventListener("change", requireRefilterKhachHang);
        document.getElementById("den-ngay-kh").addEventListener("change", requireRefilterKhachHang);
    }

    function resetFilterKhachHang() {
        // Reset multi-select đơn vị phụ trách
        const allCheckbox = document.getElementById('don-vi-phu-trach-kh-all');
        if (allCheckbox) {
            allCheckbox.checked = true;
        }

        const checkboxes = document.querySelectorAll('#don-vi-phu-trach-kh-container input[type="checkbox"]:not(#don-vi-phu-trach-kh-all)');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        document.getElementById('tu-ngay-kh').value = '';
        document.getElementById('den-ngay-kh').value = '';

        document.getElementById('results-table-kh').style.display = 'none';
        document.getElementById('no-results-kh').style.display = 'block';
        document.getElementById('results-count-kh').textContent = 'Kết quả: Chưa có dòng nào được lọc.';

        filteredResultsKhachHang = [];
    }

    async function applyFilterKhachHang() {
        showLoadingKhachHang(true);

        try {
            if (!isDataLoaded) {
                await fetchDataFromSheets();
            }

            const filterOptions = {
                donViPhuTrach: getSelectedDonViPhuTrach('-kh'), // Lấy danh sách đơn vị được chọn
                tuNgay: document.getElementById('tu-ngay-kh').value,
                denNgay: document.getElementById('den-ngay-kh').value
            };

            filteredResultsKhachHang = filterDataKhachHang(filterOptions);
            displayResultsKhachHang(filteredResultsKhachHang);
            showMessageKhachHang(`Đã tìm thấy ${filteredResultsKhachHang.length} dòng phù hợp.`, 'success');

        } catch (error) {
            console.error('Lỗi khi áp dụng bộ lọc:', error);
            showMessageKhachHang('Đã xảy ra lỗi khi tải dữ liệu. Vui lòng thử lại.', 'error');
        } finally {
            showLoadingKhachHang(false);
        }
    }

    function filterDataKhachHang(filterOptions) {
        if (danhSachKhachHangData.length === 0) {
            return [];
        }

        const khachHangHeaders = danhSachKhachHangData[0];
        const khachHangColumnIndex = {};
        khachHangHeaders.forEach((header, index) => {
            khachHangColumnIndex[header] = index;
        });

        const filteredResults = [];
        let resultId = 1;

        for (let i = 1; i < danhSachKhachHangData.length; i++) {
            const row = danhSachKhachHangData[i];

            if (!passesFilterConditionsKhachHang(row, khachHangColumnIndex, filterOptions)) {
                continue;
            }

            filteredResults.push({
                id: resultId++,
                row: row,
                columnIndex: khachHangColumnIndex
            });
        }

        return filteredResults;
    }

    function passesFilterConditionsKhachHang(row, columnIndex, filterOptions) {
        const maKhachHang = row[columnIndex['ma_khach_hang']] || '';
        const donViPhuTrach = row[columnIndex['don_vi_phu_trach']] || '';
        const ngayPhatSinh = row[columnIndex['ngay_phat_sinh']] || '';

        // Điều kiện 1: Mã khách hàng không được rỗng
        if (!maKhachHang || maKhachHang.trim() === '') {
            return false;
        }

        // Điều kiện 2: Lọc theo đơn vị phụ trách
        if (filterOptions.donViPhuTrach && filterOptions.donViPhuTrach.length > 0) {
            if (!filterOptions.donViPhuTrach.includes(donViPhuTrach)) {
                return false;
            }
        }

        // Điều kiện 3: Lọc theo ngày báo cáo (danh sách mã khách hàng)
        if (filterOptions.ngayBaoCao) {
            const maKhachHangList = filterOptions.ngayBaoCao.split(',').map(item => item.trim());
            if (!maKhachHangList.includes(maKhachHang)) {
                return false;
            }
        }

        // Điều kiện 4: Lọc theo ngày phát sinh
        if (filterOptions.tuNgay && filterOptions.denNgay) {
            const tuNgay = new Date(filterOptions.tuNgay);
            const denNgay = new Date(filterOptions.denNgay);

            tuNgay.setHours(0, 0, 0, 0);
            denNgay.setHours(23, 59, 59, 999);

            const ngayPhatSinhDate = parseDDMMYYYY(ngayPhatSinh);
            if (!ngayPhatSinhDate) {
                return false;
            }

            if (ngayPhatSinhDate < tuNgay || ngayPhatSinhDate > denNgay) {
                return false;
            }
        }

        return true;
    }

    function displayResultsKhachHang(results) {
        const resultsBody = document.getElementById('results-body-kh');
        const resultsTable = document.getElementById('results-table-kh');
        const noResults = document.getElementById('no-results-kh');
        const resultsCount = document.getElementById('results-count-kh');

        resultsCount.textContent = `Kết quả: ${results.length} dòng`;
        resultsBody.innerHTML = '';

        if (results.length === 0) {
            resultsTable.style.display = 'none';
            noResults.style.display = 'block';
            return;
        }

        noResults.style.display = 'none';
        resultsTable.style.display = 'table';

        results.forEach(result => {
            const row = result.row;
            const columnIndex = result.columnIndex;

            // Lấy giá trị từ các cột
            const id = row[columnIndex['id']] || '';
            const loaiKhachHang = row[columnIndex['loai_khach_hang']] || '';
            const maKhachHang = row[columnIndex['ma_khach_hang']] || '';
            const tenNguoiLienHe = row[columnIndex['ten_nguoi_lien_he']] || '';
            const diaChiChiTiet = row[columnIndex['dia_chi_chi_tiet']] || '';
            const maSoThue = row[columnIndex['ma_so_thue']] || '';
            const sdtCoDinh = row[columnIndex['sdt_co_dinh']] || '';
            const sdtT1 = row[columnIndex['sdt_t1']] || '';
            const sdtT2 = row[columnIndex['sdt_t2']] || '';
            const fax = row[columnIndex['fax']] || '';
            const emailKhachHang = row[columnIndex['email_khach_hang']] || '';
            const donViPhuTrach = row[columnIndex['don_vi_phu_trach']] || '';
            const ngayPhatSinh = row[columnIndex['ngay_phat_sinh']] || '';

            // Các cột bổ sung (nếu có)
            const soCmnd = row[columnIndex['so_cmnd']] || '';
            const ngayCap = row[columnIndex['ngay_cap']] || '';
            const noiCap = row[columnIndex['noi_cap']] || '';
            const xungHo = row[columnIndex['xung_ho']] || '';
            const hoTenNlh = row[columnIndex['ho_ten_nlh']] || '';
            const chucDanhNlh = row[columnIndex['chuc_danh_nlh']] || '';
            const diaChiNlh = row[columnIndex['dia_chi_nlh']] || '';
            const dtDiDongNlh = row[columnIndex['dt_di_dong_nlh']] || '';
            const dtDiDongKhacNlh = row[columnIndex['dt_di_dong_khac_nlh']] || '';
            const dtCoDinhNlh = row[columnIndex['dt_co_dinh_nlh']] || '';
            const emailNlh = row[columnIndex['email_nlh']] || '';
            const soTaiKhoan = row[columnIndex['so_tai_khoan']] || '';
            const tenNganHang = row[columnIndex['ten_ngan_hang']] || '';
            const chiNhanh = row[columnIndex['chi_nhanh']] || '';
            const tinhTpNganHang = row[columnIndex['tinh_tp_ngan_hang']] || '';

            // Xử lý cột "Là tổ chức/cá nhân"
            let laToChucCaNhan = '';
            if (loaiKhachHang === "Tổ chức") {
                laToChucCaNhan = "0";
            } else if (loaiKhachHang === "Cá nhân") {
                laToChucCaNhan = "1";
            }

            // Xử lý cột "Điện thoại di động"
            let dienThoaiDiDong = '';
            if (sdtT1 && sdtT2) {
                dienThoaiDiDong = `${sdtT1}/${sdtT2}`;
            } else if (sdtT1) {
                dienThoaiDiDong = sdtT1;
            } else if (sdtT2) {
                dienThoaiDiDong = sdtT2;
            }

            // Xử lý cột "Nhóm KH/NCC"
            let nhomKhNcc = '';
            if (donViPhuTrach === "BP. BH1" || donViPhuTrach === "BP. BH2") {
                const ma12 = maKhachHang.substring(0, 12);
                const ma9 = maKhachHang.substring(0, 9);
                const ma6 = maKhachHang.substring(0, 6);
                const ma2 = maKhachHang.substring(0, 2);
                const ma1 = maKhachHang.substring(0, 1);
                nhomKhNcc = `${ma12};${ma9};${ma6};${ma2};${ma1}`;
            }

            const tableRow = document.createElement('tr');
            tableRow.innerHTML = `
    <td>${id}</td>
    <td>${laToChucCaNhan}</td>
    <td>0</td>
    <td>${maKhachHang}</td>
    <td>${tenNguoiLienHe}</td>
    <td>${diaChiChiTiet}</td>
    <td>${maSoThue}</td>
    <td>${sdtCoDinh}</td>
    <td>${dienThoaiDiDong}</td>
    <td>${fax}</td>
    <td>${emailKhachHang}</td>
    <td></td>
    <td>${nhomKhNcc}</td>
    <td>${soCmnd}</td>
    <td>${ngayCap}</td>
    <td>${noiCap}</td>
    <td>${xungHo}</td>
    <td>${hoTenNlh}</td>
    <td>${chucDanhNlh}</td>
    <td>${diaChiNlh}</td>
    <td>${dtDiDongNlh}</td>
    <td>${dtDiDongKhacNlh}</td>
    <td>${dtCoDinhNlh}</td>
    <td>${emailNlh}</td>
    <td>${soTaiKhoan}</td>
    <td>${tenNganHang}</td>
    <td>${chiNhanh}</td>
    <td>${tinhTpNganHang}</td>
    <td>${ngayPhatSinh}</td>
    `;
            resultsBody.appendChild(tableRow);
        });
    }

    async function exportToExcelKhachHang() {
        if (filteredResultsKhachHang.length === 0) {
            showMessageKhachHang('Không có dữ liệu để xuất. Vui lòng thực hiện lọc trước.', 'error');
            return;
        }

        try {
            // Thay vì tải template, tạo workbook mới
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Danh sách khách hàng');

            // Thêm tiêu đề cột
            worksheet.addRow([
                'ID', 'Là tổ chức/cá nhân', 'Là nhà cung cấp', 'Mã khách hàng (*)',
                'Tên khách hàng (*)', 'Địa chỉ', 'Mã số thuế', 'Điện thoại',
                'Điện thoại di động', 'Fax', 'Email', 'Website', 'Nhóm KH/NCC',
                'Số CMND', 'Ngày cấp', 'Nơi cấp', 'Xưng hô', 'Họ và tên NLH',
                'Chức danh NLH', 'Địa chỉ người liên hệ', 'ĐT di động NLH',
                'ĐT di động khác của NLH', 'ĐT cố định NLH', 'Email người liên hệ',
                'Số tài khoản', 'Tên ngân hàng', 'Chi nhánh', 'Tỉnh/TP TK ngân hàng',
                'Ngày phát sinh'
            ]);

            // Định dạng tiêu đề
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFE0E0E0' }
            };

            // 2. Thêm tiêu đề báo cáo (tùy chọn)
            const tuNgayRaw = document.getElementById("tu-ngay-kh").value;
            const denNgayRaw = document.getElementById("den-ngay-kh").value;
            const tuNgay = formatDateForFilename(tuNgayRaw);
            const denNgay = formatDateForFilename(denNgayRaw);

            // Có thể thêm tiêu đề ở dòng 1 (nếu template để trống)
            // worksheet.getCell('A1').value = `DANH SÁCH KHÁCH HÀNG`;
            // worksheet.getCell('A2').value = `Từ ngày: ${tuNgay} - Đến ngày: ${denNgay}`;
            // worksheet.getCell('A3').value = `Tổng số: ${filteredResultsKhachHang.length} khách hàng`;

            // 3. Xác định dòng bắt đầu điền dữ liệu
            // Giả sử dữ liệu bắt đầu từ dòng 2 (dòng 1 là tiêu đề)
            let startRow = 2;

            // 4. Điền dữ liệu từng dòng
            filteredResultsKhachHang.forEach((result, index) => {
                const row = result.row;
                const columnIndex = result.columnIndex;

                const id = row[columnIndex['id']] || '';
                const loaiKhachHang = row[columnIndex['loai_khach_hang']] || '';
                const maKhachHang = row[columnIndex['ma_khach_hang']] || '';
                const tenNguoiLienHe = row[columnIndex['ten_nguoi_lien_he']] || '';
                const diaChiChiTiet = row[columnIndex['dia_chi_chi_tiet']] || '';
                const maSoThue = row[columnIndex['ma_so_thue']] || '';
                const sdtCoDinh = row[columnIndex['sdt_co_dinh']] || '';
                const sdtT1 = row[columnIndex['sdt_t1']] || '';
                const sdtT2 = row[columnIndex['sdt_t2']] || '';
                const fax = row[columnIndex['fax']] || '';
                const emailKhachHang = row[columnIndex['email_khach_hang']] || '';
                const donViPhuTrach = row[columnIndex['don_vi_phu_trach']] || '';
                const ngayPhatSinh = convertDateToExcelSerial(row[columnIndex['ngay_phat_sinh']] || '');

                // Các cột bổ sung
                const soCmnd = row[columnIndex['so_cmnd']] || '';
                const ngayCap = row[columnIndex['ngay_cap']] || '';
                const noiCap = row[columnIndex['noi_cap']] || '';
                const xungHo = row[columnIndex['xung_ho']] || '';
                const hoTenNlh = row[columnIndex['ho_ten_nlh']] || '';
                const chucDanhNlh = row[columnIndex['chuc_danh_nlh']] || '';
                const diaChiNlh = row[columnIndex['dia_chi_nlh']] || '';
                const dtDiDongNlh = row[columnIndex['dt_di_dong_nlh']] || '';
                const dtDiDongKhacNlh = row[columnIndex['dt_di_dong_khac_nlh']] || '';
                const dtCoDinhNlh = row[columnIndex['dt_co_dinh_nlh']] || '';
                const emailNlh = row[columnIndex['email_nlh']] || '';
                const soTaiKhoan = row[columnIndex['so_tai_khoan']] || '';
                const tenNganHang = row[columnIndex['ten_ngan_hang']] || '';
                const chiNhanh = row[columnIndex['chi_nhanh']] || '';
                const tinhTpNganHang = row[columnIndex['tinh_tp_ngan_hang']] || '';

                // Xử lý cột "Là tổ chức/cá nhân"
                let laToChucCaNhan = '';
                if (loaiKhachHang === "Tổ chức") {
                    laToChucCaNhan = "0";
                } else if (loaiKhachHang === "Cá nhân") {
                    laToChucCaNhan = "1";
                }

                // Xử lý cột "Điện thoại di động"
                let dienThoaiDiDong = '';
                if (sdtT1 && sdtT2) {
                    dienThoaiDiDong = `${sdtT1}/${sdtT2}`;
                } else if (sdtT1) {
                    dienThoaiDiDong = sdtT1;
                } else if (sdtT2) {
                    dienThoaiDiDong = sdtT2;
                }

                // Xử lý cột "Nhóm KH/NCC"
                let nhomKhNcc = '';
                if (donViPhuTrach === "BP. BH1" || donViPhuTrach === "BP. BH2") {
                    const ma12 = maKhachHang.substring(0, 12);
                    const ma9 = maKhachHang.substring(0, 9);
                    const ma6 = maKhachHang.substring(0, 6);
                    const ma2 = maKhachHang.substring(0, 2);
                    const ma1 = maKhachHang.substring(0, 1);
                    nhomKhNcc = `${ma12};${ma9};${ma6};${ma2};${ma1}`;
                }

                // Điền dữ liệu vào Excel
                const currentRow = startRow + index;

                // Cột A -> AC (29 cột)
                worksheet.getCell(`A${currentRow}`).value = id;
                worksheet.getCell(`B${currentRow}`).value = laToChucCaNhan;
                worksheet.getCell(`C${currentRow}`).value = 0; // Luôn là 0 (Là nhà cung cấp)
                worksheet.getCell(`D${currentRow}`).value = maKhachHang;
                worksheet.getCell(`E${currentRow}`).value = tenNguoiLienHe;
                worksheet.getCell(`F${currentRow}`).value = diaChiChiTiet;
                worksheet.getCell(`G${currentRow}`).value = maSoThue;
                worksheet.getCell(`H${currentRow}`).value = sdtCoDinh;
                worksheet.getCell(`I${currentRow}`).value = dienThoaiDiDong;
                worksheet.getCell(`J${currentRow}`).value = fax;
                worksheet.getCell(`K${currentRow}`).value = emailKhachHang;
                worksheet.getCell(`L${currentRow}`).value = ""; // Website (để trống)
                worksheet.getCell(`M${currentRow}`).value = nhomKhNcc;
                worksheet.getCell(`N${currentRow}`).value = soCmnd;
                worksheet.getCell(`O${currentRow}`).value = ngayCap;
                worksheet.getCell(`P${currentRow}`).value = noiCap;
                worksheet.getCell(`Q${currentRow}`).value = xungHo;
                worksheet.getCell(`R${currentRow}`).value = hoTenNlh;
                worksheet.getCell(`S${currentRow}`).value = chucDanhNlh;
                worksheet.getCell(`T${currentRow}`).value = diaChiNlh;
                worksheet.getCell(`U${currentRow}`).value = dtDiDongNlh;
                worksheet.getCell(`V${currentRow}`).value = dtDiDongKhacNlh;
                worksheet.getCell(`W${currentRow}`).value = dtCoDinhNlh;
                worksheet.getCell(`X${currentRow}`).value = emailNlh;
                worksheet.getCell(`Y${currentRow}`).value = soTaiKhoan;
                worksheet.getCell(`Z${currentRow}`).value = tenNganHang;
                worksheet.getCell(`AA${currentRow}`).value = chiNhanh;
                worksheet.getCell(`AB${currentRow}`).value = tinhTpNganHang;
                worksheet.getCell(`AC${currentRow}`).value = ngayPhatSinh;

                // Định dạng số (nếu cần)
                // worksheet.getCell(`Y${currentRow}`).numFmt = '#,##0';
            });

            // 5. Tự động điều chỉnh độ rộng cột
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    const cellLength = cell.value ? cell.value.toString().length : 10;
                    if (cellLength > maxLength) {
                        maxLength = cellLength;
                    }
                });
                column.width = maxLength < 10 ? 10 : maxLength + 2;
            });

            // 6. Tạo tên file và tải về
            const outputBuffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([outputBuffer], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const fileName = `Danh sách khách hàng - ${tuNgay} - ${denNgay}.xlsx`;
            link.download = fileName;
            link.click();

            // 7. Hiển thị thông báo thành công
            showMessageKhachHang(`Đã xuất ${filteredResultsKhachHang.length} dòng ra file Excel.`, 'success');

        } catch (error) {
            console.error('Lỗi xuất Excel:', error);
            showMessageKhachHang('Không thể xuất Excel. Vui lòng thử lại.', 'error');
        }
    }

    function showLoadingKhachHang(show) {
        const loadingElement = document.getElementById('loading-kh');
        loadingElement.style.display = show ? 'block' : 'none';
    }

    function showMessageKhachHang(message, type) {
        const resultsCount = document.getElementById("results-count-kh");
        resultsCount.className = "results-count";

        if (type === "success") {
            resultsCount.style.backgroundColor = "#e8f7e8";
            resultsCount.style.color = "#0c9c07";
            resultsCount.style.borderLeft = "4px solid #0c9c07";
        }

        if (type === "error") {
            resultsCount.style.backgroundColor = "#ffeaea";
            resultsCount.style.color = "#c00";
            resultsCount.style.borderLeft = "4px solid #c00";
        }

        resultsCount.style.padding = "5px";
        resultsCount.style.borderRadius = "6px";
        resultsCount.style.fontSize = "16px";
        resultsCount.style.fontWeight = "600";
        resultsCount.textContent = message;
    }

    function requireRefilterKhachHang() {
        document.getElementById('results-table-kh').style.display = 'none';
        document.getElementById('no-results-kh').style.display = 'block';
        document.getElementById('results-count-kh').textContent = 'Kết quả: Chưa có dòng nào được lọc.';
        filteredResultsKhachHang = [];
        showMessageKhachHang("Bạn đã thay đổi bộ lọc. Vui lòng nhấn 'Lọc' để cập nhật kết quả mới.", "error");
    }

    // ==================== TAB NHẬP KHO ====================

    let filteredResultsNhap = [];

    function initNhapKhoEventListeners() {
        document.getElementById('btn-loc-nhap').addEventListener('click', applyFilterNhap);
        document.getElementById('btn-reset-nhap').addEventListener('click', resetFilterNhap);
        document.getElementById('btn-export-nhap').addEventListener('click', exportToExcelNhap);

        // Xóa event listener cho input text cũ
        // document.getElementById("ma-hop-dong-nhap").addEventListener("input", requireRefilterNhap);
        document.getElementById("tu-ngay-nhap").addEventListener("change", requireRefilterNhap);
        document.getElementById("den-ngay-nhap").addEventListener("change", requireRefilterNhap);

        document.querySelectorAll("input[name='loai-don-hang-nhap']").forEach(radio => {
            radio.addEventListener("change", requireRefilterNhap);
        });
    }

    function resetFilterNhap() {
        // Reset multi-select đơn vị phụ trách
        const donViAllCheckbox = document.getElementById('don-vi-phu-trach-nhap-all');
        if (donViAllCheckbox) {
            donViAllCheckbox.checked = true;
        }

        const donViCheckboxes = document.querySelectorAll('#don-vi-phu-trach-nhap-container input[type="checkbox"]:not(#don-vi-phu-trach-nhap-all)');
        donViCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        // Reset multi-select mã hợp đồng
        const maHopDongAllCheckbox = document.getElementById('ma-hop-dong-nhap-all');
        if (maHopDongAllCheckbox) {
            maHopDongAllCheckbox.checked = true;
        }

        const maHopDongCheckboxes = document.querySelectorAll('#ma-hop-dong-nhap-container input[type="checkbox"]:not(#ma-hop-dong-nhap-all)');
        maHopDongCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        document.getElementById('tu-ngay-nhap').value = '';
        document.getElementById('den-ngay-nhap').value = '';
        document.getElementById('loai-tat-ca-nhap').checked = true;

        document.getElementById('results-table-nhap').style.display = 'none';
        document.getElementById('no-results-nhap').style.display = 'block';
        document.getElementById('results-count-nhap').textContent = 'Kết quả: Chưa có dòng nào được lọc.';

        filteredResultsNhap = [];
    }

    async function applyFilterNhap() {
        showLoadingNhap(true);

        try {
            if (!isDataLoaded) {
                await fetchDataFromSheets();
            }

            const filterOptions = {
                maHopDong: getSelectedMaHopDong('-nhap'), // Lấy danh sách mã hợp đồng được chọn
                donViPhuTrach: getSelectedDonViPhuTrach('-nhap'), // Lấy danh sách đơn vị được chọn
                tuNgay: document.getElementById('tu-ngay-nhap').value,
                denNgay: document.getElementById('den-ngay-nhap').value,
                loaiDonHang: document.querySelector('input[name="loai-don-hang-nhap"]:checked').value
            };

            filteredResultsNhap = filterDataNhap(filterOptions);
            displayResultsNhap(filteredResultsNhap);
            showMessageNhap(`Đã tìm thấy ${filteredResultsNhap.length} dòng phù hợp.`, 'success');

        } catch (error) {
            console.error('Lỗi khi áp dụng bộ lọc:', error);
            showMessageNhap('Đã xảy ra lỗi khi tải dữ liệu. Vui lòng thử lại.', 'error');
        } finally {
            showLoadingNhap(false);
        }
    }

    function filterDataNhap(filterOptions) {
        if (donHangData.length === 0 || donHangChiTietData.length === 0) {
            return [];
        }

        const donHangHeaders = donHangData[0];
        const chiTietHeaders = donHangChiTietData[0];

        const donHangColumnIndex = {};
        donHangHeaders.forEach((header, index) => {
            donHangColumnIndex[header] = index;
        });

        const chiTietColumnIndex = {};
        chiTietHeaders.forEach((header, index) => {
            chiTietColumnIndex[header] = index;
        });

        const filteredResults = [];
        let resultId = 1;

        for (let i = 1; i < donHangChiTietData.length; i++) {
            const chiTietRow = donHangChiTietData[i];
            const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
            const donHangRow = donHangData.find(row => {
                return row[donHangColumnIndex['ma_don_hang']] === maDonHangID;
            });

            if (!donHangRow) continue;

            if (!passesFilterConditionsNhap(chiTietRow, donHangRow, chiTietColumnIndex, donHangColumnIndex, filterOptions)) {
                continue;
            }

            filteredResults.push({
                id: resultId++,
                chiTietRow: chiTietRow,
                donHangRow: donHangRow,
                chiTietColumnIndex: chiTietColumnIndex,
                donHangColumnIndex: donHangColumnIndex
            });
        }

        return filteredResults;
    }

    function passesFilterConditionsNhap(chiTietRow, donHangRow, chiTietColumnIndex, donHangColumnIndex, filterOptions) {
        const nhomSanPham = chiTietRow[chiTietColumnIndex['nhom_san_pham']] || '';
        const mauCua = chiTietRow[chiTietColumnIndex['mau_cua']] || '';
        const tenSanPham = chiTietRow[chiTietColumnIndex['ten_san_pham']] || '';
        const trongLuongPhuKien = donHangRow[donHangColumnIndex['trong_luong_phu_kien']] || '';
        const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';
        const donViPhuTrach = donHangRow[donHangColumnIndex['don_vi_phu_trach']] || '';
        const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
        const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
        const ngayNhapKho = donHangRow[donHangColumnIndex['ngay_nhap_kho']] || '';

        const excludedGroups = ["Vật tư phát sinh", "Vật tư khác", "Bảo hành", "Hàng hóa"];
        if (excludedGroups.includes(nhomSanPham)) {
            return false;
        }

        if (mauCua === "Nhân công") {
            return false;
        }

        if (tenSanPham === "Di chuyển" || tenSanPham === "Nhân công") {
            return false;
        }

        if (trongLuongPhuKien === "Tiêu chuẩn" && tenSanPham === "Vật tư khác") {
            return false;
        }

        // Lọc theo mã hợp đồng (multi-select)
        if (filterOptions.maHopDong && filterOptions.maHopDong.length > 0) {
            if (!filterOptions.maHopDong.includes(maHopDong)) {
                return false;
            }
        }

        // Lọc theo đơn vị phụ trách (multi-select)
        if (filterOptions.donViPhuTrach && filterOptions.donViPhuTrach.length > 0) {
            if (!filterOptions.donViPhuTrach.includes(donViPhuTrach)) {
                return false;
            }
        }

        if (filterOptions.tuNgay && filterOptions.denNgay) {
            const tuNgay = new Date(filterOptions.tuNgay);
            const denNgay = new Date(filterOptions.denNgay);

            tuNgay.setHours(0, 0, 0, 0);
            denNgay.setHours(23, 59, 59, 999);

            let ngaySoSanhStr;
            if (loaiDonHang === "Yêu cầu kiểm tra") {
                ngaySoSanhStr = ngayGiaoHang;
            } else {
                ngaySoSanhStr = ngayNhapKho;
            }

            const ngaySoSanh = parseDDMMYYYY(ngaySoSanhStr);
            if (!ngaySoSanh) {
                return false;
            }

            if (ngaySoSanh < tuNgay || ngaySoSanh > denNgay) {
                return false;
            }
        }

        if (filterOptions.loaiDonHang === "Tiêu chuẩn") {
            if (tenSanPham === "Vật tư khác" || trongLuongPhuKien !== "Tiêu chuẩn") {
                return false;
            }
        } else if (filterOptions.loaiDonHang === "Khác chuẩn") {
            if (trongLuongPhuKien !== "Khác chuẩn") {
                return false;
            }
        }

        return true;
    }


    function calculateThongTinCongTrinh(donHangRow, donHangColumnIndex) {
        const phuongThucBan = donHangRow[donHangColumnIndex['phuong_thuc_ban']] || '';
        const maNhanVien = donHangRow[donHangColumnIndex['ma_nhan_vien']] || '';
        const maKhachHang = donHangRow[donHangColumnIndex['ma_khach_hang']] || '';
        const tenNguoiLienHe = donHangRow[donHangColumnIndex['ten_nguoi_lien_he']] || '';
        const diaChiChiTiet = donHangRow[donHangColumnIndex['dia_chi_chi_tiet']] || '';
        const fileBaoGiaNPP = donHangRow[donHangColumnIndex['file_bao_gia_npp']] || '';
        const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';
        const maBoHang = donHangRow[donHangColumnIndex['ma_bo_hang']] || '';
        const tenKhachHangCuoi = donHangRow[donHangColumnIndex['ten_khach_hang_cuoi']] || '';
        const diaChiKhachHangCuoi = donHangRow[donHangColumnIndex['dia_chi_khach_hang_cuoi']] || '';

        const nguoiDung = lookupNguoiDungByMaNV[maNhanVien] || {};
        const donVi = nguoiDung.donVi || '';
        const maKhachHangFromLookup = lookupKhachHangById[maKhachHang] || '';
        const giaoHang = lookupGiaoHangByMaBoHang[maBoHang] || {};
        const loaiViec = giaoHang.loaiViec || '';
        const nguoiGiaoHang = giaoHang.nguoiGiaoHang || '';
        const nguoiGiaoHangInfo = lookupNguoiDungByMaNV[nguoiGiaoHang] || {};
        const tenNguoiGiaoHang = nguoiGiaoHangInfo.tenNV || '';

        let thongTin = '';

        if (phuongThucBan !== "Bán chéo") {
            thongTin = (donVi === "Quang Minh" ? maKhachHangFromLookup + " - " : "") +
                tenNguoiLienHe + " - " +
                diaChiChiTiet + " - " +
                fileBaoGiaNPP + " - " +
                maHopDong +
                (loaiViec === "Lắp đặt" ? " - " + tenNguoiGiaoHang : "");
        } else {
            thongTin = (donVi === "Quang Minh" ? maKhachHangFromLookup + " - " : "") +
                tenKhachHangCuoi + " - " +
                diaChiKhachHangCuoi + " - " +
                fileBaoGiaNPP + " - " +
                maHopDong +
                (loaiViec === "Lắp đặt" ? " - " + tenNguoiGiaoHang : "");
        }

        return thongTin;
    }

    function calculateMnvCongTy(donHangRow, donHangColumnIndex) {
        const donViPhuTrach = donHangRow[donHangColumnIndex['don_vi_phu_trach']] || '';
        const maNhanVien = donHangRow[donHangColumnIndex['ma_nhan_vien']] || '';
        const tenNhanVien = donHangRow[donHangColumnIndex['ten_nhan_vien']] || '';

        let mnvCongTy = '';

        if (["BP. BH1", "BP. BH2", "BP. Dịch vụ"].includes(donViPhuTrach)) {
            const nguoiDung = lookupNguoiDungByMaNV[maNhanVien] || {};
            mnvCongTy = nguoiDung.mnvCongTy || '';
        } else {
            const nguoiDung = lookupNguoiDungByTenNV[tenNhanVien] || {};
            if (nguoiDung.mnvCongTy) {
                mnvCongTy = nguoiDung.mnvCongTy;
            } else {
                mnvCongTy = "191002.0.1";
            }
        }

        return mnvCongTy;
    }

    function displayResultsNhap(results) {
        const resultsBody = document.getElementById('results-body-nhap');
        const resultsTable = document.getElementById('results-table-nhap');
        const noResults = document.getElementById('no-results-nhap');
        const resultsCount = document.getElementById('results-count-nhap');

        resultsCount.textContent = `Kết quả: ${results.length} dòng`;
        resultsBody.innerHTML = '';

        if (results.length === 0) {
            resultsTable.style.display = 'none';
            noResults.style.display = 'block';
            return;
        }

        noResults.style.display = 'none';
        resultsTable.style.display = 'table';

        results.forEach(result => {
            const chiTietRow = result.chiTietRow;
            const donHangRow = result.donHangRow;
            const chiTietColumnIndex = result.chiTietColumnIndex;
            const donHangColumnIndex = result.donHangColumnIndex;

            const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
            const maSanPhamTheoDoi = chiTietRow[chiTietColumnIndex['ma_san_pham_theo_doi']] || '';
            const dienGiai = chiTietRow[chiTietColumnIndex['dien_giai']] || '';
            const ghiChu = chiTietRow[chiTietColumnIndex['ghi_chu']] || '';
            const dvt = chiTietRow[chiTietColumnIndex['dvt']] || '';
            const khoiLuong = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['khoi_luong']] || '');
            const donGiaNPP = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['don_gia_npp']] || '');
            const giaBanNPP = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['gia_ban_npp']] || '');

            const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
            const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
            const ngayNhapKho = donHangRow[donHangColumnIndex['ngay_nhap_kho']] || '';
            const xuongSanXuat = donHangRow[donHangColumnIndex['xuong_san_xuat']] || '';
            const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';

            let ngayHaChToan = '';
            let ngayChungTu = '';

            if (loaiDonHang === "Yêu cầu kiểm tra") {
                ngayHaChToan = ngayGiaoHang;
                ngayChungTu = ngayGiaoHang;
            } else {
                ngayHaChToan = ngayNhapKho;
                ngayChungTu = ngayNhapKho;
            }

            let kho = '';
            if (xuongSanXuat === "Hà Nội") {
                kho = "K09.TP.CUA.HN";
            } else if (xuongSanXuat === "Long An") {
                kho = "K10.TP.CUA.LA";
            }

            let tenHang = '';
            if (dienGiai !== "") {
                tenHang = dienGiai;
            } else {
                tenHang = ghiChu;
            }

            const thongTinCongTrinh = calculateThongTinCongTrinh(donHangRow, donHangColumnIndex);
            const mnvCongTy = calculateMnvCongTy(donHangRow, donHangColumnIndex);

            const row = document.createElement('tr');
            row.innerHTML = `
    <td>${maDonHangID}</td>
    <td></td>
    <td>0</td>
    <td>${ngayHaChToan}</td>
    <td>${ngayChungTu}</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td>${thongTinCongTrinh}</td>
    <td>${mnvCongTy}</td>
    <td></td>
    <td>VND</td>
    <td></td>
    <td>${maSanPhamTheoDoi}</td>
    <td>${tenHang}</td>
    <td>${kho}</td>
    <td></td>
    <td>155</td>
    <td>154</td>
    <td>${dvt}</td>
    <td>${khoiLuong}</td>
    <td>${donGiaNPP}</td>
    <td>${giaBanNPP}</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td>${maSanPhamTheoDoi}</td>
    <td></td>
    <td>${maHopDong}</td>
    <td></td>
    <td></td>
    `;
            resultsBody.appendChild(row);
        });
    }

    async function exportToExcelNhap() {
        if (filteredResultsNhap.length === 0) {
            showMessageNhap('Không có dữ liệu để xuất. Vui lòng thực hiện lọc trước.', 'error');
            return;
        }

        try {
            // Tạo workbook mới
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Danh sách nhập kho');

            // Thêm tiêu đề cột
            const headers = [
                'ID', 'Hiển thị trên sổ', 'Loại nhập kho', 'Ngày hạch toán (*)',
                'Ngày chứng từ (*)', 'Số chứng từ (*)', 'Mã đối tượng', 'Tên đối tượng',
                'Người giao hàng', 'Diễn giải', 'Nhân viên bán hàng', 'Kèm theo',
                'Loại tiền', 'Tỷ giá', 'Mã hàng (*)', 'Tên hàng', 'Kho (*)',
                'Hàng hóa giữ hộ/bán hộ', 'TK Nợ (*)', 'TK Có (*)', 'ĐVT',
                'Số lượng', 'Đơn giá', 'Thành tiền', 'Thành tiền quy đổi',
                'Số lô', 'Hạn sử dụng', 'Khoản mục CP', 'Đơn vị', 'Đối tượng THCP',
                'Công trình', 'Đơn đặt hàng', 'Hợp đồng bán', 'Mã thống kê'
            ];

            worksheet.addRow(headers);

            // Định dạng tiêu đề
            const headerRow = worksheet.getRow(1);
            headerRow.font = { bold: true };
            headerRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFE0E0E0' }
            };

            // Điền dữ liệu
            filteredResultsNhap.forEach((result, index) => {
                const chiTietRow = result.chiTietRow;
                const donHangRow = result.donHangRow;
                const chiTietColumnIndex = result.chiTietColumnIndex;
                const donHangColumnIndex = result.donHangColumnIndex;

                const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
                const maSanPhamTheoDoi = chiTietRow[chiTietColumnIndex['ma_san_pham_theo_doi']] || '';
                const dienGiai = chiTietRow[chiTietColumnIndex['dien_giai']] || '';
                const ghiChu = chiTietRow[chiTietColumnIndex['ghi_chu']] || '';
                const dvt = chiTietRow[chiTietColumnIndex['dvt']] || '';
                const khoiLuong = formatNumberForCSV(chiTietRow[chiTietColumnIndex['khoi_luong']] || '');
                const donGiaNPP = formatNumberForCSV(chiTietRow[chiTietColumnIndex['don_gia_npp']] || '');
                const giaBanNPP = formatNumberForCSV(chiTietRow[chiTietColumnIndex['gia_ban_npp']] || '');

                const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
                const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
                const ngayNhapKho = donHangRow[donHangColumnIndex['ngay_nhap_kho']] || '';
                const xuongSanXuat = donHangRow[donHangColumnIndex['xuong_san_xuat']] || '';
                const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';

                let ngayHaChToan = '';
                let ngayChungTu = '';

                if (loaiDonHang === "Yêu cầu kiểm tra") {
                    ngayHaChToan = convertDateToExcelSerial(ngayGiaoHang);
                    ngayChungTu = convertDateToExcelSerial(ngayGiaoHang);
                } else {
                    ngayHaChToan = convertDateToExcelSerial(ngayNhapKho);
                    ngayChungTu = convertDateToExcelSerial(ngayNhapKho);
                }

                let kho = '';
                if (xuongSanXuat === "Hà Nội") {
                    kho = "K09.TP.CUA.HN";
                } else if (xuongSanXuat === "Long An") {
                    kho = "K10.TP.CUA.LA";
                }

                let tenHang = '';
                if (dienGiai !== "") {
                    tenHang = dienGiai;
                } else {
                    tenHang = ghiChu;
                }

                const thongTinCongTrinh = calculateThongTinCongTrinh(donHangRow, donHangColumnIndex);
                const mnvCongTy = calculateMnvCongTy(donHangRow, donHangColumnIndex);

                // Tạo dòng dữ liệu
                const rowData = [
                    maDonHangID, // ID
                    '', // Hiển thị trên sổ
                    0, // Loại nhập kho
                    ngayHaChToan, // Ngày hạch toán
                    ngayChungTu, // Ngày chứng từ
                    '', // Số chứng từ
                    '', // Mã đối tượng
                    '', // Tên đối tượng
                    '', // Người giao hàng
                    thongTinCongTrinh, // Diễn giải
                    mnvCongTy, // Nhân viên bán hàng
                    '', // Kèm theo
                    'VND', // Loại tiền
                    '', // Tỷ giá
                    maSanPhamTheoDoi, // Mã hàng
                    tenHang, // Tên hàng
                    kho, // Kho
                    '', // Hàng hóa giữ hộ/bán hộ
                    155, // TK Nợ
                    154, // TK Có
                    dvt, // ĐVT
                    khoiLuong, // Số lượng
                    donGiaNPP, // Đơn giá
                    giaBanNPP, // Thành tiền
                    '', // Thành tiền quy đổi
                    '', // Số lô
                    '', // Hạn sử dụng
                    '', // Khoản mục CP
                    '', // Đơn vị
                    maSanPhamTheoDoi, // Đối tượng THCP
                    '', // Công trình
                    maHopDong, // Đơn đặt hàng
                    '', // Hợp đồng bán
                    '' // Mã thống kê
                ];

                worksheet.addRow(rowData);
            });

            // Tự động điều chỉnh độ rộng cột
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    const cellLength = cell.value ? cell.value.toString().length : 10;
                    if (cellLength > maxLength) {
                        maxLength = cellLength;
                    }
                });
                column.width = maxLength < 10 ? 10 : maxLength + 2;
            });

            // Tạo tên file và tải về
            const tuNgayRaw = document.getElementById("tu-ngay-nhap").value;
            const denNgayRaw = document.getElementById("den-ngay-nhap").value;
            const tuNgay = formatDateForFilename(tuNgayRaw);
            const denNgay = formatDateForFilename(denNgayRaw);
            const loaiDonHang = document.querySelector('input[name="loai-don-hang-nhap"]:checked').value;

            const outputBuffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([outputBuffer], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const fileName = `Danh sách nhập kho - ${tuNgay} - ${denNgay} - ${loaiDonHang}.xlsx`;
            link.download = fileName;
            link.click();

            showMessageNhap(`Đã xuất ${filteredResultsNhap.length} dòng ra file Excel.`, 'success');

        } catch (error) {
            console.error('Lỗi xuất Excel:', error);
            showMessageNhap('Không thể xuất Excel. Vui lòng thử lại.', 'error');
        }
    }

    function showLoadingNhap(show) {
        const loadingElement = document.getElementById('loading-nhap');
        loadingElement.style.display = show ? 'block' : 'none';
    }

    function showMessageNhap(message, type) {
        const resultsCount = document.getElementById("results-count-nhap");
        resultsCount.className = "results-count";

        if (type === "success") {
            resultsCount.style.backgroundColor = "#e8f7e8";
            resultsCount.style.color = "#0c9c07";
            resultsCount.style.borderLeft = "4px solid #0c9c07";
        }

        if (type === "error") {
            resultsCount.style.backgroundColor = "#ffeaea";
            resultsCount.style.color = "#c00";
            resultsCount.style.borderLeft = "4px solid #c00";
        }

        resultsCount.style.padding = "5px";
        resultsCount.style.borderRadius = "6px";
        resultsCount.style.fontSize = "16px";
        resultsCount.style.fontWeight = "600";
        resultsCount.textContent = message;
    }

    function requireRefilterNhap() {
        document.getElementById('results-table-nhap').style.display = 'none';
        document.getElementById('no-results-nhap').style.display = 'block';
        document.getElementById('results-count-nhap').textContent = 'Kết quả: Chưa có dòng nào được lọc.';
        filteredResultsNhap = [];
        showMessageNhap("Bạn đã thay đổi bộ lọc. Vui lòng nhấn 'Lọc' để cập nhật kết quả mới.", "error");
    }

    // ==================== TAB XUẤT KHO ====================

    let filteredResultsXuat = [];

    function initXuatKhoEventListeners() {
        document.getElementById('btn-loc-xuat').addEventListener('click', applyFilterXuat);
        document.getElementById('btn-reset-xuat').addEventListener('click', resetFilterXuat);
        document.getElementById('btn-export-xuat').addEventListener('click', exportToExcelXuat);

        // Xóa event listener cho input text cũ
        // document.getElementById("ma-hop-dong-xuat").addEventListener("input", requireRefilterXuat);
        document.getElementById("tu-ngay-xuat").addEventListener("change", requireRefilterXuat);
        document.getElementById("den-ngay-xuat").addEventListener("change", requireRefilterXuat);

        document.querySelectorAll("input[name='loai-don-hang-xuat']").forEach(radio => {
            radio.addEventListener("change", requireRefilterXuat);
        });
    }

    function resetFilterXuat() {
        // Reset multi-select đơn vị phụ trách
        const donViAllCheckbox = document.getElementById('don-vi-phu-trach-xuat-all');
        if (donViAllCheckbox) {
            donViAllCheckbox.checked = true;
        }

        const donViCheckboxes = document.querySelectorAll('#don-vi-phu-trach-xuat-container input[type="checkbox"]:not(#don-vi-phu-trach-xuat-all)');
        donViCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        // Reset multi-select mã hợp đồng
        const maHopDongAllCheckbox = document.getElementById('ma-hop-dong-xuat-all');
        if (maHopDongAllCheckbox) {
            maHopDongAllCheckbox.checked = true;
        }

        const maHopDongCheckboxes = document.querySelectorAll('#ma-hop-dong-xuat-container input[type="checkbox"]:not(#ma-hop-dong-xuat-all)');
        maHopDongCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        document.getElementById('tu-ngay-xuat').value = '';
        document.getElementById('den-ngay-xuat').value = '';
        document.getElementById('loai-tat-ca-xuat').checked = true;

        document.getElementById('results-table-xuat').style.display = 'none';
        document.getElementById('no-results-xuat').style.display = 'block';
        document.getElementById('results-count-xuat').textContent = 'Kết quả: Chưa có dòng nào được lọc.';

        filteredResultsXuat = [];
    }

    async function applyFilterXuat() {
        showLoadingXuat(true);

        try {
            if (!isDataLoaded) {
                await fetchDataFromSheets();
            }

            const filterOptions = {
                maHopDong: getSelectedMaHopDong('-xuat'), // Lấy danh sách mã hợp đồng được chọn
                donViPhuTrach: getSelectedDonViPhuTrach('-xuat'), // Lấy danh sách đơn vị được chọn
                tuNgay: document.getElementById('tu-ngay-xuat').value,
                denNgay: document.getElementById('den-ngay-xuat').value,
                loaiDonHang: document.querySelector('input[name="loai-don-hang-xuat"]:checked').value
            };

            filteredResultsXuat = filterDataXuat(filterOptions);
            displayResultsXuat(filteredResultsXuat);
            showMessageXuat(`Đã tìm thấy ${filteredResultsXuat.length} dòng phù hợp.`, 'success');

        } catch (error) {
            console.error('Lỗi khi áp dụng bộ lọc:', error);
            showMessageXuat('Đã xảy ra lỗi khi tải dữ liệu. Vui lòng thử lại.', 'error');
        } finally {
            showLoadingXuat(false);
        }
    }

    function filterDataXuat(filterOptions) {
        if (donHangData.length === 0 || donHangChiTietData.length === 0) {
            return [];
        }

        const donHangHeaders = donHangData[0];
        const chiTietHeaders = donHangChiTietData[0];

        const donHangColumnIndex = {};
        donHangHeaders.forEach((header, index) => {
            donHangColumnIndex[header] = index;
        });

        const chiTietColumnIndex = {};
        chiTietHeaders.forEach((header, index) => {
            chiTietColumnIndex[header] = index;
        });

        const filteredResults = [];
        let resultId = 1;

        for (let i = 1; i < donHangChiTietData.length; i++) {
            const chiTietRow = donHangChiTietData[i];
            const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
            const donHangRow = donHangData.find(row => {
                return row[donHangColumnIndex['ma_don_hang']] === maDonHangID;
            });

            if (!donHangRow) continue;

            if (!passesFilterConditionsXuat(chiTietRow, donHangRow, chiTietColumnIndex, donHangColumnIndex, filterOptions)) {
                continue;
            }

            filteredResults.push({
                id: resultId++,
                chiTietRow: chiTietRow,
                donHangRow: donHangRow,
                chiTietColumnIndex: chiTietColumnIndex,
                donHangColumnIndex: donHangColumnIndex
            });
        }

        return filteredResults;
    }

    function passesFilterConditionsXuat(chiTietRow, donHangRow, chiTietColumnIndex, donHangColumnIndex, filterOptions) {
        const nhomSanPham = chiTietRow[chiTietColumnIndex['nhom_san_pham']] || '';
        const tenSanPham = chiTietRow[chiTietColumnIndex['ten_san_pham']] || '';
        const trongLuongPhuKien = donHangRow[donHangColumnIndex['trong_luong_phu_kien']] || '';
        const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';
        const donViPhuTrach = donHangRow[donHangColumnIndex['don_vi_phu_trach']] || '';
        const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
        const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
        const ngayXuatKho = donHangRow[donHangColumnIndex['ngay_xuat_kho']] || '';

        if (nhomSanPham === "Bảo hành") {
            return false;
        }

        if (trongLuongPhuKien === "Tiêu chuẩn" && tenSanPham === "Vật tư khác") {
            return false;
        }

        // Lọc theo mã hợp đồng (multi-select)
        if (filterOptions.maHopDong && filterOptions.maHopDong.length > 0) {
            if (!filterOptions.maHopDong.includes(maHopDong)) {
                return false;
            }
        }

        // Lọc theo đơn vị phụ trách (multi-select)
        if (filterOptions.donViPhuTrach && filterOptions.donViPhuTrach.length > 0) {
            if (!filterOptions.donViPhuTrach.includes(donViPhuTrach)) {
                return false;
            }
        }

        if (filterOptions.tuNgay && filterOptions.denNgay) {
            const tuNgay = new Date(filterOptions.tuNgay);
            const denNgay = new Date(filterOptions.denNgay);

            tuNgay.setHours(0, 0, 0, 0);
            denNgay.setHours(23, 59, 59, 999);

            let ngaySoSanhStr;
            if (loaiDonHang === "Yêu cầu kiểm tra") {
                ngaySoSanhStr = ngayGiaoHang;
            } else {
                ngaySoSanhStr = ngayXuatKho;
            }

            const ngaySoSanh = parseDDMMYYYY(ngaySoSanhStr);
            if (!ngaySoSanh) {
                return false;
            }

            if (ngaySoSanh < tuNgay || ngaySoSanh > denNgay) {
                return false;
            }
        }

        if (filterOptions.loaiDonHang === "Tiêu chuẩn") {
            if (tenSanPham === "Vật tư khác" || trongLuongPhuKien !== "Tiêu chuẩn") {
                return false;
            }
        } else if (filterOptions.loaiDonHang === "Khác chuẩn") {
            if (trongLuongPhuKien !== "Khác chuẩn") {
                return false;
            }
        }

        return true;
    }

    function calculateTaiKhoanKho(nhomSanPham, maSanPhamId) {
        const condition1 = (nhomSanPham !== "Vật tư phát sinh" && nhomSanPham !== "Vật tư khác");
        const condition2 = maSanPhamId && maSanPhamId.includes("*");

        if (condition1 || condition2) {
            return "155";
        } else if (nhomSanPham === "Hàng hóa") {
            return "156";
        } else {
            return "1521";
        }
    }

    function displayResultsXuat(results) {
        const resultsBody = document.getElementById('results-body-xuat');
        const resultsTable = document.getElementById('results-table-xuat');
        const noResults = document.getElementById('no-results-xuat');
        const resultsCount = document.getElementById('results-count-xuat');

        resultsCount.textContent = `Kết quả: ${results.length} dòng`;
        resultsBody.innerHTML = '';

        if (results.length === 0) {
            resultsTable.style.display = 'none';
            noResults.style.display = 'block';
            return;
        }

        noResults.style.display = 'none';
        resultsTable.style.display = 'table';

        results.forEach(result => {
            const chiTietRow = result.chiTietRow;
            const donHangRow = result.donHangRow;
            const chiTietColumnIndex = result.chiTietColumnIndex;
            const donHangColumnIndex = result.donHangColumnIndex;

            const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
            const maSanPhamTheoDoi = chiTietRow[chiTietColumnIndex['ma_san_pham_theo_doi']] || '';
            const dienGiai = chiTietRow[chiTietColumnIndex['dien_giai']] || '';
            const ghiChu = chiTietRow[chiTietColumnIndex['ghi_chu']] || '';
            const dvt = chiTietRow[chiTietColumnIndex['dvt']] || '';
            const khoiLuong = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['khoi_luong']] || '');
            const donGiaNPP = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['don_gia_npp']] || '');
            const giaBanNPP = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['gia_ban_npp']] || '');
            const trongLuongNhom = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['trong_luong_nhom']] || '');
            const viTriLapDat = chiTietRow[chiTietColumnIndex['vi_tri_lap_dat']] || '';
            const nhomSanPham = chiTietRow[chiTietColumnIndex['nhom_san_pham']] || '';
            const maSanPhamId = chiTietRow[chiTietColumnIndex['ma_san_pham_id']] || '';
            const taiKhoanKho = calculateTaiKhoanKho(nhomSanPham, maSanPhamId);

            const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
            const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
            const ngayXuatKho = donHangRow[donHangColumnIndex['ngay_xuat_kho']] || '';
            const xuongSanXuat = donHangRow[donHangColumnIndex['xuong_san_xuat']] || '';
            const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';
            const donViPhuTrach = donHangRow[donHangColumnIndex['don_vi_phu_trach']] || '';
            const maNhanVien = donHangRow[donHangColumnIndex['ma_nhan_vien']] || '';
            const maKhachHangID = donHangRow[donHangColumnIndex['ma_khach_hang']] || '';
            const tenNguoiLienHe = donHangRow[donHangColumnIndex['ten_nguoi_lien_he']] || '';
            const diaChi = donHangRow[donHangColumnIndex['dia_chi']] || '';
            const diaChiChiTiet = donHangRow[donHangColumnIndex['dia_chi_chi_tiet']] || '';
            const mucChietKhauNPP = formatNumberForDisplay(donHangRow[donHangColumnIndex['muc_chiet_khau_npp']] || '');
            const phiVanChuyenLapDatNPP = formatNumberForDisplay(donHangRow[donHangColumnIndex['phi_van_chuyen_lap_dat_npp']] || '');
            const soTienTTL1 = formatNumberForDisplay(donHangRow[donHangColumnIndex['so_tien_tt_l1']] || '');
            const soTienPhaiThanhToanNPP = formatNumberForDisplay(donHangRow[donHangColumnIndex['so_tien_phai_thanh_toan_npp']] || '');
            const fileBaoGiaNPP = donHangRow[donHangColumnIndex['file_bao_gia_npp']] || '';

            let ngayHaChToan = '';
            let ngayChungTu = '';

            if (loaiDonHang === "Yêu cầu kiểm tra") {
                ngayHaChToan = ngayGiaoHang;
                ngayChungTu = ngayGiaoHang;
            } else {
                ngayHaChToan = ngayXuatKho;
                ngayChungTu = ngayXuatKho;
            }

            let maKhachHang = '';
            let tenKhachHang = '';
            let diaChiHienThi = '';

            if (!["BP. BH1", "BP. BH2", "P. Bán hàng", "BP. Dịch vụ"].includes(donViPhuTrach)) {
                maKhachHang = maNhanVien.substring(0, 9);
                tenKhachHang = donViPhuTrach;
                diaChiHienThi = diaChi;
            } else {
                maKhachHang = lookupKhachHangById[maKhachHangID];
                tenKhachHang = tenNguoiLienHe;
                diaChiHienThi = diaChiChiTiet;
            }

            let tenHang = '';
            if (dienGiai !== "") {
                tenHang = dienGiai;
            } else {
                tenHang = ghiChu;
            }

            let kho = '';
            if (xuongSanXuat === "Hà Nội") {
                if (nhomSanPham !== "Vật tư phát sinh" && nhomSanPham !== "Vật tư khác") {
                    kho = "K09.TP.CUA.HN";
                } else {
                    kho = "K03_SX.HN_152";
                }
            } else if (xuongSanXuat === "Long An") {
                if (nhomSanPham !== "Vật tư phát sinh" && nhomSanPham !== "Vật tư khác") {
                    kho = "K10.TP.CUA.LA";
                } else {
                    kho = "K04_SX.LA_152";
                }
            }

            const thongTinCongTrinh = calculateThongTinCongTrinh(donHangRow, donHangColumnIndex);
            const mnvCongTy = calculateMnvCongTy(donHangRow, donHangColumnIndex);
            const ghiChuFull = `${viTriLapDat} - ${ghiChu}`;

            const row = document.createElement('tr');
            row.innerHTML = `
    <td>${maDonHangID}</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td>0</td>
    <td></td>
    <td>${ngayHaChToan}</td>
    <td>${ngayChungTu}</td>
    <td>${maHopDong}</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td>${maKhachHang}</td>
    <td>${tenKhachHang}</td>
    <td>${diaChiHienThi}</td>
    <td></td>
    <td>${thongTinCongTrinh}</td>
    <td></td>
    <td>${mnvCongTy}</td>
    <td>VND</td>
    <td></td>
    <td>${maSanPhamTheoDoi}</td>
    <td>${tenHang}</td>
    <td></td>
    <td>131</td>
    <td>511</td>
    <td>${dvt}</td>
    <td>${khoiLuong}</td>
    <td></td>
    <td>${donGiaNPP}</td>
    <td>${giaBanNPP}</td>
    <td></td>
    <td>${mucChietKhauNPP}</td>
    <td></td>
    <td></td>
    <td>5111Chietkhau</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td>${trongLuongNhom}</td>
    <td></td>
    <td></td>
    <td></td>
    <td>33311</td>
    <td></td>
    <td>${kho}</td>
    <td>632</td>
    <td>${taiKhoanKho}</td>
    <td></td>
    <td></td>
    <td></td>
    <td>${phiVanChuyenLapDatNPP}</td>
    <td>${soTienTTL1}</td>
    <td>${ghiChuFull}</td>
    <td>${soTienPhaiThanhToanNPP}</td>
    <td>${fileBaoGiaNPP}</td>
    `;
            resultsBody.appendChild(row);
        });
    }

    async function exportToExcelXuat() {
        if (filteredResultsXuat.length === 0) {
            showMessageXuat('Không có dữ liệu để xuất. Vui lòng thực hiện lọc trước.', 'error');
            return;
        }

        try {
            // Tạo workbook mới
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Danh sách xuất kho');

            // Thêm tiêu đề cột (theo header CSV cũ)
            const headers = [
                'ID', 'Hiển thị trên sổ', 'Hình thức bán hàng', 'Phương thức thanh toán',
                'Kiêm phiếu xuất kho', 'XK vào khu phi thuế quan và các TH được coi như XK',
                'Lập kèm hóa đơn', 'Đã lập hóa đơn', 'Ngày hạch toán (*)', 'Ngày chứng từ (*)',
                'Số chứng từ (*)', 'Số phiếu xuất', 'Lý do xuất', 'Mẫu số HĐ', 'Ký hiệu HĐ',
                'Số hóa đơn', 'Ngày hóa đơn', 'Mã khách hàng', 'Tên khách hàng', 'Địa chỉ',
                'Mã số thuế', 'Diễn giải', 'Nộp vào TK', 'NV bán hàng', 'Loại tiền', 'Tỷ giá',
                'Mã hàng (*)', 'Tên hàng', 'Hàng khuyến mại', 'TK Tiền/Chi phí/Nợ (*)',
                'TK Doanh thu/Có (*)', 'ĐVT', 'Số lượng', 'Đơn giá sau thuế', 'Đơn giá',
                'Thành tiền', 'Thành tiền quy đổi', 'Tỷ lệ CK (%)', 'Tiền chiết khấu',
                'Tiền chiết khấu quy đổi', 'TK chiết khấu', 'Giá tính thuế XK', '% thuế XK',
                'Tiền thuế XK', 'TK thuế XK', '% thuế GTGT', 'Tỷ lệ tính thuế (Thuế suất KHAC)',
                'Tiền thuế GTGT', 'Tiền thuế GTGT quy đổi', 'TK thuế GTGT',
                'HH không TH trên tờ khai thuế GTGT', 'Kho', 'TK giá vốn', 'TK Kho',
                'Đơn giá vốn', 'Tiền vốn', 'Hàng hóa giữ hộ/bán hộ', 'Phí vận chuyển lắp đặt',
                'Chi phí dịch vụ sơn yêu cầu', 'Ghi chú', 'Tổng số tiền', 'Kiểu thanh toán'
            ];

            worksheet.addRow(headers);

            // Định dạng tiêu đề
            const headerRow = worksheet.getRow(1);
            headerRow.font = { bold: true };
            headerRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFE0E0E0' }
            };

            // Điền dữ liệu
            filteredResultsXuat.forEach((result, index) => {
                const chiTietRow = result.chiTietRow;
                const donHangRow = result.donHangRow;
                const chiTietColumnIndex = result.chiTietColumnIndex;
                const donHangColumnIndex = result.donHangColumnIndex;

                const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
                const maSanPhamTheoDoi = chiTietRow[chiTietColumnIndex['ma_san_pham_theo_doi']] || '';
                const dienGiai = chiTietRow[chiTietColumnIndex['dien_giai']] || '';
                const ghiChu = chiTietRow[chiTietColumnIndex['ghi_chu']] || '';
                const dvt = chiTietRow[chiTietColumnIndex['dvt']] || '';
                const khoiLuong = formatNumberForCSV(chiTietRow[chiTietColumnIndex['khoi_luong']] || '');
                const donGiaNPP = formatNumberForCSV(chiTietRow[chiTietColumnIndex['don_gia_npp']] || '');
                const giaBanNPP = formatNumberForCSV(chiTietRow[chiTietColumnIndex['gia_ban_npp']] || '');
                const trongLuongNhom = formatNumberForCSV(chiTietRow[chiTietColumnIndex['trong_luong_nhom']] || '');
                const viTriLapDat = chiTietRow[chiTietColumnIndex['vi_tri_lap_dat']] || '';
                const nhomSanPham = chiTietRow[chiTietColumnIndex['nhom_san_pham']] || '';
                const maSanPhamId = chiTietRow[chiTietColumnIndex['ma_san_pham_id']] || '';
                const taiKhoanKho = calculateTaiKhoanKho(nhomSanPham, maSanPhamId);

                const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
                const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
                const ngayXuatKho = donHangRow[donHangColumnIndex['ngay_xuat_kho']] || '';
                const xuongSanXuat = donHangRow[donHangColumnIndex['xuong_san_xuat']] || '';
                const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';
                const donViPhuTrach = donHangRow[donHangColumnIndex['don_vi_phu_trach']] || '';
                const maNhanVien = donHangRow[donHangColumnIndex['ma_nhan_vien']] || '';
                const maKhachHangID = donHangRow[donHangColumnIndex['ma_khach_hang']] || '';
                const tenNguoiLienHe = donHangRow[donHangColumnIndex['ten_nguoi_lien_he']] || '';
                const diaChi = donHangRow[donHangColumnIndex['dia_chi']] || '';
                const diaChiChiTiet = donHangRow[donHangColumnIndex['dia_chi_chi_tiet']] || '';
                const mucChietKhauNPP = formatNumberForCSV(donHangRow[donHangColumnIndex['muc_chiet_khau_npp']] || '');
                const phiVanChuyenLapDatNPP = formatNumberForCSV(donHangRow[donHangColumnIndex['phi_van_chuyen_lap_dat_npp']] || '');
                const soTienTTL1 = formatNumberForCSV(donHangRow[donHangColumnIndex['so_tien_tt_l1']] || '');
                const soTienPhaiThanhToanNPP = formatNumberForCSV(donHangRow[donHangColumnIndex['so_tien_phai_thanh_toan_npp']] || '');
                const fileBaoGiaNPP = donHangRow[donHangColumnIndex['file_bao_gia_npp']] || '';

                let ngayHaChToan = '';
                let ngayChungTu = '';

                if (loaiDonHang === "Yêu cầu kiểm tra") {
                    ngayHaChToan = convertDateToExcelSerial(ngayGiaoHang);
                    ngayChungTu = convertDateToExcelSerial(ngayGiaoHang);
                } else {
                    ngayHaChToan = convertDateToExcelSerial(ngayXuatKho);
                    ngayChungTu = convertDateToExcelSerial(ngayXuatKho);
                }

                let maKhachHang = '';
                let tenKhachHang = '';
                let diaChiHienThi = '';

                if (!["BP. BH1", "BP. BH2", "P. Bán hàng", "BP. Dịch vụ"].includes(donViPhuTrach)) {
                    maKhachHang = maNhanVien.substring(0, 9);
                    tenKhachHang = donViPhuTrach;
                    diaChiHienThi = diaChi;
                } else {
                    maKhachHang = lookupKhachHangById[maKhachHangID];
                    tenKhachHang = tenNguoiLienHe;
                    diaChiHienThi = diaChiChiTiet;
                }

                let tenHang = '';
                if (dienGiai !== "") {
                    tenHang = dienGiai;
                } else {
                    tenHang = ghiChu;
                }

                let kho = '';
                if (xuongSanXuat === "Hà Nội") {
                    if (nhomSanPham !== "Vật tư phát sinh" && nhomSanPham !== "Vật tư khác") {
                        kho = "K09.TP.CUA.HN";
                    } else {
                        kho = "K03_SX.HN_152";
                    }
                } else if (xuongSanXuat === "Long An") {
                    if (nhomSanPham !== "Vật tư phát sinh" && nhomSanPham !== "Vật tư khác") {
                        kho = "K10.TP.CUA.LA";
                    } else {
                        kho = "K04_SX.LA_152";
                    }
                }

                const thongTinCongTrinh = calculateThongTinCongTrinh(donHangRow, donHangColumnIndex);
                const mnvCongTy = calculateMnvCongTy(donHangRow, donHangColumnIndex);
                const ghiChuFull = `${viTriLapDat} - ${ghiChu}`;

                // Tạo dòng dữ liệu
                const rowData = [
                    maDonHangID, // ID
                    '', // Hiển thị trên sổ
                    '', // Hình thức bán hàng
                    '', // Phương thức thanh toán
                    '', // Kiêm phiếu xuất kho
                    '', // XK vào khu phi thuế quan
                    0, // Lập kèm hóa đơn
                    '', // Đã lập hóa đơn
                    ngayHaChToan, // Ngày hạch toán
                    ngayChungTu, // Ngày chứng từ
                    maHopDong, // Số chứng từ
                    '', // Số phiếu xuất
                    '', // Lý do xuất
                    '', // Mẫu số HĐ
                    '', // Ký hiệu HĐ
                    '', // Số hóa đơn
                    '', // Ngày hóa đơn
                    maKhachHang, // Mã khách hàng
                    tenKhachHang, // Tên khách hàng
                    diaChiHienThi, // Địa chỉ
                    '', // Mã số thuế
                    thongTinCongTrinh, // Diễn giải
                    '', // Nộp vào TK
                    mnvCongTy, // NV bán hàng
                    'VND', // Loại tiền
                    '', // Tỷ giá
                    maSanPhamTheoDoi, // Mã hàng
                    tenHang, // Tên hàng
                    '', // Hàng khuyến mại
                    131, // TK Nợ
                    511, // TK Có
                    dvt, // ĐVT
                    khoiLuong, // Số lượng
                    '', // Đơn giá sau thuế
                    donGiaNPP, // Đơn giá
                    giaBanNPP, // Thành tiền
                    '', // Thành tiền quy đổi
                    mucChietKhauNPP, // Tỷ lệ CK (%)
                    '', // Tiền chiết khấu
                    '', // Tiền chiết khấu quy đổi
                    '5111Chietkhau', // TK chiết khấu
                    '', // Giá tính thuế XK
                    '', // % thuế XK
                    '', // Tiền thuế XK
                    '', // TK thuế XK
                    trongLuongNhom, // % thuế GTGT
                    '', // Tỷ lệ tính thuế
                    '', // Tiền thuế GTGT
                    '', // Tiền thuế GTGT quy đổi
                    33311, // TK thuế GTGT
                    '', // HH không TH
                    kho, // Kho
                    632, // TK giá vốn
                    taiKhoanKho, // TK Kho
                    '', // Đơn giá vốn
                    '', // Tiền vốn
                    '', // Hàng hóa giữ hộ/bán hộ
                    phiVanChuyenLapDatNPP, // Phí vận chuyển lắp đặt
                    soTienTTL1, // Chi phí dịch vụ sơn
                    ghiChuFull, // Ghi chú
                    soTienPhaiThanhToanNPP, // Tổng số tiền
                    fileBaoGiaNPP // Kiểu thanh toán
                ];

                worksheet.addRow(rowData);
            });

            // Tự động điều chỉnh độ rộng cột
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    const cellLength = cell.value ? cell.value.toString().length : 10;
                    if (cellLength > maxLength) {
                        maxLength = cellLength;
                    }
                });
                column.width = maxLength < 10 ? 10 : maxLength + 2;
            });

            // Tạo tên file và tải về
            const tuNgayRaw = document.getElementById("tu-ngay-xuat").value;
            const denNgayRaw = document.getElementById("den-ngay-xuat").value;
            const tuNgay = formatDateForFilename(tuNgayRaw);
            const denNgay = formatDateForFilename(denNgayRaw);
            const loaiDonHang = document.querySelector('input[name="loai-don-hang-xuat"]:checked').value;

            const outputBuffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([outputBuffer], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const fileName = `Danh sách xuất kho - ${tuNgay} - ${denNgay} - ${loaiDonHang}.xlsx`;
            link.download = fileName;
            link.click();

            showMessageXuat(`Đã xuất ${filteredResultsXuat.length} dòng ra file Excel.`, 'success');

        } catch (error) {
            console.error('Lỗi xuất Excel:', error);
            showMessageXuat('Không thể xuất Excel. Vui lòng thử lại.', 'error');
        }
    }

    function showLoadingXuat(show) {
        const loadingElement = document.getElementById('loading-xuat');
        loadingElement.style.display = show ? 'block' : 'none';
    }

    function showMessageXuat(message, type) {
        const resultsCount = document.getElementById("results-count-xuat");
        resultsCount.className = "results-count";

        if (type === "success") {
            resultsCount.style.backgroundColor = "#e8f7e8";
            resultsCount.style.color = "#0c9c07";
            resultsCount.style.borderLeft = "4px solid #0c9c07";
        }

        if (type === "error") {
            resultsCount.style.backgroundColor = "#ffeaea";
            resultsCount.style.color = "#c00";
            resultsCount.style.borderLeft = "4px solid #c00";
        }

        resultsCount.style.padding = "5px";
        resultsCount.style.borderRadius = "6px";
        resultsCount.style.fontSize = "16px";
        resultsCount.style.fontWeight = "600";
        resultsCount.textContent = message;
    }

    function requireRefilterXuat() {
        document.getElementById('results-table-xuat').style.display = 'none';
        document.getElementById('no-results-xuat').style.display = 'block';
        document.getElementById('results-count-xuat').textContent = 'Kết quả: Chưa có dòng nào được lọc.';
        filteredResultsXuat = [];
        showMessageXuat("Bạn đã thay đổi bộ lọc. Vui lòng nhấn 'Lọc' để cập nhật kết quả mới.", "error");
    }

    // ==================== TAB LỆNH SẢN XUẤT ====================

    let filteredResultsLenSanXuat = [];

    function initLenSanXuatEventListeners() {
        document.getElementById('btn-loc-lsx').addEventListener('click', applyFilterLenSanXuat);
        document.getElementById('btn-reset-lsx').addEventListener('click', resetFilterLenSanXuat);
        document.getElementById('btn-export-lsx').addEventListener('click', exportToExcelLenSanXuat);

        // Xóa event listener cho input text cũ
        // document.getElementById("ma-hop-dong-lsx").addEventListener("input", requireRefilterLenSanXuat);
        document.getElementById("xuong-san-xuat-lsx").addEventListener("change", requireRefilterLenSanXuat);
        document.getElementById("tu-ngay-lsx").addEventListener("change", requireRefilterLenSanXuat);
        document.getElementById("den-ngay-lsx").addEventListener("change", requireRefilterLenSanXuat);

        document.querySelectorAll("input[name='loai-don-hang-lsx']").forEach(radio => {
            radio.addEventListener("change", requireRefilterLenSanXuat);
        });
    }

    function resetFilterLenSanXuat() {
        // Reset multi-select đơn vị phụ trách
        const donViAllCheckbox = document.getElementById('don-vi-phu-trach-lsx-all');
        if (donViAllCheckbox) {
            donViAllCheckbox.checked = true;
        }

        const donViCheckboxes = document.querySelectorAll('#don-vi-phu-trach-lsx-container input[type="checkbox"]:not(#don-vi-phu-trach-lsx-all)');
        donViCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        // Reset multi-select mã hợp đồng
        const maHopDongAllCheckbox = document.getElementById('ma-hop-dong-lsx-all');
        if (maHopDongAllCheckbox) {
            maHopDongAllCheckbox.checked = true;
        }

        const maHopDongCheckboxes = document.querySelectorAll('#ma-hop-dong-lsx-container input[type="checkbox"]:not(#ma-hop-dong-lsx-all)');
        maHopDongCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        document.getElementById('xuong-san-xuat-lsx').value = '';
        document.getElementById('tu-ngay-lsx').value = '';
        document.getElementById('den-ngay-lsx').value = '';
        document.getElementById('loai-tat-ca-lsx').checked = true;

        document.getElementById('results-table-lsx').style.display = 'none';
        document.getElementById('no-results-lsx').style.display = 'block';
        document.getElementById('results-count-lsx').textContent = 'Kết quả: Chưa có dòng nào được lọc.';

        filteredResultsLenSanXuat = [];
    }

    async function applyFilterLenSanXuat() {
        showLoadingLenSanXuat(true);

        try {
            if (!isDataLoaded) {
                await fetchDataFromSheets();
            }

            const filterOptions = {
                maHopDong: getSelectedMaHopDong('-lsx'), // Lấy danh sách mã hợp đồng được chọn
                donViPhuTrach: getSelectedDonViPhuTrach('-lsx'), // Lấy danh sách đơn vị được chọn
                xuongSanXuat: document.getElementById('xuong-san-xuat-lsx').value,
                tuNgay: document.getElementById('tu-ngay-lsx').value,
                denNgay: document.getElementById('den-ngay-lsx').value,
                loaiDonHang: document.querySelector('input[name="loai-don-hang-lsx"]:checked').value
            };

            filteredResultsLenSanXuat = filterDataLenSanXuat(filterOptions);
            displayResultsLenSanXuat(filteredResultsLenSanXuat);
            showMessageLenSanXuat(`Đã tìm thấy ${filteredResultsLenSanXuat.length} dòng phù hợp.`, 'success');

        } catch (error) {
            console.error('Lỗi khi áp dụng bộ lọc:', error);
            showMessageLenSanXuat('Đã xảy ra lỗi khi tải dữ liệu. Vui lòng thử lại.', 'error');
        } finally {
            showLoadingLenSanXuat(false);
        }
    }

    function filterDataLenSanXuat(filterOptions) {
        if (donHangData.length === 0 || donHangChiTietData.length === 0) {
            return [];
        }

        const donHangHeaders = donHangData[0];
        const chiTietHeaders = donHangChiTietData[0];

        const donHangColumnIndex = {};
        donHangHeaders.forEach((header, index) => {
            donHangColumnIndex[header] = index;
        });

        const chiTietColumnIndex = {};
        chiTietHeaders.forEach((header, index) => {
            chiTietColumnIndex[header] = index;
        });

        const filteredResults = [];
        let resultId = 1;

        for (let i = 1; i < donHangChiTietData.length; i++) {
            const chiTietRow = donHangChiTietData[i];
            const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
            const donHangRow = donHangData.find(row => {
                return row[donHangColumnIndex['ma_don_hang']] === maDonHangID;
            });

            if (!donHangRow) continue;

            if (!passesFilterConditionsLenSanXuat(chiTietRow, donHangRow, chiTietColumnIndex, donHangColumnIndex, filterOptions)) {
                continue;
            }

            filteredResults.push({
                id: resultId++,
                chiTietRow: chiTietRow,
                donHangRow: donHangRow,
                chiTietColumnIndex: chiTietColumnIndex,
                donHangColumnIndex: donHangColumnIndex
            });
        }

        return filteredResults;
    }

    function passesFilterConditionsLenSanXuat(chiTietRow, donHangRow, chiTietColumnIndex, donHangColumnIndex, filterOptions) {
        const nhomSanPham = chiTietRow[chiTietColumnIndex['nhom_san_pham']] || '';
        const mauCua = chiTietRow[chiTietColumnIndex['mau_cua']] || '';
        const tenSanPham = chiTietRow[chiTietColumnIndex['ten_san_pham']] || '';
        const trongLuongPhuKien = donHangRow[donHangColumnIndex['trong_luong_phu_kien']] || '';
        const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';
        const donViPhuTrach = donHangRow[donHangColumnIndex['don_vi_phu_trach']] || '';
        const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
        const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
        const ngayNhapKho = donHangRow[donHangColumnIndex['ngay_nhap_kho']] || '';
        const xuongSanXuat = donHangRow[donHangColumnIndex['xuong_san_xuat']] || '';

        // Loại bỏ các nhóm sản phẩm không mong muốn
        const excludedGroups = ["Vật tư phát sinh", "Vật tư khác", "Bảo hành", "Hàng hóa"];
        if (excludedGroups.includes(nhomSanPham)) {
            return false;
        }

        if (mauCua === "Nhân công") {
            return false;
        }

        if (tenSanPham === "Di chuyển" || tenSanPham === "Nhân công") {
            return false;
        }

        // Lọc theo mã hợp đồng (multi-select)
        if (filterOptions.maHopDong && filterOptions.maHopDong.length > 0) {
            if (!filterOptions.maHopDong.includes(maHopDong)) {
                return false;
            }
        }

        // Lọc theo đơn vị phụ trách (multi-select)
        if (filterOptions.donViPhuTrach && filterOptions.donViPhuTrach.length > 0) {
            if (!filterOptions.donViPhuTrach.includes(donViPhuTrach)) {
                return false;
            }
        }

        // Lọc theo ngày
        if (filterOptions.tuNgay && filterOptions.denNgay) {
            const tuNgay = new Date(filterOptions.tuNgay);
            const denNgay = new Date(filterOptions.denNgay);

            tuNgay.setHours(0, 0, 0, 0);
            denNgay.setHours(23, 59, 59, 999);

            let ngaySoSanhStr;
            if (loaiDonHang === "Yêu cầu kiểm tra") {
                ngaySoSanhStr = ngayGiaoHang;
            } else {
                ngaySoSanhStr = ngayNhapKho;
            }

            const ngaySoSanh = parseDDMMYYYY(ngaySoSanhStr);
            if (!ngaySoSanh) {
                return false;
            }

            if (ngaySoSanh < tuNgay || ngaySoSanh > denNgay) {
                return false;
            }
        }

        // Lọc theo loại đơn hàng
        if (filterOptions.loaiDonHang === "Tiêu chuẩn") {
            if (tenSanPham === "Vật tư khác" || trongLuongPhuKien !== "Tiêu chuẩn") {
                return false;
            }
        } else if (filterOptions.loaiDonHang === "Khác chuẩn") {
            if (trongLuongPhuKien !== "Khác chuẩn") {
                return false;
            }
        }

        // Lọc theo xưởng sản xuất
        if (filterOptions.xuongSanXuat && xuongSanXuat !== filterOptions.xuongSanXuat) {
            return false;
        }

        return true;
    }

    function displayResultsLenSanXuat(results) {
        const resultsBody = document.getElementById('results-body-lsx');
        const resultsTable = document.getElementById('results-table-lsx');
        const noResults = document.getElementById('no-results-lsx');
        const resultsCount = document.getElementById('results-count-lsx');

        resultsCount.textContent = `Kết quả: ${results.length} dòng`;
        resultsBody.innerHTML = '';

        if (results.length === 0) {
            resultsTable.style.display = 'none';
            noResults.style.display = 'block';
            return;
        }

        noResults.style.display = 'none';
        resultsTable.style.display = 'table';

        results.forEach(result => {
            const chiTietRow = result.chiTietRow;
            const donHangRow = result.donHangRow;
            const chiTietColumnIndex = result.chiTietColumnIndex;
            const donHangColumnIndex = result.donHangColumnIndex;

            const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
            const maSanPhamTheoDoi = chiTietRow[chiTietColumnIndex['ma_san_pham_theo_doi']] || '';
            const dienGiai = chiTietRow[chiTietColumnIndex['dien_giai']] || '';
            const ghiChu = chiTietRow[chiTietColumnIndex['ghi_chu']] || '';
            const dvt = chiTietRow[chiTietColumnIndex['dvt']] || '';
            const soLuong = chiTietRow[chiTietColumnIndex['so_luong']] || '';
            const khoiLuong = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['khoi_luong']] || '');
            const sttTrongDon = chiTietRow[chiTietColumnIndex['stt_trong_don']] || '';

            const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
            const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
            const ngayNhapKho = donHangRow[donHangColumnIndex['ngay_nhap_kho']] || '';
            const xuongSanXuat = donHangRow[donHangColumnIndex['xuong_san_xuat']] || '';
            const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';

            let ngayHaChToan = '';
            let ngayChungTu = '';

            if (loaiDonHang === "Yêu cầu kiểm tra") {
                ngayHaChToan = ngayGiaoHang;
                ngayChungTu = ngayGiaoHang;
            } else {
                ngayHaChToan = ngayNhapKho;
                ngayChungTu = ngayNhapKho;
            }

            let tenHang = '';
            if (dienGiai !== "") {
                tenHang = dienGiai;
            } else {
                tenHang = ghiChu;
            }

            const mnvCongTy = calculateMnvCongTy(donHangRow, donHangColumnIndex);

            // Xác định kho dựa trên xưởng sản xuất
            let kho = '';
            if (xuongSanXuat === "Hà Nội") {
                kho = "K03_SX.HN_152";
            } else if (xuongSanXuat === "Long An") {
                kho = "K04_SX.LA_152";
            }

            // Xác định đối tượng THCP dựa trên xưởng sản xuất
            let doiTuongTHCP = '';
            if (xuongSanXuat === "Hà Nội") {
                doiTuongTHCP = "25.SXT.X1";
            } else if (xuongSanXuat === "Long An") {
                doiTuongTHCP = "25.SXT.X2";
            }

            // Lấy các trường m_vt, kt_m_vt, sl_m_vt (từ 1 đến 20)
            const m_vt_1 = chiTietRow[chiTietColumnIndex['m_vt_1']] || '';
            const kt_m_vt_1 = chiTietRow[chiTietColumnIndex['kt_m_vt_1']] || '';
            const sl_m_vt_1 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_1']] || '');
            const m_vt_2 = chiTietRow[chiTietColumnIndex['m_vt_2']] || '';
            const kt_m_vt_2 = chiTietRow[chiTietColumnIndex['kt_m_vt_2']] || '';
            const sl_m_vt_2 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_2']] || '');
            const m_vt_3 = chiTietRow[chiTietColumnIndex['m_vt_3']] || '';
            const kt_m_vt_3 = chiTietRow[chiTietColumnIndex['kt_m_vt_3']] || '';
            const sl_m_vt_3 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_3']] || '');
            const m_vt_4 = chiTietRow[chiTietColumnIndex['m_vt_4']] || '';
            const kt_m_vt_4 = chiTietRow[chiTietColumnIndex['kt_m_vt_4']] || '';
            const sl_m_vt_4 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_4']] || '');
            const m_vt_5 = chiTietRow[chiTietColumnIndex['m_vt_5']] || '';
            const kt_m_vt_5 = chiTietRow[chiTietColumnIndex['kt_m_vt_5']] || '';
            const sl_m_vt_5 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_5']] || '');
            const m_vt_6 = chiTietRow[chiTietColumnIndex['m_vt_6']] || '';
            const kt_m_vt_6 = chiTietRow[chiTietColumnIndex['kt_m_vt_6']] || '';
            const sl_m_vt_6 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_6']] || '');
            const m_vt_7 = chiTietRow[chiTietColumnIndex['m_vt_7']] || '';
            const kt_m_vt_7 = chiTietRow[chiTietColumnIndex['kt_m_vt_7']] || '';
            const sl_m_vt_7 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_7']] || '');
            const m_vt_8 = chiTietRow[chiTietColumnIndex['m_vt_8']] || '';
            const kt_m_vt_8 = chiTietRow[chiTietColumnIndex['kt_m_vt_8']] || '';
            const sl_m_vt_8 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_8']] || '');
            const m_vt_9 = chiTietRow[chiTietColumnIndex['m_vt_9']] || '';
            const kt_m_vt_9 = chiTietRow[chiTietColumnIndex['kt_m_vt_9']] || '';
            const sl_m_vt_9 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_9']] || '');
            const m_vt_10 = chiTietRow[chiTietColumnIndex['m_vt_10']] || '';
            const kt_m_vt_10 = chiTietRow[chiTietColumnIndex['kt_m_vt_10']] || '';
            const sl_m_vt_10 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_10']] || '');
            const m_vt_11 = chiTietRow[chiTietColumnIndex['m_vt_11']] || '';
            const kt_m_vt_11 = chiTietRow[chiTietColumnIndex['kt_m_vt_11']] || '';
            const sl_m_vt_11 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_11']] || '');
            const m_vt_12 = chiTietRow[chiTietColumnIndex['m_vt_12']] || '';
            const kt_m_vt_12 = chiTietRow[chiTietColumnIndex['kt_m_vt_12']] || '';
            const sl_m_vt_12 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_12']] || '');
            const m_vt_13 = chiTietRow[chiTietColumnIndex['m_vt_13']] || '';
            const kt_m_vt_13 = chiTietRow[chiTietColumnIndex['kt_m_vt_13']] || '';
            const sl_m_vt_13 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_13']] || '');
            const m_vt_14 = chiTietRow[chiTietColumnIndex['m_vt_14']] || '';
            const kt_m_vt_14 = chiTietRow[chiTietColumnIndex['kt_m_vt_14']] || '';
            const sl_m_vt_14 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_14']] || '');
            const m_vt_15 = chiTietRow[chiTietColumnIndex['m_vt_15']] || '';
            const kt_m_vt_15 = chiTietRow[chiTietColumnIndex['kt_m_vt_15']] || '';
            const sl_m_vt_15 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_15']] || '');
            const m_vt_16 = chiTietRow[chiTietColumnIndex['m_vt_16']] || '';
            const kt_m_vt_16 = chiTietRow[chiTietColumnIndex['kt_m_vt_16']] || '';
            const sl_m_vt_16 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_16']] || '');
            const m_vt_17 = chiTietRow[chiTietColumnIndex['m_vt_17']] || '';
            const kt_m_vt_17 = chiTietRow[chiTietColumnIndex['kt_m_vt_17']] || '';
            const sl_m_vt_17 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_17']] || '');
            const m_vt_18 = chiTietRow[chiTietColumnIndex['m_vt_18']] || '';
            const kt_m_vt_18 = chiTietRow[chiTietColumnIndex['kt_m_vt_18']] || '';
            const sl_m_vt_18 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_18']] || '');
            const m_vt_19 = chiTietRow[chiTietColumnIndex['m_vt_19']] || '';
            const kt_m_vt_19 = chiTietRow[chiTietColumnIndex['kt_m_vt_19']] || '';
            const sl_m_vt_19 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_19']] || '');
            const m_vt_20 = chiTietRow[chiTietColumnIndex['m_vt_20']] || '';
            const kt_m_vt_20 = chiTietRow[chiTietColumnIndex['kt_m_vt_20']] || '';
            const sl_m_vt_20 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_20']] || '');

            // Lấy các trường m2_vt, kt1_m2_vt, kt2_m2_vt, sl_m2_vt (1 đến 2)
            const m2_vt_1 = chiTietRow[chiTietColumnIndex['m2_vt_1']] || '';
            const kt1_m2_vt_1 = chiTietRow[chiTietColumnIndex['kt1_m2_vt_1']] || '';
            const kt2_m2_vt_1 = chiTietRow[chiTietColumnIndex['kt2_m2_vt_1']] || '';
            const sl_m2_vt_1 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m2_vt_1']] || '');
            const m2_vt_2 = chiTietRow[chiTietColumnIndex['m2_vt_2']] || '';
            const kt1_m2_vt_2 = chiTietRow[chiTietColumnIndex['kt1_m2_vt_2']] || '';
            const kt2_m2_vt_2 = chiTietRow[chiTietColumnIndex['kt2_m2_vt_2']] || '';
            const sl_m2_vt_2 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m2_vt_2']] || '');

            // Lấy các trường c_vt, sl_c_vt (1 đến 30)
            const c_vt_1 = chiTietRow[chiTietColumnIndex['c_vt_1']] || '';
            const sl_c_vt_1 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_1']] || '');
            const c_vt_2 = chiTietRow[chiTietColumnIndex['c_vt_2']] || '';
            const sl_c_vt_2 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_2']] || '');
            const c_vt_3 = chiTietRow[chiTietColumnIndex['c_vt_3']] || '';
            const sl_c_vt_3 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_3']] || '');
            const c_vt_4 = chiTietRow[chiTietColumnIndex['c_vt_4']] || '';
            const sl_c_vt_4 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_4']] || '');
            const c_vt_5 = chiTietRow[chiTietColumnIndex['c_vt_5']] || '';
            const sl_c_vt_5 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_5']] || '');
            const c_vt_6 = chiTietRow[chiTietColumnIndex['c_vt_6']] || '';
            const sl_c_vt_6 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_6']] || '');
            const c_vt_7 = chiTietRow[chiTietColumnIndex['c_vt_7']] || '';
            const sl_c_vt_7 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_7']] || '');
            const c_vt_8 = chiTietRow[chiTietColumnIndex['c_vt_8']] || '';
            const sl_c_vt_8 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_8']] || '');
            const c_vt_9 = chiTietRow[chiTietColumnIndex['c_vt_9']] || '';
            const sl_c_vt_9 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_9']] || '');
            const c_vt_10 = chiTietRow[chiTietColumnIndex['c_vt_10']] || '';
            const sl_c_vt_10 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_10']] || '');
            const c_vt_11 = chiTietRow[chiTietColumnIndex['c_vt_11']] || '';
            const sl_c_vt_11 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_11']] || '');
            const c_vt_12 = chiTietRow[chiTietColumnIndex['c_vt_12']] || '';
            const sl_c_vt_12 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_12']] || '');
            const c_vt_13 = chiTietRow[chiTietColumnIndex['c_vt_13']] || '';
            const sl_c_vt_13 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_13']] || '');
            const c_vt_14 = chiTietRow[chiTietColumnIndex['c_vt_14']] || '';
            const sl_c_vt_14 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_14']] || '');
            const c_vt_15 = chiTietRow[chiTietColumnIndex['c_vt_15']] || '';
            const sl_c_vt_15 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_15']] || '');
            const c_vt_16 = chiTietRow[chiTietColumnIndex['c_vt_16']] || '';
            const sl_c_vt_16 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_16']] || '');
            const c_vt_17 = chiTietRow[chiTietColumnIndex['c_vt_17']] || '';
            const sl_c_vt_17 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_17']] || '');
            const c_vt_18 = chiTietRow[chiTietColumnIndex['c_vt_18']] || '';
            const sl_c_vt_18 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_18']] || '');
            const c_vt_19 = chiTietRow[chiTietColumnIndex['c_vt_19']] || '';
            const sl_c_vt_19 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_19']] || '');
            const c_vt_20 = chiTietRow[chiTietColumnIndex['c_vt_20']] || '';
            const sl_c_vt_20 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_20']] || '');
            const c_vt_21 = chiTietRow[chiTietColumnIndex['c_vt_21']] || '';
            const sl_c_vt_21 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_21']] || '');
            const c_vt_22 = chiTietRow[chiTietColumnIndex['c_vt_22']] || '';
            const sl_c_vt_22 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_22']] || '');
            const c_vt_23 = chiTietRow[chiTietColumnIndex['c_vt_23']] || '';
            const sl_c_vt_23 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_23']] || '');
            const c_vt_24 = chiTietRow[chiTietColumnIndex['c_vt_24']] || '';
            const sl_c_vt_24 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_24']] || '');
            const c_vt_25 = chiTietRow[chiTietColumnIndex['c_vt_25']] || '';
            const sl_c_vt_25 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_25']] || '');
            const c_vt_26 = chiTietRow[chiTietColumnIndex['c_vt_26']] || '';
            const sl_c_vt_26 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_26']] || '');
            const c_vt_27 = chiTietRow[chiTietColumnIndex['c_vt_27']] || '';
            const sl_c_vt_27 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_27']] || '');
            const c_vt_28 = chiTietRow[chiTietColumnIndex['c_vt_28']] || '';
            const sl_c_vt_28 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_28']] || '');
            const c_vt_29 = chiTietRow[chiTietColumnIndex['c_vt_29']] || '';
            const sl_c_vt_29 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_29']] || '');
            const c_vt_30 = chiTietRow[chiTietColumnIndex['c_vt_30']] || '';
            const sl_c_vt_30 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_30']] || '');

            // Tạo hàng với các cột theo yêu cầu
            const row = document.createElement('tr');
            row.innerHTML = `
    <td>${maDonHangID}</td>
    <td>${sttTrongDon}</td>
    <td>1</td>
    <td>${ngayHaChToan}</td>
    <td>${ngayChungTu}</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td>Xuất kho NVL sản xuất cho Lệnh sản xuất <${maHopDong}></td>
    <td>${mnvCongTy}</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td>${ghiChu}</td>
    <td>${kho}</td>
    <td></td>
    <td>154</td>
    <td>1521</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td>${doiTuongTHCP}</td>
    <td>${maSanPhamTheoDoi}</td>
    <td></td>
    <td>${maHopDong}</td>
    <td></td>
    <td></td>
    <td></td>
    <td>${m_vt_1}</td>
    <td>${kt_m_vt_1}</td>
    <td>${sl_m_vt_1}</td>
    <td>${m_vt_2}</td>
    <td>${kt_m_vt_2}</td>
    <td>${sl_m_vt_2}</td>
    <td>${m_vt_3}</td>
    <td>${kt_m_vt_3}</td>
    <td>${sl_m_vt_3}</td>
    <td>${m_vt_4}</td>
    <td>${kt_m_vt_4}</td>
    <td>${sl_m_vt_4}</td>
    <td>${m_vt_5}</td>
    <td>${kt_m_vt_5}</td>
    <td>${sl_m_vt_5}</td>
    <td>${m_vt_6}</td>
    <td>${kt_m_vt_6}</td>
    <td>${sl_m_vt_6}</td>
    <td>${m_vt_7}</td>
    <td>${kt_m_vt_7}</td>
    <td>${sl_m_vt_7}</td>
    <td>${m_vt_8}</td>
    <td>${kt_m_vt_8}</td>
    <td>${sl_m_vt_8}</td>
    <td>${m_vt_9}</td>
    <td>${kt_m_vt_9}</td>
    <td>${sl_m_vt_9}</td>
    <td>${m_vt_10}</td>
    <td>${kt_m_vt_10}</td>
    <td>${sl_m_vt_10}</td>
    <td>${m_vt_11}</td>
    <td>${kt_m_vt_11}</td>
    <td>${sl_m_vt_11}</td>
    <td>${m_vt_12}</td>
    <td>${kt_m_vt_12}</td>
    <td>${sl_m_vt_12}</td>
    <td>${m_vt_13}</td>
    <td>${kt_m_vt_13}</td>
    <td>${sl_m_vt_13}</td>
    <td>${m_vt_14}</td>
    <td>${kt_m_vt_14}</td>
    <td>${sl_m_vt_14}</td>
    <td>${m_vt_15}</td>
    <td>${kt_m_vt_15}</td>
    <td>${sl_m_vt_15}</td>
    <td>${m_vt_16}</td>
    <td>${kt_m_vt_16}</td>
    <td>${sl_m_vt_16}</td>
    <td>${m_vt_17}</td>
    <td>${kt_m_vt_17}</td>
    <td>${sl_m_vt_17}</td>
    <td>${m_vt_18}</td>
    <td>${kt_m_vt_18}</td>
    <td>${sl_m_vt_18}</td>
    <td>${m_vt_19}</td>
    <td>${kt_m_vt_19}</td>
    <td>${sl_m_vt_19}</td>
    <td>${m_vt_20}</td>
    <td>${kt_m_vt_20}</td>
    <td>${sl_m_vt_20}</td>
    <td>${m2_vt_1}</td>
    <td>${kt1_m2_vt_1}</td>
    <td>${kt2_m2_vt_1}</td>
    <td>${sl_m2_vt_1}</td>
    <td>${m2_vt_2}</td>
    <td>${kt1_m2_vt_2}</td>
    <td>${kt2_m2_vt_2}</td>
    <td>${sl_m2_vt_2}</td>
    <td>${c_vt_1}</td>
    <td>${sl_c_vt_1}</td>
    <td>${c_vt_2}</td>
    <td>${sl_c_vt_2}</td>
    <td>${c_vt_3}</td>
    <td>${sl_c_vt_3}</td>
    <td>${c_vt_4}</td>
    <td>${sl_c_vt_4}</td>
    <td>${c_vt_5}</td>
    <td>${sl_c_vt_5}</td>
    <td>${c_vt_6}</td>
    <td>${sl_c_vt_6}</td>
    <td>${c_vt_7}</td>
    <td>${sl_c_vt_7}</td>
    <td>${c_vt_8}</td>
    <td>${sl_c_vt_8}</td>
    <td>${c_vt_9}</td>
    <td>${sl_c_vt_9}</td>
    <td>${c_vt_10}</td>
    <td>${sl_c_vt_10}</td>
    <td>${c_vt_11}</td>
    <td>${sl_c_vt_11}</td>
    <td>${c_vt_12}</td>
    <td>${sl_c_vt_12}</td>
    <td>${c_vt_13}</td>
    <td>${sl_c_vt_13}</td>
    <td>${c_vt_14}</td>
    <td>${sl_c_vt_14}</td>
    <td>${c_vt_15}</td>
    <td>${sl_c_vt_15}</td>
    <td>${c_vt_16}</td>
    <td>${sl_c_vt_16}</td>
    <td>${c_vt_17}</td>
    <td>${sl_c_vt_17}</td>
    <td>${c_vt_18}</td>
    <td>${sl_c_vt_18}</td>
    <td>${c_vt_19}</td>
    <td>${sl_c_vt_19}</td>
    <td>${c_vt_20}</td>
    <td>${sl_c_vt_20}</td>
    <td>${c_vt_21}</td>
    <td>${sl_c_vt_21}</td>
    <td>${c_vt_22}</td>
    <td>${sl_c_vt_22}</td>
    <td>${c_vt_23}</td>
    <td>${sl_c_vt_23}</td>
    <td>${c_vt_24}</td>
    <td>${sl_c_vt_24}</td>
    <td>${c_vt_25}</td>
    <td>${sl_c_vt_25}</td>
    <td>${c_vt_26}</td>
    <td>${sl_c_vt_26}</td>
    <td>${c_vt_27}</td>
    <td>${sl_c_vt_27}</td>
    <td>${c_vt_28}</td>
    <td>${sl_c_vt_28}</td>
    <td>${c_vt_29}</td>
    <td>${sl_c_vt_29}</td>
    <td>${c_vt_30}</td>
    <td>${sl_c_vt_30}</td>
    <td>${soLuong}</td>
    `;
            resultsBody.appendChild(row);
        });
    }

    async function exportToExcelLenSanXuat() {
        if (filteredResultsLenSanXuat.length === 0) {
            showMessageLenSanXuat('Không có dữ liệu để xuất. Vui lòng thực hiện lọc trước.', 'error');
            return;
        }

        try {
            // Tạo workbook mới
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Danh sách lệnh sản xuất');

            // Thêm tiêu đề cột (theo header CSV cũ)
            const headers = [
                'ID', 'Hiển thị trên sổ', 'Loại xuất kho', 'Ngày hạch toán (*)', 'Ngày chứng từ (*)',
                'Số chứng từ (*)', 'Mẫu số HĐ', 'Ký hiệu HĐ', 'Mã đối tượng', 'Tên đối tượng',
                'Địa chỉ/Bộ phận', 'Tên người nhận/Của', 'Lý do xuất/Về việc', 'Nhân viên bán hàng',
                'Kèm theo', 'Số lệnh điều động', 'Ngày lệnh điều động', 'Người vận chuyển',
                'Tên người vận chuyển', 'Hợp đồng số', 'Phương tiện vận chuyển', 'Xuất tại kho',
                'Địa chỉ kho xuất', 'Nhập tại chi nhánh', 'Tên chi nhánh', 'MST chi nhánh',
                'Nhập tại kho', 'Địa chỉ kho nhập', 'Mã hàng (*)', 'Tên hàng', 'Là hàng khuyến mại',
                'Kho (*)', 'Hàng hóa giữ hộ/bán hộ', 'TK Nợ (*)', 'TK Có (*)', 'ĐVT', 'Số lượng',
                'Đơn giá bán', 'Thành tiền', 'Đơn giá vốn', 'Tiền vốn', 'Số lô', 'Hạn sử dụng',
                'Đối tượng', 'Khoản mục CP', 'Đơn vị', 'Đối tượng THCP', 'Công trình', 'Đơn đặt hàng',
                'Hợp đồng bán', 'CP không hợp lý', 'Mã thống kê', 'm_vt_1', 'kt_m_vt_1', 'sl_m_vt_1',
                'm_vt_2', 'kt_m_vt_2', 'sl_m_vt_2', 'm_vt_3', 'kt_m_vt_3', 'sl_m_vt_3', 'm_vt_4',
                'kt_m_vt_4', 'sl_m_vt_4', 'm_vt_5', 'kt_m_vt_5', 'sl_m_vt_5', 'm_vt_6', 'kt_m_vt_6',
                'sl_m_vt_6', 'm_vt_7', 'kt_m_vt_7', 'sl_m_vt_7', 'm_vt_8', 'kt_m_vt_8', 'sl_m_vt_8',
                'm_vt_9', 'kt_m_vt_9', 'sl_m_vt_9', 'm_vt_10', 'kt_m_vt_10', 'sl_m_vt_10', 'm_vt_11',
                'kt_m_vt_11', 'sl_m_vt_11', 'm_vt_12', 'kt_m_vt_12', 'sl_m_vt_12', 'm_vt_13',
                'kt_m_vt_13', 'sl_m_vt_13', 'm_vt_14', 'kt_m_vt_14', 'sl_m_vt_14', 'm_vt_15',
                'kt_m_vt_15', 'sl_m_vt_15', 'm_vt_16', 'kt_m_vt_16', 'sl_m_vt_16', 'm_vt_17',
                'kt_m_vt_17', 'sl_m_vt_17', 'm_vt_18', 'kt_m_vt_18', 'sl_m_vt_18', 'm_vt_19',
                'kt_m_vt_19', 'sl_m_vt_19', 'm_vt_20', 'kt_m_vt_20', 'sl_m_vt_20', 'm2_vt_1',
                'kt1_m2_vt_1', 'kt2_m2_vt_1', 'sl_m2_vt_1', 'm2_vt_2', 'kt1_m2_vt_2', 'kt2_m2_vt_2',
                'sl_m2_vt_2', 'c_vt_1', 'sl_c_vt_1', 'c_vt_2', 'sl_c_vt_2', 'c_vt_3', 'sl_c_vt_3',
                'c_vt_4', 'sl_c_vt_4', 'c_vt_5', 'sl_c_vt_5', 'c_vt_6', 'sl_c_vt_6', 'c_vt_7',
                'sl_c_vt_7', 'c_vt_8', 'sl_c_vt_8', 'c_vt_9', 'sl_c_vt_9', 'c_vt_10', 'sl_c_vt_10',
                'c_vt_11', 'sl_c_vt_11', 'c_vt_12', 'sl_c_vt_12', 'c_vt_13', 'sl_c_vt_13', 'c_vt_14',
                'sl_c_vt_14', 'c_vt_15', 'sl_c_vt_15', 'c_vt_16', 'sl_c_vt_16', 'c_vt_17',
                'sl_c_vt_17', 'c_vt_18', 'sl_c_vt_18', 'c_vt_19', 'sl_c_vt_19', 'c_vt_20',
                'sl_c_vt_20', 'c_vt_21', 'sl_c_vt_21', 'c_vt_22', 'sl_c_vt_22', 'c_vt_23',
                'sl_c_vt_23', 'c_vt_24', 'sl_c_vt_24', 'c_vt_25', 'sl_c_vt_25', 'c_vt_26',
                'sl_c_vt_26', 'c_vt_27', 'sl_c_vt_27', 'c_vt_28', 'sl_c_vt_28', 'c_vt_29',
                'sl_c_vt_29', 'c_vt_30', 'sl_c_vt_30', 'Số bộ'
            ];

            worksheet.addRow(headers);

            // Định dạng tiêu đề
            const headerRow = worksheet.getRow(1);
            headerRow.font = { bold: true };
            headerRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFE0E0E0' }
            };

            // Điền dữ liệu
            filteredResultsLenSanXuat.forEach((result, index) => {
                const chiTietRow = result.chiTietRow;
                const donHangRow = result.donHangRow;
                const chiTietColumnIndex = result.chiTietColumnIndex;
                const donHangColumnIndex = result.donHangColumnIndex;

                // Lấy các giá trị cần thiết
                const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
                const sttTrongDon = chiTietRow[chiTietColumnIndex['stt_trong_don']] || '';
                const maSanPhamTheoDoi = chiTietRow[chiTietColumnIndex['ma_san_pham_theo_doi']] || '';
                const dienGiai = chiTietRow[chiTietColumnIndex['dien_giai']] || '';
                const ghiChu = chiTietRow[chiTietColumnIndex['ghi_chu']] || '';
                const dvt = chiTietRow[chiTietColumnIndex['dvt']] || '';
                const soLuong = chiTietRow[chiTietColumnIndex['so_luong']] || '';
                const khoiLuong = formatNumberForCSV(chiTietRow[chiTietColumnIndex['khoi_luong']] || '');

                const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
                const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
                const ngayNhapKho = donHangRow[donHangColumnIndex['ngay_nhap_kho']] || '';
                const xuongSanXuat = donHangRow[donHangColumnIndex['xuong_san_xuat']] || '';
                const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';

                let ngayHaChToan = '';
                let ngayChungTu = '';

                if (loaiDonHang === "Yêu cầu kiểm tra") {
                    ngayHaChToan = convertDateToExcelSerial(ngayGiaoHang);
                    ngayChungTu = convertDateToExcelSerial(ngayGiaoHang);
                } else {
                    ngayHaChToan = convertDateToExcelSerial(ngayNhapKho);
                    ngayChungTu = convertDateToExcelSerial(ngayNhapKho);
                }

                const mnvCongTy = calculateMnvCongTy(donHangRow, donHangColumnIndex);

                // Xác định kho và đối tượng THCP
                let kho = '';
                let doiTuongTHCP = '';
                if (xuongSanXuat === "Hà Nội") {
                    kho = "K03_SX.HN_152";
                    doiTuongTHCP = "25.SXT.X1";
                } else if (xuongSanXuat === "Long An") {
                    kho = "K04_SX.LA_152";
                    doiTuongTHCP = "25.SXT.X2";
                }

                // Lấy tất cả các trường bổ sung (m_vt, m2_vt, c_vt)
                const getValue = (fieldName) => chiTietRow[chiTietColumnIndex[fieldName]] || '';
                const getNumberValue = (fieldName) => formatNumberForCSV(getValue(fieldName));

                // Tạo dòng dữ liệu (vì có quá nhiều cột, tôi sẽ tạo mảng dữ liệu)
                const rowData = [
                    maDonHangID, // ID
                    sttTrongDon, // Hiển thị trên sổ
                    1, // Loại xuất kho
                    ngayHaChToan, // Ngày hạch toán
                    ngayChungTu, // Ngày chứng từ
                    '', // Số chứng từ
                    '', // Mẫu số HĐ
                    '', // Ký hiệu HĐ
                    '', // Mã đối tượng
                    '', // Tên đối tượng
                    '', // Địa chỉ/Bộ phận
                    '', // Tên người nhận/Của
                    `Xuất kho NVL sản xuất cho Lệnh sản xuất <${maHopDong}>`, // Lý do xuất/Về việc
                    mnvCongTy, // Nhân viên bán hàng
                    '', // Kèm theo
                    '', // Số lệnh điều động
                    '', // Ngày lệnh điều động
                    '', // Người vận chuyển
                    '', // Tên người vận chuyển
                    '', // Hợp đồng số
                    '', // Phương tiện vận chuyển
                    '', // Xuất tại kho
                    '', // Địa chỉ kho xuất
                    '', // Nhập tại chi nhánh
                    '', // Tên chi nhánh
                    '', // MST chi nhánh
                    '', // Nhập tại kho
                    '', // Địa chỉ kho nhập
                    '', // Mã hàng
                    '', // Tên hàng
                    ghiChu, // Là hàng khuyến mại
                    kho, // Kho
                    '', // Hàng hóa giữ hộ/bán hộ
                    154, // TK Nợ
                    1521, // TK Có
                    '', // ĐVT
                    '', // Số lượng
                    '', // Đơn giá bán
                    '', // Thành tiền
                    '', // Đơn giá vốn
                    '', // Tiền vốn
                    '', // Số lô
                    '', // Hạn sử dụng
                    '', // Đối tượng
                    '', // Khoản mục CP
                    doiTuongTHCP, // Đơn vị
                    maSanPhamTheoDoi, // Đối tượng THCP
                    '', // Công trình
                    maHopDong, // Đơn đặt hàng
                    '', // Hợp đồng bán
                    '', // CP không hợp lý
                    '', // Mã thống kê
                    // Các trường m_vt (1-20)
                    getValue('m_vt_1'), getValue('kt_m_vt_1'), getNumberValue('sl_m_vt_1'),
                    getValue('m_vt_2'), getValue('kt_m_vt_2'), getNumberValue('sl_m_vt_2'),
                    getValue('m_vt_3'), getValue('kt_m_vt_3'), getNumberValue('sl_m_vt_3'),
                    getValue('m_vt_4'), getValue('kt_m_vt_4'), getNumberValue('sl_m_vt_4'),
                    getValue('m_vt_5'), getValue('kt_m_vt_5'), getNumberValue('sl_m_vt_5'),
                    getValue('m_vt_6'), getValue('kt_m_vt_6'), getNumberValue('sl_m_vt_6'),
                    getValue('m_vt_7'), getValue('kt_m_vt_7'), getNumberValue('sl_m_vt_7'),
                    getValue('m_vt_8'), getValue('kt_m_vt_8'), getNumberValue('sl_m_vt_8'),
                    getValue('m_vt_9'), getValue('kt_m_vt_9'), getNumberValue('sl_m_vt_9'),
                    getValue('m_vt_10'), getValue('kt_m_vt_10'), getNumberValue('sl_m_vt_10'),
                    getValue('m_vt_11'), getValue('kt_m_vt_11'), getNumberValue('sl_m_vt_11'),
                    getValue('m_vt_12'), getValue('kt_m_vt_12'), getNumberValue('sl_m_vt_12'),
                    getValue('m_vt_13'), getValue('kt_m_vt_13'), getNumberValue('sl_m_vt_13'),
                    getValue('m_vt_14'), getValue('kt_m_vt_14'), getNumberValue('sl_m_vt_14'),
                    getValue('m_vt_15'), getValue('kt_m_vt_15'), getNumberValue('sl_m_vt_15'),
                    getValue('m_vt_16'), getValue('kt_m_vt_16'), getNumberValue('sl_m_vt_16'),
                    getValue('m_vt_17'), getValue('kt_m_vt_17'), getNumberValue('sl_m_vt_17'),
                    getValue('m_vt_18'), getValue('kt_m_vt_18'), getNumberValue('sl_m_vt_18'),
                    getValue('m_vt_19'), getValue('kt_m_vt_19'), getNumberValue('sl_m_vt_19'),
                    getValue('m_vt_20'), getValue('kt_m_vt_20'), getNumberValue('sl_m_vt_20'),
                    // Các trường m2_vt (1-2)
                    getValue('m2_vt_1'), getValue('kt1_m2_vt_1'), getValue('kt2_m2_vt_1'), getNumberValue('sl_m2_vt_1'),
                    getValue('m2_vt_2'), getValue('kt1_m2_vt_2'), getValue('kt2_m2_vt_2'), getNumberValue('sl_m2_vt_2'),
                    // Các trường c_vt (1-30)
                    getValue('c_vt_1'), getNumberValue('sl_c_vt_1'),
                    getValue('c_vt_2'), getNumberValue('sl_c_vt_2'),
                    getValue('c_vt_3'), getNumberValue('sl_c_vt_3'),
                    getValue('c_vt_4'), getNumberValue('sl_c_vt_4'),
                    getValue('c_vt_5'), getNumberValue('sl_c_vt_5'),
                    getValue('c_vt_6'), getNumberValue('sl_c_vt_6'),
                    getValue('c_vt_7'), getNumberValue('sl_c_vt_7'),
                    getValue('c_vt_8'), getNumberValue('sl_c_vt_8'),
                    getValue('c_vt_9'), getNumberValue('sl_c_vt_9'),
                    getValue('c_vt_10'), getNumberValue('sl_c_vt_10'),
                    getValue('c_vt_11'), getNumberValue('sl_c_vt_11'),
                    getValue('c_vt_12'), getNumberValue('sl_c_vt_12'),
                    getValue('c_vt_13'), getNumberValue('sl_c_vt_13'),
                    getValue('c_vt_14'), getNumberValue('sl_c_vt_14'),
                    getValue('c_vt_15'), getNumberValue('sl_c_vt_15'),
                    getValue('c_vt_16'), getNumberValue('sl_c_vt_16'),
                    getValue('c_vt_17'), getNumberValue('sl_c_vt_17'),
                    getValue('c_vt_18'), getNumberValue('sl_c_vt_18'),
                    getValue('c_vt_19'), getNumberValue('sl_c_vt_19'),
                    getValue('c_vt_20'), getNumberValue('sl_c_vt_20'),
                    getValue('c_vt_21'), getNumberValue('sl_c_vt_21'),
                    getValue('c_vt_22'), getNumberValue('sl_c_vt_22'),
                    getValue('c_vt_23'), getNumberValue('sl_c_vt_23'),
                    getValue('c_vt_24'), getNumberValue('sl_c_vt_24'),
                    getValue('c_vt_25'), getNumberValue('sl_c_vt_25'),
                    getValue('c_vt_26'), getNumberValue('sl_c_vt_26'),
                    getValue('c_vt_27'), getNumberValue('sl_c_vt_27'),
                    getValue('c_vt_28'), getNumberValue('sl_c_vt_28'),
                    getValue('c_vt_29'), getNumberValue('sl_c_vt_29'),
                    getValue('c_vt_30'), getNumberValue('sl_c_vt_30'),
                    soLuong // Số bộ
                ];

                worksheet.addRow(rowData);
            });

            // Tự động điều chỉnh độ rộng cột
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    const cellLength = cell.value ? cell.value.toString().length : 10;
                    if (cellLength > maxLength) {
                        maxLength = cellLength;
                    }
                });
                column.width = maxLength < 10 ? 10 : maxLength + 2;
            });

            // Tạo tên file và tải về
            const tuNgayRaw = document.getElementById("tu-ngay-lsx").value;
            const denNgayRaw = document.getElementById("den-ngay-lsx").value;
            const tuNgay = formatDateForFilename(tuNgayRaw);
            const denNgay = formatDateForFilename(denNgayRaw);
            const loaiDonHang = document.querySelector('input[name="loai-don-hang-lsx"]:checked').value;

            const outputBuffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([outputBuffer], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const fileName = `Danh sách lệnh sản xuất - ${tuNgay} - ${denNgay} - ${loaiDonHang}.xlsx`;
            link.download = fileName;
            link.click();

            showMessageLenSanXuat(`Đã xuất ${filteredResultsLenSanXuat.length} dòng ra file Excel.`, 'success');

        } catch (error) {
            console.error('Lỗi xuất Excel:', error);
            showMessageLenSanXuat('Không thể xuất Excel. Vui lòng thử lại.', 'error');
        }
    }

    function showLoadingLenSanXuat(show) {
        const loadingElement = document.getElementById('loading-lsx');
        loadingElement.style.display = show ? 'block' : 'none';
    }

    function showMessageLenSanXuat(message, type) {
        const resultsCount = document.getElementById("results-count-lsx");
        resultsCount.className = "results-count";

        if (type === "success") {
            resultsCount.style.backgroundColor = "#e8f7e8";
            resultsCount.style.color = "#0c9c07";
            resultsCount.style.borderLeft = "4px solid #0c9c07";
        }

        if (type === "error") {
            resultsCount.style.backgroundColor = "#ffeaea";
            resultsCount.style.color = "#c00";
            resultsCount.style.borderLeft = "4px solid #c00";
        }

        resultsCount.style.padding = "5px";
        resultsCount.style.borderRadius = "6px";
        resultsCount.style.fontSize = "16px";
        resultsCount.style.fontWeight = "600";
        resultsCount.textContent = message;
    }

    function requireRefilterLenSanXuat() {
        document.getElementById('results-table-lsx').style.display = 'none';
        document.getElementById('no-results-lsx').style.display = 'block';
        document.getElementById('results-count-lsx').textContent = 'Kết quả: Chưa có dòng nào được lọc.';
        filteredResultsLenSanXuat = [];
        showMessageLenSanXuat("Bạn đã thay đổi bộ lọc. Vui lòng nhấn 'Lọc' để cập nhật kết quả mới.", "error");
    }

    // ==================== TAB LỆNH XUẤT VẬT TƯ BẢO HÀNH ====================

    let filteredResultsXuatBaoHanh = [];

    function initXuatBaoHanhEventListeners() {
        document.getElementById('btn-loc-xbh').addEventListener('click', applyFilterXuatBaoHanh);
        document.getElementById('btn-reset-xbh').addEventListener('click', resetFilterXuatBaoHanh);
        document.getElementById('btn-export-xbh').addEventListener('click', exportToExcelXuatBaoHanh);

        // Xóa event listener cho input text cũ
        // document.getElementById("ma-hop-dong-xbh").addEventListener("input", requireRefilterXuatBaoHanh);
        document.getElementById("xuong-san-xuat-xbh").addEventListener("change", requireRefilterXuatBaoHanh);
        document.getElementById("tu-ngay-xbh").addEventListener("change", requireRefilterXuatBaoHanh);
        document.getElementById("den-ngay-xbh").addEventListener("change", requireRefilterXuatBaoHanh);

        document.querySelectorAll("input[name='loai-don-hang-xbh']").forEach(radio => {
            radio.addEventListener("change", requireRefilterXuatBaoHanh);
        });
    }
    function resetFilterXuatBaoHanh() {
        // Reset multi-select đơn vị phụ trách
        const donViAllCheckbox = document.getElementById('don-vi-phu-trach-xbh-all');
        if (donViAllCheckbox) {
            donViAllCheckbox.checked = true;
        }

        const donViCheckboxes = document.querySelectorAll('#don-vi-phu-trach-xbh-container input[type="checkbox"]:not(#don-vi-phu-trach-xbh-all)');
        donViCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        // Reset multi-select mã hợp đồng
        const maHopDongAllCheckbox = document.getElementById('ma-hop-dong-xbh-all');
        if (maHopDongAllCheckbox) {
            maHopDongAllCheckbox.checked = true;
        }

        const maHopDongCheckboxes = document.querySelectorAll('#ma-hop-dong-xbh-container input[type="checkbox"]:not(#ma-hop-dong-xbh-all)');
        maHopDongCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        document.getElementById('xuong-san-xuat-xbh').value = '';
        document.getElementById('tu-ngay-xbh').value = '';
        document.getElementById('den-ngay-xbh').value = '';
        document.getElementById('loai-tat-ca-xbh').checked = true;

        document.getElementById('results-table-xbh').style.display = 'none';
        document.getElementById('no-results-xbh').style.display = 'block';
        document.getElementById('results-count-xbh').textContent = 'Kết quả: Chưa có dòng nào được lọc.';

        filteredResultsXuatBaoHanh = [];
    }

    async function applyFilterXuatBaoHanh() {
        showLoadingXuatBaoHanh(true);

        try {
            if (!isDataLoaded) {
                await fetchDataFromSheets();
            }

            const filterOptions = {
                maHopDong: getSelectedMaHopDong('-xbh'), // Lấy danh sách mã hợp đồng được chọn
                donViPhuTrach: getSelectedDonViPhuTrach('-xbh'), // Lấy danh sách đơn vị được chọn
                xuongSanXuat: document.getElementById('xuong-san-xuat-xbh').value,
                tuNgay: document.getElementById('tu-ngay-xbh').value,
                denNgay: document.getElementById('den-ngay-xbh').value,
                loaiDonHang: document.querySelector('input[name="loai-don-hang-xbh"]:checked').value
            };

            filteredResultsXuatBaoHanh = filterDataXuatBaoHanh(filterOptions);
            displayResultsXuatBaoHanh(filteredResultsXuatBaoHanh);
            showMessageXuatBaoHanh(`Đã tìm thấy ${filteredResultsXuatBaoHanh.length} dòng phù hợp.`, 'success');

        } catch (error) {
            console.error('Lỗi khi áp dụng bộ lọc:', error);
            showMessageXuatBaoHanh('Đã xảy ra lỗi khi tải dữ liệu. Vui lòng thử lại.', 'error');
        } finally {
            showLoadingXuatBaoHanh(false);
        }
    }

    function filterDataXuatBaoHanh(filterOptions) {
        if (donHangData.length === 0 || donHangChiTietData.length === 0) {
            return [];
        }

        const donHangHeaders = donHangData[0];
        const chiTietHeaders = donHangChiTietData[0];

        const donHangColumnIndex = {};
        donHangHeaders.forEach((header, index) => {
            donHangColumnIndex[header] = index;
        });

        const chiTietColumnIndex = {};
        chiTietHeaders.forEach((header, index) => {
            chiTietColumnIndex[header] = index;
        });

        const filteredResults = [];
        let resultId = 1;

        for (let i = 1; i < donHangChiTietData.length; i++) {
            const chiTietRow = donHangChiTietData[i];
            const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
            const donHangRow = donHangData.find(row => {
                return row[donHangColumnIndex['ma_don_hang']] === maDonHangID;
            });

            if (!donHangRow) continue;

            if (!passesFilterConditionsXuatBaoHanh(chiTietRow, donHangRow, chiTietColumnIndex, donHangColumnIndex, filterOptions)) {
                continue;
            }

            filteredResults.push({
                id: resultId++,
                chiTietRow: chiTietRow,
                donHangRow: donHangRow,
                chiTietColumnIndex: chiTietColumnIndex,
                donHangColumnIndex: donHangColumnIndex
            });
        }

        return filteredResults;
    }

    function passesFilterConditionsXuatBaoHanh(chiTietRow, donHangRow, chiTietColumnIndex, donHangColumnIndex, filterOptions) {
        // Tab xuất bảo hành thường chỉ lọc các dòng thuộc nhóm "Bảo hành"
        const nhomSanPham = chiTietRow[chiTietColumnIndex['nhom_san_pham']] || '';
        const mauCua = chiTietRow[chiTietColumnIndex['mau_cua']] || '';
        const tenSanPham = chiTietRow[chiTietColumnIndex['ten_san_pham']] || '';
        const trongLuongPhuKien = donHangRow[donHangColumnIndex['trong_luong_phu_kien']] || '';
        const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';
        const donViPhuTrach = donHangRow[donHangColumnIndex['don_vi_phu_trach']] || '';
        const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
        const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
        const ngayNhapKho = donHangRow[donHangColumnIndex['ngay_nhap_kho']] || '';
        const xuongSanXuat = donHangRow[donHangColumnIndex['xuong_san_xuat']] || '';

        // Chỉ lấy các dòng thuộc nhóm "Bảo hành"
        if (nhomSanPham !== "Bảo hành") {
            return false;
        }

        if (mauCua === "Nhân công") {
            return false;
        }

        if (tenSanPham === "Di chuyển" || tenSanPham === "Nhân công") {
            return false;
        }

        // Lọc theo mã hợp đồng
        if (filterOptions.maHopDong && !maHopDong.includes(filterOptions.maHopDong)) {
            return false;
        }

        // Lọc theo đơn vị phụ trách (multi-select)
        if (filterOptions.donViPhuTrach && filterOptions.donViPhuTrach.length > 0) {
            if (!filterOptions.donViPhuTrach.includes(donViPhuTrach)) {
                return false;
            }
        }

        // Lọc theo ngày
        if (filterOptions.tuNgay && filterOptions.denNgay) {
            const tuNgay = new Date(filterOptions.tuNgay);
            const denNgay = new Date(filterOptions.denNgay);

            tuNgay.setHours(0, 0, 0, 0);
            denNgay.setHours(23, 59, 59, 999);

            let ngaySoSanhStr;
            if (loaiDonHang === "Yêu cầu kiểm tra") {
                ngaySoSanhStr = ngayGiaoHang;
            } else {
                ngaySoSanhStr = ngayNhapKho;
            }

            const ngaySoSanh = parseDDMMYYYY(ngaySoSanhStr);
            if (!ngaySoSanh) {
                return false;
            }

            if (ngaySoSanh < tuNgay || ngaySoSanh > denNgay) {
                return false;
            }
        }

        // Lọc theo loại đơn hàng
        if (filterOptions.loaiDonHang === "Tiêu chuẩn") {
            if (tenSanPham === "Vật tư khác" || trongLuongPhuKien !== "Tiêu chuẩn") {
                return false;
            }
        } else if (filterOptions.loaiDonHang === "Khác chuẩn") {
            if (trongLuongPhuKien !== "Khác chuẩn") {
                return false;
            }
        }

        // Lọc theo xưởng sản xuất
        if (filterOptions.xuongSanXuat && xuongSanXuat !== filterOptions.xuongSanXuat) {
            return false;
        }

        return true;
    }

    function displayResultsXuatBaoHanh(results) {
        const resultsBody = document.getElementById('results-body-xbh');
        const resultsTable = document.getElementById('results-table-xbh');
        const noResults = document.getElementById('no-results-xbh');
        const resultsCount = document.getElementById('results-count-xbh');

        resultsCount.textContent = `Kết quả: ${results.length} dòng`;
        resultsBody.innerHTML = '';

        if (results.length === 0) {
            resultsTable.style.display = 'none';
            noResults.style.display = 'block';
            return;
        }

        noResults.style.display = 'none';
        resultsTable.style.display = 'table';

        results.forEach(result => {
            const chiTietRow = result.chiTietRow;
            const donHangRow = result.donHangRow;
            const chiTietColumnIndex = result.chiTietColumnIndex;
            const donHangColumnIndex = result.donHangColumnIndex;

            const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
            const maSanPhamTheoDoi = chiTietRow[chiTietColumnIndex['ma_san_pham_theo_doi']] || '';
            const dienGiai = chiTietRow[chiTietColumnIndex['dien_giai']] || '';
            const ghiChu = chiTietRow[chiTietColumnIndex['ghi_chu']] || '';
            const dvt = chiTietRow[chiTietColumnIndex['dvt']] || '';
            const soLuong = chiTietRow[chiTietColumnIndex['so_luong']] || '';
            const khoiLuong = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['khoi_luong']] || '');
            const sttTrongDon = chiTietRow[chiTietColumnIndex['stt_trong_don']] || '';

            const ngayXuatKho = donHangRow[donHangColumnIndex['ngay_xuat_kho']] || '';
            const xuongSanXuat = donHangRow[donHangColumnIndex['xuong_san_xuat']] || '';
            const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';
            const maKhachHangID = donHangRow[donHangColumnIndex['ma_khach_hang_id']] || '';
            const tenNguoiLienHe = donHangRow[donHangColumnIndex['ten_nguoi_lien_he']] || '';
            const diaChiChiTiet = donHangRow[donHangColumnIndex['dia_chi_chi_tiet']] || '';

            let tenHang = '';
            if (dienGiai !== "") {
                tenHang = dienGiai;
            } else {
                tenHang = ghiChu;
            }

            const mnvCongTy = calculateMnvCongTy(donHangRow, donHangColumnIndex);

            // Xác định kho dựa trên xưởng sản xuất
            let kho = '';
            if (xuongSanXuat === "Hà Nội") {
                kho = "K03_SX.HN_152";
            } else if (xuongSanXuat === "Long An") {
                kho = "K04_SX.LA_152";
            }

            // Xác định đối tượng THCP dựa trên xưởng sản xuất
            let doiTuongTHCP = '';
            if (xuongSanXuat === "Hà Nội") {
                doiTuongTHCP = "25.SXT.X1";
            } else if (xuongSanXuat === "Long An") {
                doiTuongTHCP = "25.SXT.X2";
            }

            // Lấy các trường m_vt, kt_m_vt, sl_m_vt (từ 1 đến 20) - tương tự như tab lệnh sản xuất
            // Để ngắn gọn, tôi sẽ không liệt kê hết 20 trường ở đây. Bạn có thể copy từ hàm displayResultsLenSanXuat.
            // Tuy nhiên, trong ví dụ này, tôi sẽ chỉ lấy một vài trường đầu tiên để minh họa.
            const m_vt_1 = chiTietRow[chiTietColumnIndex['m_vt_1']] || '';
            const kt_m_vt_1 = chiTietRow[chiTietColumnIndex['kt_m_vt_1']] || '';
            const sl_m_vt_1 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_1']] || '');
            const m_vt_2 = chiTietRow[chiTietColumnIndex['m_vt_2']] || '';
            const kt_m_vt_2 = chiTietRow[chiTietColumnIndex['kt_m_vt_2']] || '';
            const sl_m_vt_2 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_2']] || '');
            const m_vt_3 = chiTietRow[chiTietColumnIndex['m_vt_3']] || '';
            const kt_m_vt_3 = chiTietRow[chiTietColumnIndex['kt_m_vt_3']] || '';
            const sl_m_vt_3 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_3']] || '');
            const m_vt_4 = chiTietRow[chiTietColumnIndex['m_vt_4']] || '';
            const kt_m_vt_4 = chiTietRow[chiTietColumnIndex['kt_m_vt_4']] || '';
            const sl_m_vt_4 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_4']] || '');
            const m_vt_5 = chiTietRow[chiTietColumnIndex['m_vt_5']] || '';
            const kt_m_vt_5 = chiTietRow[chiTietColumnIndex['kt_m_vt_5']] || '';
            const sl_m_vt_5 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_5']] || '');
            const m_vt_6 = chiTietRow[chiTietColumnIndex['m_vt_6']] || '';
            const kt_m_vt_6 = chiTietRow[chiTietColumnIndex['kt_m_vt_6']] || '';
            const sl_m_vt_6 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_6']] || '');
            const m_vt_7 = chiTietRow[chiTietColumnIndex['m_vt_7']] || '';
            const kt_m_vt_7 = chiTietRow[chiTietColumnIndex['kt_m_vt_7']] || '';
            const sl_m_vt_7 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_7']] || '');
            const m_vt_8 = chiTietRow[chiTietColumnIndex['m_vt_8']] || '';
            const kt_m_vt_8 = chiTietRow[chiTietColumnIndex['kt_m_vt_8']] || '';
            const sl_m_vt_8 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_8']] || '');
            const m_vt_9 = chiTietRow[chiTietColumnIndex['m_vt_9']] || '';
            const kt_m_vt_9 = chiTietRow[chiTietColumnIndex['kt_m_vt_9']] || '';
            const sl_m_vt_9 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_9']] || '');
            const m_vt_10 = chiTietRow[chiTietColumnIndex['m_vt_10']] || '';
            const kt_m_vt_10 = chiTietRow[chiTietColumnIndex['kt_m_vt_10']] || '';
            const sl_m_vt_10 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_10']] || '');
            const m_vt_11 = chiTietRow[chiTietColumnIndex['m_vt_11']] || '';
            const kt_m_vt_11 = chiTietRow[chiTietColumnIndex['kt_m_vt_11']] || '';
            const sl_m_vt_11 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_11']] || '');
            const m_vt_12 = chiTietRow[chiTietColumnIndex['m_vt_12']] || '';
            const kt_m_vt_12 = chiTietRow[chiTietColumnIndex['kt_m_vt_12']] || '';
            const sl_m_vt_12 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_12']] || '');
            const m_vt_13 = chiTietRow[chiTietColumnIndex['m_vt_13']] || '';
            const kt_m_vt_13 = chiTietRow[chiTietColumnIndex['kt_m_vt_13']] || '';
            const sl_m_vt_13 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_13']] || '');
            const m_vt_14 = chiTietRow[chiTietColumnIndex['m_vt_14']] || '';
            const kt_m_vt_14 = chiTietRow[chiTietColumnIndex['kt_m_vt_14']] || '';
            const sl_m_vt_14 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_14']] || '');
            const m_vt_15 = chiTietRow[chiTietColumnIndex['m_vt_15']] || '';
            const kt_m_vt_15 = chiTietRow[chiTietColumnIndex['kt_m_vt_15']] || '';
            const sl_m_vt_15 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_15']] || '');
            const m_vt_16 = chiTietRow[chiTietColumnIndex['m_vt_16']] || '';
            const kt_m_vt_16 = chiTietRow[chiTietColumnIndex['kt_m_vt_16']] || '';
            const sl_m_vt_16 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_16']] || '');
            const m_vt_17 = chiTietRow[chiTietColumnIndex['m_vt_17']] || '';
            const kt_m_vt_17 = chiTietRow[chiTietColumnIndex['kt_m_vt_17']] || '';
            const sl_m_vt_17 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_17']] || '');
            const m_vt_18 = chiTietRow[chiTietColumnIndex['m_vt_18']] || '';
            const kt_m_vt_18 = chiTietRow[chiTietColumnIndex['kt_m_vt_18']] || '';
            const sl_m_vt_18 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_18']] || '');
            const m_vt_19 = chiTietRow[chiTietColumnIndex['m_vt_19']] || '';
            const kt_m_vt_19 = chiTietRow[chiTietColumnIndex['kt_m_vt_19']] || '';
            const sl_m_vt_19 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_19']] || '');
            const m_vt_20 = chiTietRow[chiTietColumnIndex['m_vt_20']] || '';
            const kt_m_vt_20 = chiTietRow[chiTietColumnIndex['kt_m_vt_20']] || '';
            const sl_m_vt_20 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m_vt_20']] || '');

            // Lấy các trường m2_vt, kt1_m2_vt, kt2_m2_vt, sl_m2_vt (1 đến 2)
            const m2_vt_1 = chiTietRow[chiTietColumnIndex['m2_vt_1']] || '';
            const kt1_m2_vt_1 = chiTietRow[chiTietColumnIndex['kt1_m2_vt_1']] || '';
            const kt2_m2_vt_1 = chiTietRow[chiTietColumnIndex['kt2_m2_vt_1']] || '';
            const sl_m2_vt_1 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m2_vt_1']] || '');
            const m2_vt_2 = chiTietRow[chiTietColumnIndex['m2_vt_2']] || '';
            const kt1_m2_vt_2 = chiTietRow[chiTietColumnIndex['kt1_m2_vt_2']] || '';
            const kt2_m2_vt_2 = chiTietRow[chiTietColumnIndex['kt2_m2_vt_2']] || '';
            const sl_m2_vt_2 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_m2_vt_2']] || '');

            // Lấy các trường c_vt, sl_c_vt (1 đến 30)
            const c_vt_1 = chiTietRow[chiTietColumnIndex['c_vt_1']] || '';
            const sl_c_vt_1 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_1']] || '');
            const c_vt_2 = chiTietRow[chiTietColumnIndex['c_vt_2']] || '';
            const sl_c_vt_2 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_2']] || '');
            const c_vt_3 = chiTietRow[chiTietColumnIndex['c_vt_3']] || '';
            const sl_c_vt_3 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_3']] || '');
            const c_vt_4 = chiTietRow[chiTietColumnIndex['c_vt_4']] || '';
            const sl_c_vt_4 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_4']] || '');
            const c_vt_5 = chiTietRow[chiTietColumnIndex['c_vt_5']] || '';
            const sl_c_vt_5 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_5']] || '');
            const c_vt_6 = chiTietRow[chiTietColumnIndex['c_vt_6']] || '';
            const sl_c_vt_6 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_6']] || '');
            const c_vt_7 = chiTietRow[chiTietColumnIndex['c_vt_7']] || '';
            const sl_c_vt_7 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_7']] || '');
            const c_vt_8 = chiTietRow[chiTietColumnIndex['c_vt_8']] || '';
            const sl_c_vt_8 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_8']] || '');
            const c_vt_9 = chiTietRow[chiTietColumnIndex['c_vt_9']] || '';
            const sl_c_vt_9 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_9']] || '');
            const c_vt_10 = chiTietRow[chiTietColumnIndex['c_vt_10']] || '';
            const sl_c_vt_10 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_10']] || '');
            const c_vt_11 = chiTietRow[chiTietColumnIndex['c_vt_11']] || '';
            const sl_c_vt_11 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_11']] || '');
            const c_vt_12 = chiTietRow[chiTietColumnIndex['c_vt_12']] || '';
            const sl_c_vt_12 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_12']] || '');
            const c_vt_13 = chiTietRow[chiTietColumnIndex['c_vt_13']] || '';
            const sl_c_vt_13 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_13']] || '');
            const c_vt_14 = chiTietRow[chiTietColumnIndex['c_vt_14']] || '';
            const sl_c_vt_14 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_14']] || '');
            const c_vt_15 = chiTietRow[chiTietColumnIndex['c_vt_15']] || '';
            const sl_c_vt_15 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_15']] || '');
            const c_vt_16 = chiTietRow[chiTietColumnIndex['c_vt_16']] || '';
            const sl_c_vt_16 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_16']] || '');
            const c_vt_17 = chiTietRow[chiTietColumnIndex['c_vt_17']] || '';
            const sl_c_vt_17 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_17']] || '');
            const c_vt_18 = chiTietRow[chiTietColumnIndex['c_vt_18']] || '';
            const sl_c_vt_18 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_18']] || '');
            const c_vt_19 = chiTietRow[chiTietColumnIndex['c_vt_19']] || '';
            const sl_c_vt_19 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_19']] || '');
            const c_vt_20 = chiTietRow[chiTietColumnIndex['c_vt_20']] || '';
            const sl_c_vt_20 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_20']] || '');
            const c_vt_21 = chiTietRow[chiTietColumnIndex['c_vt_21']] || '';
            const sl_c_vt_21 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_21']] || '');
            const c_vt_22 = chiTietRow[chiTietColumnIndex['c_vt_22']] || '';
            const sl_c_vt_22 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_22']] || '');
            const c_vt_23 = chiTietRow[chiTietColumnIndex['c_vt_23']] || '';
            const sl_c_vt_23 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_23']] || '');
            const c_vt_24 = chiTietRow[chiTietColumnIndex['c_vt_24']] || '';
            const sl_c_vt_24 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_24']] || '');
            const c_vt_25 = chiTietRow[chiTietColumnIndex['c_vt_25']] || '';
            const sl_c_vt_25 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_25']] || '');
            const c_vt_26 = chiTietRow[chiTietColumnIndex['c_vt_26']] || '';
            const sl_c_vt_26 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_26']] || '');
            const c_vt_27 = chiTietRow[chiTietColumnIndex['c_vt_27']] || '';
            const sl_c_vt_27 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_27']] || '');
            const c_vt_28 = chiTietRow[chiTietColumnIndex['c_vt_28']] || '';
            const sl_c_vt_28 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_28']] || '');
            const c_vt_29 = chiTietRow[chiTietColumnIndex['c_vt_29']] || '';
            const sl_c_vt_29 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_29']] || '');
            const c_vt_30 = chiTietRow[chiTietColumnIndex['c_vt_30']] || '';
            const sl_c_vt_30 = formatNumberForDisplay(chiTietRow[chiTietColumnIndex['sl_c_vt_30']] || '');

            // Tạo lý do xuất mới
            const lyDoXuat = `Xuất BH - ${maKhachHangID} - ${tenNguoiLienHe} - ${diaChiChiTiet} - ${maHopDong}`;

            // Tạo hàng với các cột theo yêu cầu
            const row = document.createElement('tr');
            row.innerHTML = `
        <td>${maDonHangID}</td>
        <td>${sttTrongDon}</td>
        <td>3</td>
        <td>${ngayXuatKho}</td>
        <td>${ngayXuatKho}</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td>${lyDoXuat}</td>
        <td>${mnvCongTy}</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td>${kho}</td>
        <td></td>
        <td>154</td>
        <td>1521</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td>${doiTuongTHCP}</td>
        <td>${maSanPhamTheoDoi}</td>
        <td></td>
        <td>${maHopDong}</td>
        <td></td>
        <td></td>
        <td></td>
        <!-- Các cột m_vt, kt_m_vt, sl_m_vt ... (từ 1 đến 20) -->
        <td>${m_vt_1}</td>
        <td>${kt_m_vt_1}</td>
        <td>${sl_m_vt_1}</td>
        <td>${m_vt_2}</td>
        <td>${kt_m_vt_2}</td>
        <td>${sl_m_vt_2}</td>
        <td>${m_vt_3}</td>
        <td>${kt_m_vt_3}</td>
        <td>${sl_m_vt_3}</td>
        <td>${m_vt_4}</td>
        <td>${kt_m_vt_4}</td>
        <td>${sl_m_vt_4}</td>
        <td>${m_vt_5}</td>
        <td>${kt_m_vt_5}</td>
        <td>${sl_m_vt_5}</td>
        <td>${m_vt_6}</td>
        <td>${kt_m_vt_6}</td>
        <td>${sl_m_vt_6}</td>
        <td>${m_vt_7}</td>
        <td>${kt_m_vt_7}</td>
        <td>${sl_m_vt_7}</td>
        <td>${m_vt_8}</td>
        <td>${kt_m_vt_8}</td>
        <td>${sl_m_vt_8}</td>
        <td>${m_vt_9}</td>
        <td>${kt_m_vt_9}</td>
        <td>${sl_m_vt_9}</td>
        <td>${m_vt_10}</td>
        <td>${kt_m_vt_10}</td>
        <td>${sl_m_vt_10}</td>
        <td>${m_vt_11}</td>
        <td>${kt_m_vt_11}</td>
        <td>${sl_m_vt_11}</td>
        <td>${m_vt_12}</td>
        <td>${kt_m_vt_12}</td>
        <td>${sl_m_vt_12}</td>
        <td>${m_vt_13}</td>
        <td>${kt_m_vt_13}</td>
        <td>${sl_m_vt_13}</td>
        <td>${m_vt_14}</td>
        <td>${kt_m_vt_14}</td>
        <td>${sl_m_vt_14}</td>
        <td>${m_vt_15}</td>
        <td>${kt_m_vt_15}</td>
        <td>${sl_m_vt_15}</td>
        <td>${m_vt_16}</td>
        <td>${kt_m_vt_16}</td>
        <td>${sl_m_vt_16}</td>
        <td>${m_vt_17}</td>
        <td>${kt_m_vt_17}</td>
        <td>${sl_m_vt_17}</td>
        <td>${m_vt_18}</td>
        <td>${kt_m_vt_18}</td>
        <td>${sl_m_vt_18}</td>
        <td>${m_vt_19}</td>
        <td>${kt_m_vt_19}</td>
        <td>${sl_m_vt_19}</td>
        <td>${m_vt_20}</td>
        <td>${kt_m_vt_20}</td>
        <td>${sl_m_vt_20}</td>
        <td>${m2_vt_1}</td>
        <td>${kt1_m2_vt_1}</td>
        <td>${kt2_m2_vt_1}</td>
        <td>${sl_m2_vt_1}</td>
        <td>${m2_vt_2}</td>
        <td>${kt1_m2_vt_2}</td>
        <td>${kt2_m2_vt_2}</td>
        <td>${sl_m2_vt_2}</td>
        <td>${c_vt_1}</td>
        <td>${sl_c_vt_1}</td>
        <td>${c_vt_2}</td>
        <td>${sl_c_vt_2}</td>
        <td>${c_vt_3}</td>
        <td>${sl_c_vt_3}</td>
        <td>${c_vt_4}</td>
        <td>${sl_c_vt_4}</td>
        <td>${c_vt_5}</td>
        <td>${sl_c_vt_5}</td>
        <td>${c_vt_6}</td>
        <td>${sl_c_vt_6}</td>
        <td>${c_vt_7}</td>
        <td>${sl_c_vt_7}</td>
        <td>${c_vt_8}</td>
        <td>${sl_c_vt_8}</td>
        <td>${c_vt_9}</td>
        <td>${sl_c_vt_9}</td>
        <td>${c_vt_10}</td>
        <td>${sl_c_vt_10}</td>
        <td>${c_vt_11}</td>
        <td>${sl_c_vt_11}</td>
        <td>${c_vt_12}</td>
        <td>${sl_c_vt_12}</td>
        <td>${c_vt_13}</td>
        <td>${sl_c_vt_13}</td>
        <td>${c_vt_14}</td>
        <td>${sl_c_vt_14}</td>
        <td>${c_vt_15}</td>
        <td>${sl_c_vt_15}</td>
        <td>${c_vt_16}</td>
        <td>${sl_c_vt_16}</td>
        <td>${c_vt_17}</td>
        <td>${sl_c_vt_17}</td>
        <td>${c_vt_18}</td>
        <td>${sl_c_vt_18}</td>
        <td>${c_vt_19}</td>
        <td>${sl_c_vt_19}</td>
        <td>${c_vt_20}</td>
        <td>${sl_c_vt_20}</td>
        <td>${c_vt_21}</td>
        <td>${sl_c_vt_21}</td>
        <td>${c_vt_22}</td>
        <td>${sl_c_vt_22}</td>
        <td>${c_vt_23}</td>
        <td>${sl_c_vt_23}</td>
        <td>${c_vt_24}</td>
        <td>${sl_c_vt_24}</td>
        <td>${c_vt_25}</td>
        <td>${sl_c_vt_25}</td>
        <td>${c_vt_26}</td>
        <td>${sl_c_vt_26}</td>
        <td>${c_vt_27}</td>
        <td>${sl_c_vt_27}</td>
        <td>${c_vt_28}</td>
        <td>${sl_c_vt_28}</td>
        <td>${c_vt_29}</td>
        <td>${sl_c_vt_29}</td>
        <td>${c_vt_30}</td>
        <td>${sl_c_vt_30}</td>
        <td>${soLuong}</td>
        `;
            // Lưu ý: Bạn cần thêm đầy đủ các cột còn thiếu (m_vt_2 đến m_vt_20, m2_vt, c_vt) vào row.innerHTML.
            // Để ngắn gọn, tôi chỉ thêm một vài cột. Bạn có thể copy từ phần hiển thị của tab lệnh sản xuất và dán vào đây.

            resultsBody.appendChild(row);
        });
    }

    async function exportToExcelXuatBaoHanh() {
        if (filteredResultsXuatBaoHanh.length === 0) {
            showMessageXuatBaoHanh('Không có dữ liệu để xuất. Vui lòng thực hiện lọc trước.', 'error');
            return;
        }

        try {
            // Tạo workbook mới
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Danh sách xuất bảo hành');

            // Thêm tiêu đề cột (theo header CSV cũ - giống tab Lệnh sản xuất)
            const headers = [
                'ID', 'Hiển thị trên sổ', 'Loại xuất kho', 'Ngày hạch toán (*)', 'Ngày chứng từ (*)',
                'Số chứng từ (*)', 'Mẫu số HĐ', 'Ký hiệu HĐ', 'Mã đối tượng', 'Tên đối tượng',
                'Địa chỉ/Bộ phận', 'Tên người nhận/Của', 'Lý do xuất/Về việc', 'Nhân viên bán hàng',
                'Kèm theo', 'Số lệnh điều động', 'Ngày lệnh điều động', 'Người vận chuyển',
                'Tên người vận chuyển', 'Hợp đồng số', 'Phương tiện vận chuyển', 'Xuất tại kho',
                'Địa chỉ kho xuất', 'Nhập tại chi nhánh', 'Tên chi nhánh', 'MST chi nhánh',
                'Nhập tại kho', 'Địa chỉ kho nhập', 'Mã hàng (*)', 'Tên hàng', 'Là hàng khuyến mại',
                'Kho (*)', 'Hàng hóa giữ hộ/bán hộ', 'TK Nợ (*)', 'TK Có (*)', 'ĐVT', 'Số lượng',
                'Đơn giá bán', 'Thành tiền', 'Đơn giá vốn', 'Tiền vốn', 'Số lô', 'Hạn sử dụng',
                'Đối tượng', 'Khoản mục CP', 'Đơn vị', 'Đối tượng THCP', 'Công trình', 'Đơn đặt hàng',
                'Hợp đồng bán', 'CP không hợp lý', 'Mã thống kê', 'm_vt_1', 'kt_m_vt_1', 'sl_m_vt_1',
                'm_vt_2', 'kt_m_vt_2', 'sl_m_vt_2', 'm_vt_3', 'kt_m_vt_3', 'sl_m_vt_3', 'm_vt_4',
                'kt_m_vt_4', 'sl_m_vt_4', 'm_vt_5', 'kt_m_vt_5', 'sl_m_vt_5', 'm_vt_6', 'kt_m_vt_6',
                'sl_m_vt_6', 'm_vt_7', 'kt_m_vt_7', 'sl_m_vt_7', 'm_vt_8', 'kt_m_vt_8', 'sl_m_vt_8',
                'm_vt_9', 'kt_m_vt_9', 'sl_m_vt_9', 'm_vt_10', 'kt_m_vt_10', 'sl_m_vt_10', 'm_vt_11',
                'kt_m_vt_11', 'sl_m_vt_11', 'm_vt_12', 'kt_m_vt_12', 'sl_m_vt_12', 'm_vt_13',
                'kt_m_vt_13', 'sl_m_vt_13', 'm_vt_14', 'kt_m_vt_14', 'sl_m_vt_14', 'm_vt_15',
                'kt_m_vt_15', 'sl_m_vt_15', 'm_vt_16', 'kt_m_vt_16', 'sl_m_vt_16', 'm_vt_17',
                'kt_m_vt_17', 'sl_m_vt_17', 'm_vt_18', 'kt_m_vt_18', 'sl_m_vt_18', 'm_vt_19',
                'kt_m_vt_19', 'sl_m_vt_19', 'm_vt_20', 'kt_m_vt_20', 'sl_m_vt_20', 'm2_vt_1',
                'kt1_m2_vt_1', 'kt2_m2_vt_1', 'sl_m2_vt_1', 'm2_vt_2', 'kt1_m2_vt_2', 'kt2_m2_vt_2',
                'sl_m2_vt_2', 'c_vt_1', 'sl_c_vt_1', 'c_vt_2', 'sl_c_vt_2', 'c_vt_3', 'sl_c_vt_3',
                'c_vt_4', 'sl_c_vt_4', 'c_vt_5', 'sl_c_vt_5', 'c_vt_6', 'sl_c_vt_6', 'c_vt_7',
                'sl_c_vt_7', 'c_vt_8', 'sl_c_vt_8', 'c_vt_9', 'sl_c_vt_9', 'c_vt_10', 'sl_c_vt_10',
                'c_vt_11', 'sl_c_vt_11', 'c_vt_12', 'sl_c_vt_12', 'c_vt_13', 'sl_c_vt_13', 'c_vt_14',
                'sl_c_vt_14', 'c_vt_15', 'sl_c_vt_15', 'c_vt_16', 'sl_c_vt_16', 'c_vt_17',
                'sl_c_vt_17', 'c_vt_18', 'sl_c_vt_18', 'c_vt_19', 'sl_c_vt_19', 'c_vt_20',
                'sl_c_vt_20', 'c_vt_21', 'sl_c_vt_21', 'c_vt_22', 'sl_c_vt_22', 'c_vt_23',
                'sl_c_vt_23', 'c_vt_24', 'sl_c_vt_24', 'c_vt_25', 'sl_c_vt_25', 'c_vt_26',
                'sl_c_vt_26', 'c_vt_27', 'sl_c_vt_27', 'c_vt_28', 'sl_c_vt_28', 'c_vt_29',
                'sl_c_vt_29', 'c_vt_30', 'sl_c_vt_30', 'Số bộ'
            ];

            worksheet.addRow(headers);

            // Định dạng tiêu đề
            const headerRow = worksheet.getRow(1);
            headerRow.font = { bold: true };
            headerRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFE0E0E0' }
            };

            // Điền dữ liệu
            filteredResultsXuatBaoHanh.forEach((result, index) => {
                const chiTietRow = result.chiTietRow;
                const donHangRow = result.donHangRow;
                const chiTietColumnIndex = result.chiTietColumnIndex;
                const donHangColumnIndex = result.donHangColumnIndex;

                // Lấy các giá trị cần thiết
                const maDonHangID = chiTietRow[chiTietColumnIndex['ma_don_hang_id']] || '';
                const sttTrongDon = chiTietRow[chiTietColumnIndex['stt_trong_don']] || '';
                const maSanPhamTheoDoi = chiTietRow[chiTietColumnIndex['ma_san_pham_theo_doi']] || '';
                const dienGiai = chiTietRow[chiTietColumnIndex['dien_giai']] || '';
                const ghiChu = chiTietRow[chiTietColumnIndex['ghi_chu']] || '';
                const dvt = chiTietRow[chiTietColumnIndex['dvt']] || '';
                const soLuong = chiTietRow[chiTietColumnIndex['so_luong']] || '';
                const khoiLuong = formatNumberForCSV(chiTietRow[chiTietColumnIndex['khoi_luong']] || '');

                const loaiDonHang = donHangRow[donHangColumnIndex['loai_don_hang']] || '';
                const ngayGiaoHang = donHangRow[donHangColumnIndex['ngay_giao_hang']] || '';
                const ngayNhapKho = donHangRow[donHangColumnIndex['ngay_nhap_kho']] || '';
                const xuongSanXuat = donHangRow[donHangColumnIndex['xuong_san_xuat']] || '';
                const maHopDong = donHangRow[donHangColumnIndex['ma_hop_dong']] || '';
                const maKhachHangID = donHangRow[donHangColumnIndex['ma_khach_hang']] || '';
                const tenNguoiLienHe = donHangRow[donHangColumnIndex['ten_nguoi_lien_he']] || '';
                const diaChiChiTiet = donHangRow[donHangColumnIndex['dia_chi_chi_tiet']] || '';

                let ngayHaChToan = '';
                let ngayChungTu = '';

                if (loaiDonHang === "Yêu cầu kiểm tra") {
                    ngayHaChToan = convertDateToExcelSerial(ngayGiaoHang);
                    ngayChungTu = convertDateToExcelSerial(ngayGiaoHang);
                } else {
                    ngayHaChToan = convertDateToExcelSerial(ngayNhapKho);
                    ngayChungTu = convertDateToExcelSerial(ngayNhapKho);
                }

                const mnvCongTy = calculateMnvCongTy(donHangRow, donHangColumnIndex);

                // Xác định kho và đối tượng THCP
                let kho = '';
                let doiTuongTHCP = '';
                if (xuongSanXuat === "Hà Nội") {
                    kho = "K03_SX.HN_152";
                    doiTuongTHCP = "25.SXT.X1";
                } else if (xuongSanXuat === "Long An") {
                    kho = "K04_SX.LA_152";
                    doiTuongTHCP = "25.SXT.X2";
                }

                // Lấy tất cả các trường bổ sung (m_vt, m2_vt, c_vt)
                const getValue = (fieldName) => chiTietRow[chiTietColumnIndex[fieldName]] || '';
                const getNumberValue = (fieldName) => formatNumberForCSV(getValue(fieldName));

                // Xác định thông tin công trình cho bảo hành
                const lyDoXuat = `Xuất BH - ${tenNguoiLienHe} - ${diaChiChiTiet} - ${maHopDong}`;

                // Tạo dòng dữ liệu
                const rowData = [
                    maDonHangID, // ID
                    sttTrongDon, // Hiển thị trên sổ
                    3, // Loại xuất kho
                    ngayHaChToan, // Ngày hạch toán
                    ngayChungTu, // Ngày chứng từ
                    '', // Số chứng từ
                    '', // Mẫu số HĐ
                    '', // Ký hiệu HĐ
                    '', // Mã đối tượng
                    '', // Tên đối tượng
                    '', // Địa chỉ/Bộ phận
                    '', // Tên người nhận/Của
                    lyDoXuat, // Lý do xuất/Về việc
                    mnvCongTy, // Nhân viên bán hàng
                    '', // Kèm theo
                    '', // Số lệnh điều động
                    '', // Ngày lệnh điều động
                    '', // Người vận chuyển
                    '', // Tên người vận chuyển
                    '', // Hợp đồng số
                    '', // Phương tiện vận chuyển
                    '', // Xuất tại kho
                    '', // Địa chỉ kho xuất
                    '', // Nhập tại chi nhánh
                    '', // Tên chi nhánh
                    '', // MST chi nhánh
                    '', // Nhập tại kho
                    '', // Địa chỉ kho nhập
                    '', // Mã hàng
                    '', // Tên hàng
                    ghiChu, // Là hàng khuyến mại
                    kho, // Kho
                    '', // Hàng hóa giữ hộ/bán hộ
                    154, // TK Nợ
                    1521, // TK Có
                    '', // ĐVT
                    '', // Số lượng
                    '', // Đơn giá bán
                    '', // Thành tiền
                    '', // Đơn giá vốn
                    '', // Tiền vốn
                    '', // Số lô
                    '', // Hạn sử dụng
                    '', // Đối tượng
                    '', // Khoản mục CP
                    doiTuongTHCP, // Đơn vị
                    maSanPhamTheoDoi, // Đối tượng THCP
                    '', // Công trình
                    maHopDong, // Đơn đặt hàng
                    '', // Hợp đồng bán
                    '', // CP không hợp lý
                    '', // Mã thống kê
                    // Các trường m_vt (1-20)
                    getValue('m_vt_1'), getValue('kt_m_vt_1'), getNumberValue('sl_m_vt_1'),
                    getValue('m_vt_2'), getValue('kt_m_vt_2'), getNumberValue('sl_m_vt_2'),
                    getValue('m_vt_3'), getValue('kt_m_vt_3'), getNumberValue('sl_m_vt_3'),
                    getValue('m_vt_4'), getValue('kt_m_vt_4'), getNumberValue('sl_m_vt_4'),
                    getValue('m_vt_5'), getValue('kt_m_vt_5'), getNumberValue('sl_m_vt_5'),
                    getValue('m_vt_6'), getValue('kt_m_vt_6'), getNumberValue('sl_m_vt_6'),
                    getValue('m_vt_7'), getValue('kt_m_vt_7'), getNumberValue('sl_m_vt_7'),
                    getValue('m_vt_8'), getValue('kt_m_vt_8'), getNumberValue('sl_m_vt_8'),
                    getValue('m_vt_9'), getValue('kt_m_vt_9'), getNumberValue('sl_m_vt_9'),
                    getValue('m_vt_10'), getValue('kt_m_vt_10'), getNumberValue('sl_m_vt_10'),
                    getValue('m_vt_11'), getValue('kt_m_vt_11'), getNumberValue('sl_m_vt_11'),
                    getValue('m_vt_12'), getValue('kt_m_vt_12'), getNumberValue('sl_m_vt_12'),
                    getValue('m_vt_13'), getValue('kt_m_vt_13'), getNumberValue('sl_m_vt_13'),
                    getValue('m_vt_14'), getValue('kt_m_vt_14'), getNumberValue('sl_m_vt_14'),
                    getValue('m_vt_15'), getValue('kt_m_vt_15'), getNumberValue('sl_m_vt_15'),
                    getValue('m_vt_16'), getValue('kt_m_vt_16'), getNumberValue('sl_m_vt_16'),
                    getValue('m_vt_17'), getValue('kt_m_vt_17'), getNumberValue('sl_m_vt_17'),
                    getValue('m_vt_18'), getValue('kt_m_vt_18'), getNumberValue('sl_m_vt_18'),
                    getValue('m_vt_19'), getValue('kt_m_vt_19'), getNumberValue('sl_m_vt_19'),
                    getValue('m_vt_20'), getValue('kt_m_vt_20'), getNumberValue('sl_m_vt_20'),
                    // Các trường m2_vt (1-2)
                    getValue('m2_vt_1'), getValue('kt1_m2_vt_1'), getValue('kt2_m2_vt_1'), getNumberValue('sl_m2_vt_1'),
                    getValue('m2_vt_2'), getValue('kt1_m2_vt_2'), getValue('kt2_m2_vt_2'), getNumberValue('sl_m2_vt_2'),
                    // Các trường c_vt (1-30)
                    getValue('c_vt_1'), getNumberValue('sl_c_vt_1'),
                    getValue('c_vt_2'), getNumberValue('sl_c_vt_2'),
                    getValue('c_vt_3'), getNumberValue('sl_c_vt_3'),
                    getValue('c_vt_4'), getNumberValue('sl_c_vt_4'),
                    getValue('c_vt_5'), getNumberValue('sl_c_vt_5'),
                    getValue('c_vt_6'), getNumberValue('sl_c_vt_6'),
                    getValue('c_vt_7'), getNumberValue('sl_c_vt_7'),
                    getValue('c_vt_8'), getNumberValue('sl_c_vt_8'),
                    getValue('c_vt_9'), getNumberValue('sl_c_vt_9'),
                    getValue('c_vt_10'), getNumberValue('sl_c_vt_10'),
                    getValue('c_vt_11'), getNumberValue('sl_c_vt_11'),
                    getValue('c_vt_12'), getNumberValue('sl_c_vt_12'),
                    getValue('c_vt_13'), getNumberValue('sl_c_vt_13'),
                    getValue('c_vt_14'), getNumberValue('sl_c_vt_14'),
                    getValue('c_vt_15'), getNumberValue('sl_c_vt_15'),
                    getValue('c_vt_16'), getNumberValue('sl_c_vt_16'),
                    getValue('c_vt_17'), getNumberValue('sl_c_vt_17'),
                    getValue('c_vt_18'), getNumberValue('sl_c_vt_18'),
                    getValue('c_vt_19'), getNumberValue('sl_c_vt_19'),
                    getValue('c_vt_20'), getNumberValue('sl_c_vt_20'),
                    getValue('c_vt_21'), getNumberValue('sl_c_vt_21'),
                    getValue('c_vt_22'), getNumberValue('sl_c_vt_22'),
                    getValue('c_vt_23'), getNumberValue('sl_c_vt_23'),
                    getValue('c_vt_24'), getNumberValue('sl_c_vt_24'),
                    getValue('c_vt_25'), getNumberValue('sl_c_vt_25'),
                    getValue('c_vt_26'), getNumberValue('sl_c_vt_26'),
                    getValue('c_vt_27'), getNumberValue('sl_c_vt_27'),
                    getValue('c_vt_28'), getNumberValue('sl_c_vt_28'),
                    getValue('c_vt_29'), getNumberValue('sl_c_vt_29'),
                    getValue('c_vt_30'), getNumberValue('sl_c_vt_30'),
                    soLuong // Số bộ
                ];

                worksheet.addRow(rowData);
            });

            // Tự động điều chỉnh độ rộng cột
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    const cellLength = cell.value ? cell.value.toString().length : 10;
                    if (cellLength > maxLength) {
                        maxLength = cellLength;
                    }
                });
                column.width = maxLength < 10 ? 10 : maxLength + 2;
            });

            // Tạo tên file và tải về
            const tuNgayRaw = document.getElementById("tu-ngay-xbh").value;
            const denNgayRaw = document.getElementById("den-ngay-xbh").value;
            const tuNgay = formatDateForFilename(tuNgayRaw);
            const denNgay = formatDateForFilename(denNgayRaw);
            const loaiDonHang = document.querySelector('input[name="loai-don-hang-xbh"]:checked').value;

            const outputBuffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([outputBuffer], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const fileName = `Danh sách xuất bảo hành - ${tuNgay} - ${denNgay} - ${loaiDonHang}.xlsx`;
            link.download = fileName;
            link.click();

            showMessageXuatBaoHanh(`Đã xuất ${filteredResultsXuatBaoHanh.length} dòng ra file Excel.`, 'success');

        } catch (error) {
            console.error('Lỗi xuất Excel:', error);
            showMessageXuatBaoHanh('Không thể xuất Excel. Vui lòng thử lại.', 'error');
        }
    }

    function showLoadingXuatBaoHanh(show) {
        const loadingElement = document.getElementById('loading-xbh');
        loadingElement.style.display = show ? 'block' : 'none';
    }

    function showMessageXuatBaoHanh(message, type) {
        const resultsCount = document.getElementById("results-count-xbh");
        resultsCount.className = "results-count";

        if (type === "success") {
            resultsCount.style.backgroundColor = "#e8f7e8";
            resultsCount.style.color = "#0c9c07";
            resultsCount.style.borderLeft = "4px solid #0c9c07";
        }

        if (type === "error") {
            resultsCount.style.backgroundColor = "#ffeaea";
            resultsCount.style.color = "#c00";
            resultsCount.style.borderLeft = "4px solid #c00";
        }

        resultsCount.style.padding = "5px";
        resultsCount.style.borderRadius = "6px";
        resultsCount.style.fontSize = "16px";
        resultsCount.style.fontWeight = "600";
        resultsCount.textContent = message;
    }

    function requireRefilterXuatBaoHanh() {
        document.getElementById('results-table-xbh').style.display = 'none';
        document.getElementById('no-results-xbh').style.display = 'block';
        document.getElementById('results-count-xbh').textContent = 'Kết quả: Chưa có dòng nào được lọc.';
        filteredResultsXuatBaoHanh = [];
        showMessageXuatBaoHanh("Bạn đã thay đổi bộ lọc. Vui lòng nhấn 'Lọc' để cập nhật kết quả mới.", "error");
    }

    // ==================== TAB XUẤT YÊU CẦU (HOÀN THIỆN) ====================

    function initXuatYeuCauEventListeners() {
        document.getElementById('btn-loc-xuat-yeu-cau').addEventListener('click', applyFilterXuatYeuCau);
        document.getElementById('btn-reset-xuat-yeu-cau').addEventListener('click', resetFilterXuatYeuCau);
        document.getElementById('btn-export-xuat-yeu-cau').addEventListener('click', exportToExcelXuatYeuCau);

        document.getElementById("tu-ngay-xuat-yeu-cau").addEventListener("change", requireRefilterXuatYeuCau);
        document.getElementById("den-ngay-xuat-yeu-cau").addEventListener("change", requireRefilterXuatYeuCau);
        document.getElementById("loai-phieu-xuat-yeu-cau").addEventListener("change", requireRefilterXuatYeuCau);
        document.getElementById("xuong-san-xuat-xuat-yeu-cau").addEventListener("change", requireRefilterXuatYeuCau);
    }

    function resetFilterXuatYeuCau() {
        // Reset multi-select mã phiếu
        const maPhieuAllCheckbox = document.getElementById('ma-phieu-xuat-yeu-cau-all');
        if (maPhieuAllCheckbox) {
            maPhieuAllCheckbox.checked = true;
        }

        const maPhieuCheckboxes = document.querySelectorAll('#ma-phieu-xuat-yeu-cau-container input[type="checkbox"]:not(#ma-phieu-xuat-yeu-cau-all)');
        maPhieuCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });

        document.getElementById('tu-ngay-xuat-yeu-cau').value = '';
        document.getElementById('den-ngay-xuat-yeu-cau').value = '';
        document.getElementById('loai-phieu-xuat-yeu-cau').value = '';
        document.getElementById('xuong-san-xuat-xuat-yeu-cau').value = '';

        document.getElementById('results-table-xuat-yeu-cau').style.display = 'none';
        document.getElementById('no-results-xuat-yeu-cau').style.display = 'block';
        document.getElementById('results-count-xuat-yeu-cau').textContent = 'Kết quả: Chưa có dòng nào được lọc.';

        filteredResultsXuatYeuCau = [];
    }

    async function applyFilterXuatYeuCau() {
        showLoadingXuatYeuCau(true);

        try {
            if (!isDataLoaded) {
                await fetchDataFromSheets();
            }

            const filterOptions = {
                maPhieu: getSelectedMaPhieu(),
                tuNgay: document.getElementById('tu-ngay-xuat-yeu-cau').value,
                denNgay: document.getElementById('den-ngay-xuat-yeu-cau').value,
                loaiPhieuloc: document.getElementById('loai-phieu-xuat-yeu-cau').value,
                xuongSanXuat: document.getElementById('xuong-san-xuat-xuat-yeu-cau').value
            };

            filteredResultsXuatYeuCau = filterDataXuatYeuCau(filterOptions);
            displayResultsXuatYeuCau(filteredResultsXuatYeuCau);
            showMessageXuatYeuCau(`Đã tìm thấy ${filteredResultsXuatYeuCau.length} dòng phù hợp.`, 'success');

        } catch (error) {
            console.error('Lỗi khi áp dụng bộ lọc:', error);
            showMessageXuatYeuCau('Đã xảy ra lỗi khi tải dữ liệu. Vui lòng thử lại.', 'error');
        } finally {
            showLoadingXuatYeuCau(false);
        }
    }

    function filterDataXuatYeuCau(filterOptions) {
        if (xuatChuyenKhoChiTietData.length === 0) {
            return [];
        }

        const chiTietHeaders = xuatChuyenKhoChiTietData[0];
        const chiTietColumnIndex = {};
        chiTietHeaders.forEach((header, index) => {
            chiTietColumnIndex[header] = index;
        });

        const filteredResults = [];
        let resultId = 1;

        for (let i = 1; i < xuatChuyenKhoChiTietData.length; i++) {
            const chiTietRow = xuatChuyenKhoChiTietData[i];

            if (!passesFilterConditionsXuatYeuCau(chiTietRow, chiTietColumnIndex, filterOptions)) {
                continue;
            }

            filteredResults.push({
                id: resultId++,
                chiTietRow: chiTietRow,
                chiTietColumnIndex: chiTietColumnIndex
            });
        }

        return filteredResults;
    }

    function passesFilterConditionsXuatYeuCau(chiTietRow, chiTietColumnIndex, filterOptions) {
        const maPhieuXuatId = chiTietRow[chiTietColumnIndex['ma_phieu_xuat_id']] || '';

        // Lấy thông tin phiếu từ lookup table
        const phieuInfo = lookupPhieuByMaPhieu[maPhieuXuatId] || {};
        const loaiPhieu = phieuInfo.loaiPhieu || '';
        const xuongSx = phieuInfo.xuongSx || '';
        const ngayXuat = phieuInfo.ngayXuat || '';

        // Lọc theo mã phiếu (multi-select)
        if (filterOptions.maPhieu && filterOptions.maPhieu.length > 0) {
            if (!filterOptions.maPhieu.includes(maPhieuXuatId)) {
                return false;
            }
        }

        // Lọc theo loại phiếu
        if (filterOptions.loaiPhieuloc && loaiPhieu !== filterOptions.loaiPhieuloc) {
            return false;
        }

        // Lọc theo xưởng sản xuất
        if (filterOptions.xuongSanXuat && xuongSx !== filterOptions.xuongSanXuat) {
            return false;
        }

        // Lọc theo ngày xuất
        if (filterOptions.tuNgay && filterOptions.denNgay) {
            const tuNgay = new Date(filterOptions.tuNgay);
            const denNgay = new Date(filterOptions.denNgay);

            tuNgay.setHours(0, 0, 0, 0);
            denNgay.setHours(23, 59, 59, 999);

            const ngayXuatDate = parseDDMMYYYY(ngayXuat);
            if (!ngayXuatDate) {
                return false;
            }

            if (ngayXuatDate < tuNgay || ngayXuatDate > denNgay) {
                return false;
            }
        }

        return true;
    }

    function getTaiKhoanHachToan(maVatTu) {
        if (!maVatTu) return "";

        // giống CONTAINS(ma_vat_tu, "*")
        if (maVatTu.includes("*")) {
            return "155";
        }
        return "1521";
    }

    function displayResultsXuatYeuCau(results) {
        const resultsBody = document.getElementById('results-body-xuat-yeu-cau');
        const resultsTable = document.getElementById('results-table-xuat-yeu-cau');
        const noResults = document.getElementById('no-results-xuat-yeu-cau');
        const resultsCount = document.getElementById('results-count-xuat-yeu-cau');

        resultsCount.textContent = `Kết quả: ${results.length} dòng`;
        resultsBody.innerHTML = '';

        if (results.length === 0) {
            resultsTable.style.display = 'none';
            noResults.style.display = 'block';
            return;
        }

        noResults.style.display = 'none';
        resultsTable.style.display = 'table';

        results.forEach(result => {
            const chiTietRow = result.chiTietRow;
            const chiTietColumnIndex = result.chiTietColumnIndex;

            // Lấy các giá trị cần thiết (điều chỉnh theo cấu trúc thực tế của sheet)
            const maPhieuXuatId = chiTietRow[chiTietColumnIndex['ma_phieu_xuat_id']] || '';
            const maVatTu = chiTietRow[chiTietColumnIndex['ma_vat_tu']] || '';
            const xuatTaikho = chiTietRow[chiTietColumnIndex['xuat_tai_kho']] || '';
            const nhapTaikho = chiTietRow[chiTietColumnIndex['nhap_tai_kho']] || '';
            const taiKhoanHachtoan = getTaiKhoanHachToan(maVatTu);
            const dvtQuydoi = chiTietRow[chiTietColumnIndex['dvt_quy_doi']] || '';
            const slXuatQuydoi = chiTietRow[chiTietColumnIndex['sl_xuat_quy_doi']] || '';

            const row = document.createElement('tr');
            row.innerHTML = `
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td>Mã phiếu xuất ${maPhieuXuatId}</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td>${maVatTu}</td>
            <td></td>
            <td>${xuatTaikho}</td>
            <td></td>
            <td>${nhapTaikho}</td>
            <td></td>
            <td></td>
            <td>${taiKhoanHachtoan}</td>
            <td>${taiKhoanHachtoan}</td>
            <td>${dvtQuydoi}</td>
            <td>${slXuatQuydoi}</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        `;
            resultsBody.appendChild(row);
        });
    }

    async function exportToExcelXuatYeuCau() {
        if (filteredResultsXuatYeuCau.length === 0) {
            showMessageXuatYeuCau('Không có dữ liệu để xuất. Vui lòng thực hiện lọc trước.', 'error');
            return;
        }

        try {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Danh sách yêu cầu xuất kho');

            // Thêm tiêu đề cột
            const headers = [
                'Hiển thị trên sổ', 'Hình thức chuyển kho', 'Ngày chứng từ (*)', 'Ngày hạch toán (*)', 'Số chứng từ (*)', 'Mẫu số hóa đơn', 'Ký hiệu HĐ', 'Hợp đồng KT số/Lệnh điều động', 'Ngày',
                'Của', 'Về việc/Diễn giải', 'Đại lý/Đơn vị nhận', 'Tên đại lý/Tên đơn vị nhận', 'Mã số thuế đại lý/đơn vị nhận', 'Người vận chuyển', 'Tên người VC', 'Hợp đồng số', 'Phương tiện VC',
                'Mã hàng (*)', 'Tên hàng', 'Xuất tại kho (*)', 'Địa chỉ kho xuất', 'Nhập tại kho (*)', 'Địa chỉ kho nhập', 'Hàng hóa giữ hộ/bán hộ', 'TK Nợ (*)', 'TK Có (*)', 'ĐVT', 'Số lượng', 'Đơn giá bán',
                'Thành tiền', 'Đơn giá vốn', 'Tiền vốn', 'Số lô', 'Hạn sử dụng', 'Mã thống kê'
            ];

            worksheet.addRow(headers);

            // Định dạng tiêu đề
            const headerRow = worksheet.getRow(1);
            headerRow.font = { bold: true };
            headerRow.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFE0E0E0' }
            };

            // Điền dữ liệu
            filteredResultsXuatYeuCau.forEach((result, index) => {
                const chiTietRow = result.chiTietRow;
                const chiTietColumnIndex = result.chiTietColumnIndex;

                // Lấy các giá trị cần thiết (điều chỉnh theo cấu trúc thực tế của sheet)
                const maPhieuXuatId = chiTietRow[chiTietColumnIndex['ma_phieu_xuat_id']] || '';
                const maVatTu = chiTietRow[chiTietColumnIndex['ma_vat_tu']] || '';
                const xuatTaikho = chiTietRow[chiTietColumnIndex['xuat_tai_kho']] || '';
                const nhapTaikho = chiTietRow[chiTietColumnIndex['nhap_tai_kho']] || '';
                const taiKhoanHachtoan = getTaiKhoanHachToan(maVatTu);
                const dvtQuydoi = chiTietRow[chiTietColumnIndex['dvt_quy_doi']] || '';
                const slXuatQuydoi = chiTietRow[chiTietColumnIndex['sl_xuat_quy_doi']] || '';

                const lyDoXuat = `Mã phiếu xuất ${maPhieuXuatId}`;

                const rowData = [, , , , , , , , , , , lyDoXuat, , , , , , , , maVatTu, , xuatTaikho, , nhapTaikho, , , taiKhoanHachtoan, taiKhoanHachtoan, dvtQuydoi, slXuatQuydoi, , , , , , ,];

                worksheet.addRow(rowData);
            });

            // Tự động điều chỉnh độ rộng cột
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    const cellLength = cell.value ? cell.value.toString().length : 10;
                    if (cellLength > maxLength) {
                        maxLength = cellLength;
                    }
                });
                column.width = maxLength < 10 ? 10 : maxLength + 2;
            });

            // Tạo tên file
            const tuNgayRaw = document.getElementById("tu-ngay-xuat-yeu-cau").value;
            const denNgayRaw = document.getElementById("den-ngay-xuat-yeu-cau").value;
            const tuNgay = formatDateForFilename(tuNgayRaw);
            const denNgay = formatDateForFilename(denNgayRaw);
            const xuongSanXuat = document.getElementById('xuong-san-xuat-xuat-yeu-cau').value;

            const outputBuffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([outputBuffer], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const fileName = `Danh sách xuất yêu cầu - ${tuNgay} - ${denNgay} - ${xuongSanXuat || 'Tất cả'}.xlsx`;
            link.download = fileName;
            link.click();

            showMessageXuatYeuCau(`Đã xuất ${filteredResultsXuatYeuCau.length} dòng ra file Excel.`, 'success');

        } catch (error) {
            console.error('Lỗi xuất Excel:', error);
            showMessageXuatYeuCau('Không thể xuất Excel. Vui lòng thử lại.', 'error');
        }
    }

    function showLoadingXuatYeuCau(show) {
        const loadingElement = document.getElementById('loading-xuat-yeu-cau');
        if (loadingElement) {
            loadingElement.style.display = show ? 'block' : 'none';
        }
    }

    function showMessageXuatYeuCau(message, type) {
        const resultsCount = document.getElementById("results-count-xuat-yeu-cau");
        if (!resultsCount) return;

        resultsCount.className = "results-count";

        if (type === "success") {
            resultsCount.style.backgroundColor = "#e8f7e8";
            resultsCount.style.color = "#0c9c07";
            resultsCount.style.borderLeft = "4px solid #0c9c07";
        } else if (type === "error") {
            resultsCount.style.backgroundColor = "#ffeaea";
            resultsCount.style.color = "#c00";
            resultsCount.style.borderLeft = "4px solid #c00";
        }

        resultsCount.style.padding = "5px";
        resultsCount.style.borderRadius = "6px";
        resultsCount.style.fontSize = "16px";
        resultsCount.style.fontWeight = "600";
        resultsCount.textContent = message;
    }

    function requireRefilterXuatYeuCau() {
        const resultsTable = document.getElementById('results-table-xuat-yeu-cau');
        const noResults = document.getElementById('no-results-xuat-yeu-cau');
        const resultsCount = document.getElementById('results-count-xuat-yeu-cau');

        if (resultsTable) resultsTable.style.display = 'none';
        if (noResults) noResults.style.display = 'block';
        if (resultsCount) resultsCount.textContent = 'Kết quả: Chưa có dòng nào được lọc.';

        filteredResultsXuatYeuCau = [];
        showMessageXuatYeuCau("Bạn đã thay đổi bộ lọc. Vui lòng nhấn 'Lọc' để cập nhật kết quả mới.", "error");
    }

</script>

<body>
    <div class="container">
        <div class="header-modern">
            <!-- Left: Logo + Title -->
            <div class="brand">
                <img src="https://quangminhpro.com/wp-content/uploads/2025/08/logo-3.svg" alt="Quang Minh Logo"
                    class="brand-logo">
                <div class="brand-text">
                    <h1>HỆ THỐNG DỮ LIỆU TRUNG CHUYỂN</h1>
                </div>
            </div>

            <!-- Right: Status Pills -->
            <div class="header-status">
                <div id="connection-status" class="status-pill">
                    <span class="dot"></span>
                    <span id="status-text">Chưa kết nối</span>
                </div>
                <div id="last-update" class="status-pill light">
                    ⏱ <span id="last-update-text">---</span>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="khachhang">
                <i class="fas fa-users"></i> Dữ liệu khách hàng
            </button>
            <button class="tab-button" data-tab="nhapkho">
                <i class="fas fa-warehouse"></i> Nhập kho thành phẩm
            </button>
            <button class="tab-button" data-tab="xuatkho">
                <i class="fas fa-truck"></i> Xuất kho bán hàng
            </button>
            <button class="tab-button" data-tab="lenhsanxuat">
                <i class="fas fa-industry"></i> Xuất vật tư sản xuất
            </button>
            <button class="tab-button" data-tab="xuatbaohanh">
                <i class="fas fa-shield-halved"></i> Xuất vật tư bảo hành
            </button>
            <button class="tab-button" data-tab="xuat-yeu-cau">
                <i class="fas fa-boxes"></i> Yêu cầu xuất kho
            </button>
        </div>

        <!-- Tab Dữ liệu khách hàng -->
        <div id="khachhang-tab" class="tab-content active">
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-sliders-h"></i> Thiết lập bộ lọc - Dữ liệu khách hàng
                </div>

                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label" id="don-vi-label-kh">
                            Đơn vị phụ trách -
                            <span class="selected-count" id="don-vi-selected-kh">
                                Đã chọn: Tất cả
                            </span>
                        </label>

                        <div class="multi-select-container" id="don-vi-phu-trach-kh-container">
                            <!-- Các checkbox sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Ngày phát sinh từ</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="tu-ngay-kh">
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Ngày phát sinh đến</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="den-ngay-kh">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-loc-kh">
                        <i class="fas fa-filter"></i> Lọc
                    </button>
                    <button class="btn btn-secondary" id="btn-reset-kh">
                        <i class="fas fa-redo"></i> Đặt lại
                    </button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <div class="results-count" id="results-count-kh"></div>
                    <button class="export-btn" id="btn-export-kh">
                        <i class="fas fa-file-export"></i> Xuất Excel
                    </button>
                </div>

                <div class="table-container-wrapper">
                    <div id="loading-kh" class="loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Đang tải dữ liệu từ Google Sheets...</p>
                    </div>

                    <div id="results-container-kh">
                        <div class="no-results" id="no-results-kh">
                            <i class="fas fa-search"></i>
                            <p>Chưa có dữ liệu. Vui lòng thiết lập bộ lọc và nhấn "Lọc".</p>
                        </div>

                        <div class="table-container">
                            <table class="results-table" id="results-table-kh" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Là tổ chức/cá nhân</th>
                                        <th>Là nhà cung cấp</th>
                                        <th>Mã khách hàng (*)</th>
                                        <th>Tên khách hàng (*)</th>
                                        <th>Địa chỉ</th>
                                        <th>Mã số thuế</th>
                                        <th>Điện thoại</th>
                                        <th>Điện thoại di động</th>
                                        <th>Fax</th>
                                        <th>Email</th>
                                        <th>Website</th>
                                        <th>Nhóm KH/NCC</th>
                                        <th>Số CMND</th>
                                        <th>Ngày cấp</th>
                                        <th>Nơi cấp</th>
                                        <th>Xưng hô</th>
                                        <th>Họ và tên NLH</th>
                                        <th>Chức danh NLH</th>
                                        <th>Địa chỉ người liên hệ</th>
                                        <th>ĐT di động NLH</th>
                                        <th>ĐT di động khác của NLH</th>
                                        <th>ĐT cố định NLH</th>
                                        <th>Email người liên hệ</th>
                                        <th>Số tài khoản</th>
                                        <th>Tên ngân hàng</th>
                                        <th>Chi nhánh</th>
                                        <th>Tỉnh/TP TK ngân hàng</th>
                                        <th>Ngày phát sinh</th>
                                    </tr>
                                </thead>
                                <tbody id="results-body-kh">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nhập kho Tab -->
        <div id="nhapkho-tab" class="tab-content">
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-sliders-h"></i> Thiết lập bộ lọc - Nhập kho thành phẩm
                </div>

                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label" id="ma-hop-dong-label-nhap">
                            Mã hợp đồng -
                            <span class="selected-count" id="ma-hop-dong-selected-nhap">
                                Đã chọn: Tất cả
                            </span>
                        </label>

                        <div class="multi-select-container" id="ma-hop-dong-nhap-container">
                            <!-- Các checkbox sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label" id="don-vi-label-nhap">
                            Đơn vị phụ trách -
                            <span class="selected-count" id="don-vi-selected-nhap">
                                Đã chọn: Tất cả
                            </span>
                        </label>

                        <div class="multi-select-container" id="don-vi-phu-trach-nhap-container">
                            <!-- Các checkbox sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Loại đơn hàng</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="loai-tat-ca-nhap" name="loai-don-hang-nhap" value="Tất cả"
                                    checked>
                                <label for="loai-tat-ca-nhap">Tất cả</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="loai-tieu-chuan-nhap" name="loai-don-hang-nhap"
                                    value="Tiêu chuẩn">
                                <label for="loai-tieu-chuan-nhap">Tiêu chuẩn</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="loai-khac-chuan-nhap" name="loai-don-hang-nhap"
                                    value="Khác chuẩn">
                                <label for="loai-khac-chuan-nhap">Khác chuẩn</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Từ ngày</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="tu-ngay-nhap">
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Đến ngày</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="den-ngay-nhap">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-loc-nhap">
                        <i class="fas fa-filter"></i> Lọc
                    </button>
                    <button class="btn btn-secondary" id="btn-reset-nhap">
                        <i class="fas fa-redo"></i> Đặt lại
                    </button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <div class="results-count" id="results-count-nhap"></div>
                    <button class="export-btn" id="btn-export-nhap">
                        <i class="fas fa-file-export"></i> Xuất Excel
                    </button>
                </div>

                <div class="table-container-wrapper">
                    <div id="loading-nhap" class="loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Đang tải dữ liệu từ Google Sheets...</p>
                    </div>

                    <div id="results-container-nhap">
                        <div class="no-results" id="no-results-nhap">
                            <i class="fas fa-search"></i>
                            <p>Chưa có dữ liệu. Vui lòng thiết lập bộ lọc và nhấn "Lọc".</p>
                        </div>

                        <div class="table-container">
                            <table class="results-table" id="results-table-nhap" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Hiển thị trên sổ</th>
                                        <th>Loại nhập kho</th>
                                        <th>Ngày hạch toán (*)</th>
                                        <th>Ngày chứng từ (*)</th>
                                        <th>Số chứng từ (*)</th>
                                        <th>Mã đối tượng</th>
                                        <th>Tên đối tượng</th>
                                        <th>Người giao hàng</th>
                                        <th>Diễn giải</th>
                                        <th>Nhân viên bán hàng</th>
                                        <th>Kèm theo</th>
                                        <th>Loại tiền</th>
                                        <th>Tỷ giá</th>
                                        <th>Mã hàng (*)</th>
                                        <th>Tên hàng</th>
                                        <th>Kho (*)</th>
                                        <th>Hàng hóa giữ hộ/bán hộ</th>
                                        <th>TK Nợ (*)</th>
                                        <th>TK Có (*)</th>
                                        <th>ĐVT</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th>Thành tiền quy đổi</th>
                                        <th>Số lô</th>
                                        <th>Hạn sử dụng</th>
                                        <th>Khoản mục CP</th>
                                        <th>Đơn vị</th>
                                        <th>Đối tượng THCP</th>
                                        <th>Công trình</th>
                                        <th>Đơn đặt hàng</th>
                                        <th>Hợp đồng bán</th>
                                        <th>Mã thống kê</th>
                                    </tr>
                                </thead>
                                <tbody id="results-body-nhap">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Xuất kho Tab -->
        <div id="xuatkho-tab" class="tab-content">
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-sliders-h"></i> Thiết lập bộ lọc - Xuất kho bán hàng
                </div>

                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label" id="ma-hop-dong-label-xuat">
                            Mã hợp đồng -
                            <span class="selected-count" id="ma-hop-dong-selected-xuat">
                                Đã chọn: Tất cả
                            </span>
                        </label>

                        <div class="multi-select-container" id="ma-hop-dong-xuat-container">
                            <!-- Các checkbox sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label" id="don-vi-label-xuat">
                            Đơn vị phụ trách -
                            <span class="selected-count" id="don-vi-selected-xuat">
                                Đã chọn: Tất cả
                            </span>
                        </label>

                        <div class="multi-select-container" id="don-vi-phu-trach-xuat-container">
                            <!-- Các checkbox sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Loại đơn hàng</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="loai-tat-ca-xuat" name="loai-don-hang-xuat" value="Tất cả"
                                    checked>
                                <label for="loai-tat-ca-xuat">Tất cả</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="loai-tieu-chuan-xuat" name="loai-don-hang-xuat"
                                    value="Tiêu chuẩn">
                                <label for="loai-tieu-chuan-xuat">Tiêu chuẩn</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="loai-khac-chuan-xuat" name="loai-don-hang-xuat"
                                    value="Khác chuẩn">
                                <label for="loai-khac-chuan-xuat">Khác chuẩn</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Từ ngày</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="tu-ngay-xuat">
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Đến ngày</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="den-ngay-xuat">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-loc-xuat">
                        <i class="fas fa-filter"></i> Lọc
                    </button>
                    <button class="btn btn-secondary" id="btn-reset-xuat">
                        <i class="fas fa-redo"></i> Đặt lại
                    </button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <div class="results-count" id="results-count-xuat"></div>
                    <button class="export-btn" id="btn-export-xuat">
                        <i class="fas fa-file-export"></i> Xuất Excel
                    </button>
                </div>

                <div class="table-container-wrapper">
                    <div id="loading-xuat" class="loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Đang tải dữ liệu từ Google Sheets...</p>
                    </div>

                    <div id="results-container-xuat">
                        <div class="no-results" id="no-results-xuat">
                            <i class="fas fa-search"></i>
                            <p>Chưa có dữ liệu. Vui lòng thiết lập bộ lọc và nhấn "Lọc".</p>
                        </div>

                        <div class="table-container">
                            <table class="results-table" id="results-table-xuat" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Hiển thị trên sổ</th>
                                        <th>Hình thức bán hàng</th>
                                        <th>Phương thức thanh toán</th>
                                        <th>Kiêm phiếu xuất kho</th>
                                        <th>XK vào khu phi thuế quan và các TH được coi như XK</th>
                                        <th>Lập kèm hóa đơn</th>
                                        <th>Đã lập hóa đơn</th>
                                        <th>Ngày hạch toán (*)</th>
                                        <th>Ngày chứng từ (*)</th>
                                        <th>Số chứng từ (*)</th>
                                        <th>Số phiếu xuất</th>
                                        <th>Lý do xuất</th>
                                        <th>Mẫu số HĐ</th>
                                        <th>Ký hiệu HĐ</th>
                                        <th>Số hóa đơn</th>
                                        <th>Ngày hóa đơn</th>
                                        <th>Mã khách hàng</th>
                                        <th>Tên khách hàng</th>
                                        <th>Địa chỉ</th>
                                        <th>Mã số thuế</th>
                                        <th>Diễn giải</th>
                                        <th>Nộp vào TK</th>
                                        <th>NV bán hàng</th>
                                        <th>Loại tiền</th>
                                        <th>Tỷ giá</th>
                                        <th>Mã hàng (*)</th>
                                        <th>Tên hàng</th>
                                        <th>Hàng khuyến mại</th>
                                        <th>TK Tiền/Chi phí/Nợ (*)</th>
                                        <th>TK Doanh thu/Có (*)</th>
                                        <th>ĐVT</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá sau thuế</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th>Thành tiền quy đổi</th>
                                        <th>Tỷ lệ CK (%)</th>
                                        <th>Tiền chiết khấu</th>
                                        <th>Tiền chiết khấu quy đổi</th>
                                        <th>TK chiết khấu</th>
                                        <th>Giá tính thuế XK</th>
                                        <th>% thuế XK</th>
                                        <th>Tiền thuế XK</th>
                                        <th>TK thuế XK</th>
                                        <th>% thuế GTGT</th>
                                        <th>Tỷ lệ tính thuế (Thuế suất KHAC)</th>
                                        <th>Tiền thuế GTGT</th>
                                        <th>Tiền thuế GTGT quy đổi</th>
                                        <th>TK thuế GTGT</th>
                                        <th>HH không TH trên tờ khai thuế GTGT</th>
                                        <th>Kho</th>
                                        <th>TK giá vốn</th>
                                        <th>TK Kho</th>
                                        <th>Đơn giá vốn</th>
                                        <th>Tiền vốn</th>
                                        <th>Hàng hóa giữ hộ/bán hộ</th>
                                        <th>Phí vận chuyển, lắp đặt</th>
                                        <th>Chi phí dịch vụ sơn yêu cầu</th>
                                        <th>Ghi chú</th>
                                        <th>Tổng số tiền</th>
                                        <th>Kiểu thanh toán</th>
                                    </tr>
                                </thead>
                                <tbody id="results-body-xuat">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lệnh sản xuất Tab -->
        <div id="lenhsanxuat-tab" class="tab-content">
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-sliders-h"></i> Thiết lập bộ lọc - Xuất vật tư sản xuất
                </div>

                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label" id="ma-hop-dong-label-lsx">
                            Mã hợp đồng -
                            <span class="selected-count" id="ma-hop-dong-selected-lsx">
                                Đã chọn: Tất cả
                            </span>
                        </label>

                        <div class="multi-select-container" id="ma-hop-dong-lsx-container">
                            <!-- Các checkbox sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label" id="don-vi-label-lsx">
                            Đơn vị phụ trách -
                            <span class="selected-count" id="don-vi-selected-lsx">
                                Đã chọn: Tất cả
                            </span>
                        </label>

                        <div class="multi-select-container" id="don-vi-phu-trach-lsx-container">
                            <!-- Các checkbox sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Loại đơn hàng</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="loai-tat-ca-lsx" name="loai-don-hang-lsx" value="Tất cả"
                                    checked>
                                <label for="loai-tat-ca-lsx">Tất cả</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="loai-tieu-chuan-lsx" name="loai-don-hang-lsx"
                                    value="Tiêu chuẩn">
                                <label for="loai-tieu-chuan-lsx">Tiêu chuẩn</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="loai-khac-chuan-lsx" name="loai-don-hang-lsx"
                                    value="Khác chuẩn">
                                <label for="loai-khac-chuan-lsx">Khác chuẩn</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Xưởng sản xuất</label>
                        <select class="filter-select" id="xuong-san-xuat-lsx">
                            <option value="">Tất cả xưởng</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Từ ngày</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="tu-ngay-lsx">
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Đến ngày</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="den-ngay-lsx">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-loc-lsx">
                        <i class="fas fa-filter"></i> Lọc
                    </button>
                    <button class="btn btn-secondary" id="btn-reset-lsx">
                        <i class="fas fa-redo"></i> Đặt lại
                    </button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <div class="results-count" id="results-count-lsx"></div>
                    <button class="export-btn" id="btn-export-lsx">
                        <i class="fas fa-file-export"></i> Xuất Excel
                    </button>
                </div>

                <div class="table-container-wrapper">
                    <div id="loading-lsx" class="loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Đang tải dữ liệu từ Google Sheets...</p>
                    </div>

                    <div id="results-container-lsx">
                        <div class="no-results" id="no-results-lsx">
                            <i class="fas fa-search"></i>
                            <p>Chưa có dữ liệu. Vui lòng thiết lập bộ lọc và nhấn "Lọc".</p>
                        </div>

                        <div class="table-container">
                            <table class="results-table" id="results-table-lsx" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Hiển thị trên sổ</th>
                                        <th>Loại xuất kho</th>
                                        <th>Ngày hạch toán (*)</th>
                                        <th>Ngày chứng từ (*)</th>
                                        <th>Số chứng từ (*)</th>
                                        <th>Mẫu số HĐ</th>
                                        <th>Ký hiệu HĐ</th>
                                        <th>Mã đối tượng</th>
                                        <th>Tên đối tượng</th>
                                        <th>Địa chỉ/Bộ phận</th>
                                        <th>Tên người nhận/Của</th>
                                        <th>Lý do xuất/Về việc</th>
                                        <th>Nhân viên bán hàng</th>
                                        <th>Kèm theo</th>
                                        <th>Số lệnh điều động</th>
                                        <th>Ngày lệnh điều động</th>
                                        <th>Người vận chuyển</th>
                                        <th>Tên người vận chuyển</th>
                                        <th>Hợp đồng số</th>
                                        <th>Phương tiện vận chuyển</th>
                                        <th>Xuất tại kho</th>
                                        <th>Địa chỉ kho xuất</th>
                                        <th>Nhập tại chi nhánh</th>
                                        <th>Tên chi nhánh</th>
                                        <th>MST chi nhánh</th>
                                        <th>Nhập tại kho</th>
                                        <th>Địa chỉ kho nhập</th>
                                        <th>Mã hàng (*)</th>
                                        <th>Tên hàng</th>
                                        <th>Là hàng khuyến mại</th>
                                        <th>Kho (*)</th>
                                        <th>Hàng hóa giữ hộ/bán hộ</th>
                                        <th>TK Nợ (*)</th>
                                        <th>TK Có (*)</th>
                                        <th>ĐVT</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá bán</th>
                                        <th>Thành tiền</th>
                                        <th>Đơn giá vốn</th>
                                        <th>Tiền vốn</th>
                                        <th>Số lô</th>
                                        <th>Hạn sử dụng</th>
                                        <th>Đối tượng</th>
                                        <th>Khoản mục CP</th>
                                        <th>Đơn vị</th>
                                        <th>Đối tượng THCP</th>
                                        <th>Công trình</th>
                                        <th>Đơn đặt hàng</th>
                                        <th>Hợp đồng bán</th>
                                        <th>CP không hợp lý</th>
                                        <th>Mã thống kê</th>
                                        <!-- Các cột m_vt, kt_m_vt, sl_m_vt ... (từ 1 đến 20) -->
                                        <th>m_vt_1</th>
                                        <th>kt_m_vt_1</th>
                                        <th>sl_m_vt_1</th>
                                        <th>m_vt_2</th>
                                        <th>kt_m_vt_2</th>
                                        <th>sl_m_vt_2</th>
                                        <th>m_vt_3</th>
                                        <th>kt_m_vt_3</th>
                                        <th>sl_m_vt_3</th>
                                        <th>m_vt_4</th>
                                        <th>kt_m_vt_4</th>
                                        <th>sl_m_vt_4</th>
                                        <th>m_vt_5</th>
                                        <th>kt_m_vt_5</th>
                                        <th>sl_m_vt_5</th>
                                        <th>m_vt_6</th>
                                        <th>kt_m_vt_6</th>
                                        <th>sl_m_vt_6</th>
                                        <th>m_vt_7</th>
                                        <th>kt_m_vt_7</th>
                                        <th>sl_m_vt_7</th>
                                        <th>m_vt_8</th>
                                        <th>kt_m_vt_8</th>
                                        <th>sl_m_vt_8</th>
                                        <th>m_vt_9</th>
                                        <th>kt_m_vt_9</th>
                                        <th>sl_m_vt_9</th>
                                        <th>m_vt_10</th>
                                        <th>kt_m_vt_10</th>
                                        <th>sl_m_vt_10</th>
                                        <th>m_vt_11</th>
                                        <th>kt_m_vt_11</th>
                                        <th>sl_m_vt_11</th>
                                        <th>m_vt_12</th>
                                        <th>kt_m_vt_12</th>
                                        <th>sl_m_vt_12</th>
                                        <th>m_vt_13</th>
                                        <th>kt_m_vt_13</th>
                                        <th>sl_m_vt_13</th>
                                        <th>m_vt_14</th>
                                        <th>kt_m_vt_14</th>
                                        <th>sl_m_vt_14</th>
                                        <th>m_vt_15</th>
                                        <th>kt_m_vt_15</th>
                                        <th>sl_m_vt_15</th>
                                        <th>m_vt_16</th>
                                        <th>kt_m_vt_16</th>
                                        <th>sl_m_vt_16</th>
                                        <th>m_vt_17</th>
                                        <th>kt_m_vt_17</th>
                                        <th>sl_m_vt_17</th>
                                        <th>m_vt_18</th>
                                        <th>kt_m_vt_18</th>
                                        <th>sl_m_vt_18</th>
                                        <th>m_vt_19</th>
                                        <th>kt_m_vt_19</th>
                                        <th>sl_m_vt_19</th>
                                        <th>m_vt_20</th>
                                        <th>kt_m_vt_20</th>
                                        <th>sl_m_vt_20</th>
                                        <!-- Các cột m2_vt, kt1_m2_vt, kt2_m2_vt, sl_m2_vt (1 đến 2) -->
                                        <th>m2_vt_1</th>
                                        <th>kt1_m2_vt_1</th>
                                        <th>kt2_m2_vt_1</th>
                                        <th>sl_m2_vt_1</th>
                                        <th>m2_vt_2</th>
                                        <th>kt1_m2_vt_2</th>
                                        <th>kt2_m2_vt_2</th>
                                        <th>sl_m2_vt_2</th>
                                        <!-- Các cột c_vt, sl_c_vt (1 đến 30) -->
                                        <th>c_vt_1</th>
                                        <th>sl_c_vt_1</th>
                                        <th>c_vt_2</th>
                                        <th>sl_c_vt_2</th>
                                        <th>c_vt_3</th>
                                        <th>sl_c_vt_3</th>
                                        <th>c_vt_4</th>
                                        <th>sl_c_vt_4</th>
                                        <th>c_vt_5</th>
                                        <th>sl_c_vt_5</th>
                                        <th>c_vt_6</th>
                                        <th>sl_c_vt_6</th>
                                        <th>c_vt_7</th>
                                        <th>sl_c_vt_7</th>
                                        <th>c_vt_8</th>
                                        <th>sl_c_vt_8</th>
                                        <th>c_vt_9</th>
                                        <th>sl_c_vt_9</th>
                                        <th>c_vt_10</th>
                                        <th>sl_c_vt_10</th>
                                        <th>c_vt_11</th>
                                        <th>sl_c_vt_11</th>
                                        <th>c_vt_12</th>
                                        <th>sl_c_vt_12</th>
                                        <th>c_vt_13</th>
                                        <th>sl_c_vt_13</th>
                                        <th>c_vt_14</th>
                                        <th>sl_c_vt_14</th>
                                        <th>c_vt_15</th>
                                        <th>sl_c_vt_15</th>
                                        <th>c_vt_16</th>
                                        <th>sl_c_vt_16</th>
                                        <th>c_vt_17</th>
                                        <th>sl_c_vt_17</th>
                                        <th>c_vt_18</th>
                                        <th>sl_c_vt_18</th>
                                        <th>c_vt_19</th>
                                        <th>sl_c_vt_19</th>
                                        <th>c_vt_20</th>
                                        <th>sl_c_vt_20</th>
                                        <th>c_vt_21</th>
                                        <th>sl_c_vt_21</th>
                                        <th>c_vt_22</th>
                                        <th>sl_c_vt_22</th>
                                        <th>c_vt_23</th>
                                        <th>sl_c_vt_23</th>
                                        <th>c_vt_24</th>
                                        <th>sl_c_vt_24</th>
                                        <th>c_vt_25</th>
                                        <th>sl_c_vt_25</th>
                                        <th>c_vt_26</th>
                                        <th>sl_c_vt_26</th>
                                        <th>c_vt_27</th>
                                        <th>sl_c_vt_27</th>
                                        <th>c_vt_28</th>
                                        <th>sl_c_vt_28</th>
                                        <th>c_vt_29</th>
                                        <th>sl_c_vt_29</th>
                                        <th>c_vt_30</th>
                                        <th>sl_c_vt_30</th>
                                        <th>Số bộ</th>
                                    </tr>
                                </thead>
                                <tbody id="results-body-lsx">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lệnh xuất bảo hành Tab -->
        <div id="xuatbaohanh-tab" class="tab-content">
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-sliders-h"></i> Thiết lập bộ lọc - Xuất vật tư bảo hành
                </div>

                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label" id="ma-hop-dong-label-xbh">
                            Mã hợp đồng -
                            <span class="selected-count" id="ma-hop-dong-selected-xbh">
                                Đã chọn: Tất cả
                            </span>
                        </label>

                        <div class="multi-select-container" id="ma-hop-dong-xbh-container">
                            <!-- Các checkbox sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label" id="don-vi-label-xbh">
                            Đơn vị phụ trách -
                            <span class="selected-count" id="don-vi-selected-xbh">
                                Đã chọn: Tất cả
                            </span>
                        </label>
                        <div class="multi-select-container" id="don-vi-phu-trach-xbh-container">
                            <!-- Các checkbox sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Loại đơn hàng</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="loai-tat-ca-xbh" name="loai-don-hang-xbh" value="Tất cả"
                                    checked>
                                <label for="loai-tat-ca-xbh">Tất cả</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="loai-tieu-chuan-xbh" name="loai-don-hang-xbh"
                                    value="Tiêu chuẩn">
                                <label for="loai-tieu-chuan-xbh">Tiêu chuẩn</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="loai-khac-chuan-xbh" name="loai-don-hang-xbh"
                                    value="Khác chuẩn">
                                <label for="loai-khac-chuan-xbh">Khác chuẩn</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Xưởng sản xuất</label>
                        <select class="filter-select" id="xuong-san-xuat-xbh">
                            <option value="">Tất cả xưởng</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Từ ngày</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="tu-ngay-xbh">
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Đến ngày</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="den-ngay-xbh">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-loc-xbh">
                        <i class="fas fa-filter"></i> Lọc
                    </button>
                    <button class="btn btn-secondary" id="btn-reset-xbh">
                        <i class="fas fa-redo"></i> Đặt lại
                    </button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <div class="results-count" id="results-count-xbh"></div>
                    <button class="export-btn" id="btn-export-xbh">
                        <i class="fas fa-file-export"></i> Xuất Excel
                    </button>
                </div>

                <div class="table-container-wrapper">
                    <div id="loading-xbh" class="loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Đang tải dữ liệu từ Google Sheets...</p>
                    </div>

                    <div id="results-container-xbh">
                        <div class="no-results" id="no-results-xbh">
                            <i class="fas fa-search"></i>
                            <p>Chưa có dữ liệu. Vui lòng thiết lập bộ lọc và nhấn "Lọc".</p>
                        </div>

                        <div class="table-container">
                            <!-- Sử dụng bảng giống hệt tab lệnh sản xuất -->
                            <table class="results-table" id="results-table-xbh" style="display: none;">
                                <!-- Copy toàn bộ thead từ bảng lệnh sản xuất -->
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Hiển thị trên sổ</th>
                                        <th>Loại xuất kho</th>
                                        <th>Ngày hạch toán (*)</th>
                                        <th>Ngày chứng từ (*)</th>
                                        <th>Số chứng từ (*)</th>
                                        <th>Mẫu số HĐ</th>
                                        <th>Ký hiệu HĐ</th>
                                        <th>Mã đối tượng</th>
                                        <th>Tên đối tượng</th>
                                        <th>Địa chỉ/Bộ phận</th>
                                        <th>Tên người nhận/Của</th>
                                        <th>Lý do xuất/Về việc</th>
                                        <th>Nhân viên bán hàng</th>
                                        <th>Kèm theo</th>
                                        <th>Số lệnh điều động</th>
                                        <th>Ngày lệnh điều động</th>
                                        <th>Người vận chuyển</th>
                                        <th>Tên người vận chuyển</th>
                                        <th>Hợp đồng số</th>
                                        <th>Phương tiện vận chuyển</th>
                                        <th>Xuất tại kho</th>
                                        <th>Địa chỉ kho xuất</th>
                                        <th>Nhập tại chi nhánh</th>
                                        <th>Tên chi nhánh</th>
                                        <th>MST chi nhánh</th>
                                        <th>Nhập tại kho</th>
                                        <th>Địa chỉ kho nhập</th>
                                        <th>Mã hàng (*)</th>
                                        <th>Tên hàng</th>
                                        <th>Là hàng khuyến mại</th>
                                        <th>Kho (*)</th>
                                        <th>Hàng hóa giữ hộ/bán hộ</th>
                                        <th>TK Nợ (*)</th>
                                        <th>TK Có (*)</th>
                                        <th>ĐVT</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá bán</th>
                                        <th>Thành tiền</th>
                                        <th>Đơn giá vốn</th>
                                        <th>Tiền vốn</th>
                                        <th>Số lô</th>
                                        <th>Hạn sử dụng</th>
                                        <th>Đối tượng</th>
                                        <th>Khoản mục CP</th>
                                        <th>Đơn vị</th>
                                        <th>Đối tượng THCP</th>
                                        <th>Công trình</th>
                                        <th>Đơn đặt hàng</th>
                                        <th>Hợp đồng bán</th>
                                        <th>CP không hợp lý</th>
                                        <th>Mã thống kê</th>
                                        <!-- Các cột m_vt, kt_m_vt, sl_m_vt ... (từ 1 đến 20) -->
                                        <th>m_vt_1</th>
                                        <th>kt_m_vt_1</th>
                                        <th>sl_m_vt_1</th>
                                        <th>m_vt_2</th>
                                        <th>kt_m_vt_2</th>
                                        <th>sl_m_vt_2</th>
                                        <th>m_vt_3</th>
                                        <th>kt_m_vt_3</th>
                                        <th>sl_m_vt_3</th>
                                        <th>m_vt_4</th>
                                        <th>kt_m_vt_4</th>
                                        <th>sl_m_vt_4</th>
                                        <th>m_vt_5</th>
                                        <th>kt_m_vt_5</th>
                                        <th>sl_m_vt_5</th>
                                        <th>m_vt_6</th>
                                        <th>kt_m_vt_6</th>
                                        <th>sl_m_vt_6</th>
                                        <th>m_vt_7</th>
                                        <th>kt_m_vt_7</th>
                                        <th>sl_m_vt_7</th>
                                        <th>m_vt_8</th>
                                        <th>kt_m_vt_8</th>
                                        <th>sl_m_vt_8</th>
                                        <th>m_vt_9</th>
                                        <th>kt_m_vt_9</th>
                                        <th>sl_m_vt_9</th>
                                        <th>m_vt_10</th>
                                        <th>kt_m_vt_10</th>
                                        <th>sl_m_vt_10</th>
                                        <th>m_vt_11</th>
                                        <th>kt_m_vt_11</th>
                                        <th>sl_m_vt_11</th>
                                        <th>m_vt_12</th>
                                        <th>kt_m_vt_12</th>
                                        <th>sl_m_vt_12</th>
                                        <th>m_vt_13</th>
                                        <th>kt_m_vt_13</th>
                                        <th>sl_m_vt_13</th>
                                        <th>m_vt_14</th>
                                        <th>kt_m_vt_14</th>
                                        <th>sl_m_vt_14</th>
                                        <th>m_vt_15</th>
                                        <th>kt_m_vt_15</th>
                                        <th>sl_m_vt_15</th>
                                        <th>m_vt_16</th>
                                        <th>kt_m_vt_16</th>
                                        <th>sl_m_vt_16</th>
                                        <th>m_vt_17</th>
                                        <th>kt_m_vt_17</th>
                                        <th>sl_m_vt_17</th>
                                        <th>m_vt_18</th>
                                        <th>kt_m_vt_18</th>
                                        <th>sl_m_vt_18</th>
                                        <th>m_vt_19</th>
                                        <th>kt_m_vt_19</th>
                                        <th>sl_m_vt_19</th>
                                        <th>m_vt_20</th>
                                        <th>kt_m_vt_20</th>
                                        <th>sl_m_vt_20</th>
                                        <!-- Các cột m2_vt, kt1_m2_vt, kt2_m2_vt, sl_m2_vt (1 đến 2) -->
                                        <th>m2_vt_1</th>
                                        <th>kt1_m2_vt_1</th>
                                        <th>kt2_m2_vt_1</th>
                                        <th>sl_m2_vt_1</th>
                                        <th>m2_vt_2</th>
                                        <th>kt1_m2_vt_2</th>
                                        <th>kt2_m2_vt_2</th>
                                        <th>sl_m2_vt_2</th>
                                        <!-- Các cột c_vt, sl_c_vt (1 đến 30) -->
                                        <th>c_vt_1</th>
                                        <th>sl_c_vt_1</th>
                                        <th>c_vt_2</th>
                                        <th>sl_c_vt_2</th>
                                        <th>c_vt_3</th>
                                        <th>sl_c_vt_3</th>
                                        <th>c_vt_4</th>
                                        <th>sl_c_vt_4</th>
                                        <th>c_vt_5</th>
                                        <th>sl_c_vt_5</th>
                                        <th>c_vt_6</th>
                                        <th>sl_c_vt_6</th>
                                        <th>c_vt_7</th>
                                        <th>sl_c_vt_7</th>
                                        <th>c_vt_8</th>
                                        <th>sl_c_vt_8</th>
                                        <th>c_vt_9</th>
                                        <th>sl_c_vt_9</th>
                                        <th>c_vt_10</th>
                                        <th>sl_c_vt_10</th>
                                        <th>c_vt_11</th>
                                        <th>sl_c_vt_11</th>
                                        <th>c_vt_12</th>
                                        <th>sl_c_vt_12</th>
                                        <th>c_vt_13</th>
                                        <th>sl_c_vt_13</th>
                                        <th>c_vt_14</th>
                                        <th>sl_c_vt_14</th>
                                        <th>c_vt_15</th>
                                        <th>sl_c_vt_15</th>
                                        <th>c_vt_16</th>
                                        <th>sl_c_vt_16</th>
                                        <th>c_vt_17</th>
                                        <th>sl_c_vt_17</th>
                                        <th>c_vt_18</th>
                                        <th>sl_c_vt_18</th>
                                        <th>c_vt_19</th>
                                        <th>sl_c_vt_19</th>
                                        <th>c_vt_20</th>
                                        <th>sl_c_vt_20</th>
                                        <th>c_vt_21</th>
                                        <th>sl_c_vt_21</th>
                                        <th>c_vt_22</th>
                                        <th>sl_c_vt_22</th>
                                        <th>c_vt_23</th>
                                        <th>sl_c_vt_23</th>
                                        <th>c_vt_24</th>
                                        <th>sl_c_vt_24</th>
                                        <th>c_vt_25</th>
                                        <th>sl_c_vt_25</th>
                                        <th>c_vt_26</th>
                                        <th>sl_c_vt_26</th>
                                        <th>c_vt_27</th>
                                        <th>sl_c_vt_27</th>
                                        <th>c_vt_28</th>
                                        <th>sl_c_vt_28</th>
                                        <th>c_vt_29</th>
                                        <th>sl_c_vt_29</th>
                                        <th>c_vt_30</th>
                                        <th>sl_c_vt_30</th>
                                        <th>Số bộ</th>
                                    </tr>
                                </thead>
                                <tbody id="results-body-xbh">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Phiếu yêu cầu xuất kho -->
        <div id="xuat-yeu-cau-tab" class="tab-content">
            <div class="filter-section">
                <h3 class="filter-title"><i class="fas fa-sliders-h"></i> Thiết lập bộ lọc - Yêu cầu xuất kho</h3>
                <div class="filter-grid">
                    <!-- Mã phiếu (multi-select) -->
                    <div class="filter-group">
                        <label class="filter-label">
                            Mã phiếu -
                            <span id="ma-phieu-selected-xuat-yeu-cau">Đã chọn: Tất cả</span>
                        </label>
                        <div id="ma-phieu-xuat-yeu-cau-container" class="multi-select-container">
                            <!-- Nội dung multi-select sẽ được thêm động -->
                        </div>
                    </div>

                    <!-- Loại phiếu (select) -->
                    <div class="filter-group">
                        <label class="filter-label">Loại phiếu</label>
                        <select class="filter-select" id="loai-phieu-xuat-yeu-cau">
                            <option value="">Tất cả</option>
                        </select>
                    </div>

                    <!-- Xưởng sản xuất (select) -->
                    <div class="filter-group">
                        <label class="filter-label">Xưởng sản xuất</label>
                        <select class="filter-select" id="xuong-san-xuat-xuat-yeu-cau">
                            <option value="">Tất cả xưởng</option>
                        </select>
                    </div>

                    <!-- Từ ngày -->
                    <div class="filter-group">
                        <label class="filter-label">Từ ngày</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="tu-ngay-xuat-yeu-cau">
                            </div>
                        </div>
                    </div>

                    <!-- Đến ngày -->
                    <div class="filter-group">
                        <label class="filter-label">Đến ngày</label>
                        <div class="date-group">
                            <div class="date-input">
                                <input type="date" class="filter-input" id="den-ngay-xuat-yeu-cau">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-loc-xuat-yeu-cau">
                        <i class="fas fa-filter"></i> Lọc
                    </button>
                    <button class="btn btn-secondary" id="btn-reset-xuat-yeu-cau">
                        <i class="fas fa-redo"></i> Đặt lại
                    </button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <div class="results-count" id="results-count-xuat-yeu-cau"></div>
                    <button class="export-btn" id="btn-export-xuat-yeu-cau">
                        <i class="fas fa-file-export"></i> Xuất Excel
                    </button>
                </div>

                <div class="table-container-wrapper">
                    <div class="table-container">
                        <div id="loading-xuat-yeu-cau" class="loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Đang tải dữ liệu...</p>
                        </div>

                        <div id="no-results-xuat-yeu-cau" class="no-results" style="display: block;">
                            <i class="fas fa-search"></i>
                            <p>Chưa có dữ liệu. Vui lòng thiết lập bộ lọc và nhấn "Lọc".</p>
                        </div>

                        <table class="results-table" id="results-table-xuat-yeu-cau" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Hiển thị trên sổ</th>
                                    <th>Hình thức chuyển kho</th>
                                    <th>Ngày chứng từ (*)</th>
                                    <th>Ngày hạch toán (*)</th>
                                    <th>Số chứng từ (*)</th>
                                    <th>Mẫu số hóa đơn</th>
                                    <th>Ký hiệu HĐ</th>
                                    <th>Hợp đồng KT số/Lệnh điều động</th>
                                    <th>Ngày</th>
                                    <th>Của</th>
                                    <th>Về việc/Diễn giải</th>
                                    <th>Đại lý/Đơn vị nhận</th>
                                    <th>Tên đại lý/Tên đơn vị nhận</th>
                                    <th>Mã số thuế đại lý/đơn vị nhận</th>
                                    <th>Người vận chuyển</th>
                                    <th>Tên người VC</th>
                                    <th>Hợp đồng số</th>
                                    <th>Phương tiện VC</th>
                                    <th>Mã hàng (*)</th>
                                    <th>Tên hàng</th>
                                    <th>Xuất tại kho (*)</th>
                                    <th>Địa chỉ kho xuất</th>
                                    <th>Nhập tại kho (*)</th>
                                    <th>Địa chỉ kho nhập</th>
                                    <th>Hàng hóa giữ hộ/bán hộ</th>
                                    <th>TK Nợ (*)</th>
                                    <th>TK Có (*)</th>
                                    <th>ĐVT</th>
                                    <th>Số lượng</th>
                                    <th>Đơn giá bán</th>
                                    <th>Thành tiền</th>
                                    <th>Đơn giá vốn</th>
                                    <th>Tiền vốn</th>
                                    <th>Số lô</th>
                                    <th>Hạn sử dụng</th>
                                    <th>Mã thống kê</th>
                                </tr>
                            </thead>
                            <tbody id="results-body-xuat-yeu-cau">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>